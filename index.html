<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DIARY_SYSTEM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root { 
    --primary: #bb86fc; 
    --bg: #0d0d0d; 
    --surface: #1a1a1a; 
    --on-surface: #e0e0e0; 
    --border: rgba(255, 255, 255, 0.1); 
    --text-sub: #888; 
    --padding-dynamic: 20px;
    --wave-color: var(--primary);
  }

  [data-theme="light"] { 
  --primary: #6200ee; 
  --bg: #ffffff; 
  --surface: #f0f0f0; 
  --on-surface: #000000; 
  --border: rgba(0, 0, 0, 0.2); 
  --text-sub: #333;
}

  #moon-phase { 
  width: 60px; height: 60px; border-radius: 50%; background: #222; 
  position: relative; overflow: hidden; box-shadow: 0 0 15px rgba(187,134,252,0.2);
}
.moon-light { 
  position: absolute; height: 100%; background: #fffde7; 
  transition: all 0.5s ease; box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
}

  /* ãƒ­ãƒ¼ãƒ€ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã®è¦–èªæ€§å‘ä¸Š */
  #loaderText {
    margin-top: 25px;
    font-size: 0.8rem;
    letter-spacing: 5px;
    font-weight: 900;
    color: var(--primary); /* ãƒ†ãƒ¼ãƒå¤‰æ•°ã«ä¾å­˜ã•ã›ãšãƒ—ãƒ©ã‚¤ãƒãƒªã§å›ºå®š */
    text-shadow: 0 0 10px rgba(0,0,0,0.5);
  }

  body { 
    font-family: 'BIZ UDPGothic', sans-serif; 
    margin: 0; 
    background: var(--bg); 
    color: var(--on-surface); 
    transition: background 1.0s ease, color 0.4s ease; 
    line-height: 1.8; 
    letter-spacing: 0.05em;
    overflow-x: hidden; 
  }

  /* æ„Ÿæƒ…ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆè¿½åŠ ï¼‰ */
  #emotion-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: -2; opacity: 0.3; transition: background 2s;
    pointer-events: none;
  }

  #app-title {
    font-family: 'BIZ UDPGothic', sans-serif;
    font-weight: 700;
    letter-spacing: 0.4em;
    text-transform: uppercase;
    text-align: center;
    margin: 20px 0;
    color: var(--on-surface);
  }

  /* è«–ç†ã®æ³¢å½¢ãƒ­ãƒ¼ãƒ€ãƒ¼ï¼ˆè¿½åŠ ï¼‰ */
  #globalLoader { 
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.9); z-index: 9000; justify-content: center; align-items: center; 
    backdrop-filter: blur(15px); flex-direction: column; 
  }
  .wave-svg { width: 280px; height: 100px; }
  .wave-path { fill: none; stroke: var(--wave-color); stroke-width: 3; transition: stroke 0.5s; }

  /* ã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆæ—¢å­˜ç¶­æŒï¼‰ */
  #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: var(--bg); }
  .container { max-width: 900px; margin: 0 auto; padding: 0 20px 60px; position: relative; z-index: 10; }
  .header { display: flex; justify-content: space-between; align-items: center; padding: 30px 0; }
  .header-btns { display: flex; align-items: center; gap: 15px; }
  
  .tab-bar { 
    display: flex; background: var(--surface); border-radius: 50px; margin-bottom: 25px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 5px; border: 1px solid var(--border);
  }
  .tab { 
    flex: 1; text-align: center; padding: 14px; cursor: pointer; font-size: 0.9rem; 
    color: var(--text-sub); font-weight: bold; border-radius: 50px; transition: var(--transition);
  }
  .tab.active { color: #fff; background: var(--primary); box-shadow: 0 5px 15px rgba(187,134,252,0.4); }
  [data-theme="light"] .tab.active { color: #ffffff; }

  /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆæ—¢å­˜ç¶­æŒï¼‰ */
  .card { 
    background: var(--surface); padding: 25px; border-radius: 24px; 
    box-shadow: 0 15px 35px rgba(0,0,0,0.2); position: relative; overflow: hidden; 
    margin-bottom: 20px; border: 1px solid var(--border); backdrop-filter: blur(10px);
    animation: cardSlideUp 0.6s ease-out;
  }
  @keyframes cardSlideUp { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } }

  label { display: block; font-size: 0.75rem; font-weight: bold; margin-bottom: 8px; color: var(--primary); letter-spacing: 1px; }
  input, select, textarea, button { 
    width: 100%; padding: 14px; font-size: 1rem; border-radius: 12px; border: 1px solid var(--border); 
    background: rgba(128,128,128,0.05); color: var(--on-surface); box-sizing: border-box; 
    margin-bottom: 18px; outline: none; transition: var(--transition);
  }

  /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼ˆãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚¹ãƒšãƒ¼ã‚·ãƒ³ã‚°é©ç”¨ï¼‰ */
  #diary {
    padding: var(--padding-dynamic);
    transition: padding 0.3s ease, border-color 0.4s;
    line-height: 1.8;
  }
  
  /* ãƒœã‚¿ãƒ³ï¼ˆã‚·ã‚¹ãƒ†ãƒ çš„ãªæ¼”å‡ºï¼‰ */
  .btn { 
    background: var(--primary); 
    color: #000; 
    font-weight: 700; 
    border: none; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .btn:hover { transform: translateY(-1px); filter: brightness(1.1); box-shadow: 0 5px 15px rgba(187,134,252,0.3); }
  .btn:active { transform: scale(0.99); }

  /* çµ±è¨ˆãƒ»ã‚°ãƒ©ãƒ•ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ç¶­æŒï¼‰ */
  .streak-badge { background: var(--streak-bg); color: var(--streak-text); padding: 10px 20px; border-radius: 50px; display: inline-flex; align-items: center; gap: 10px; font-weight: bold; font-size: 0.85rem; margin-bottom: 20px; border: 1px solid var(--border); }
  .pie-container { display: flex; flex-direction: column; align-items: center; margin: 25px 0; }
  .pie-svg { width: 130px; height: 130px; transform: rotate(-90deg); }
  .pie-bg { fill: none; stroke: var(--border); stroke-width: 8; }
  .pie-val { fill: none; stroke: var(--primary); stroke-width: 8; stroke-linecap: round; transition: stroke-dasharray 1.2s ease; }
  .pie-text { text-align: center; margin-top: -75px; font-weight: bold; font-size: 1.2rem; margin-bottom: 55px; }

  .chart-wrapper { position: relative; padding-left: 40px; margin-bottom: 40px; margin-top: 15px; }
  .y-axis { position: absolute; left: 0; top: 0; bottom: 0; width: 40px; display: flex; flex-direction: column; justify-content: space-between; font-size: 0.65rem; color: var(--text-sub); text-align: right; padding-right: 8px; box-sizing: border-box; border-right: 1px solid var(--border); }
  .bar-frame { height: 120px; display: flex; align-items: flex-end; border-bottom: 2px solid var(--border); gap: 4px; position: relative; }
  .bar { flex: 1; background: var(--primary); border-radius: 4px 4px 0 0; position: relative; transition: height 1s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
  .bar-tick { position: absolute; bottom: -25px; font-size: 0.55rem; color: var(--text-sub); transform: translateX(-50%); left: 50%; white-space: nowrap; }

  /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãã®ä»–ï¼ˆæ—¢å­˜ç¶­æŒï¼‰ */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 8000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
  .modal-card { background: var(--surface); padding: 30px; border-radius: 28px; width: 90%; max-width: 420px; border: 1px solid var(--border); }
  .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
  .cal-day { aspect-ratio: 1; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; background: var(--border); cursor: pointer; transition: 0.2s; }
  .cal-day.has-data { background: var(--primary); color: #000; font-weight: bold; }
  .tooltip { position: fixed; background: #333; color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; pointer-events: none; opacity: 0; z-index: 9500; }
  /* å¹´é–“ç›®æ¨™ã‚’æœ€ä¸Šéƒ¨ã«å›ºå®šã™ã‚‹è¨­å®š */
#yearlyGoalContainer {
  position: sticky;
  top: 0;
  z-index: 1000;
  background: var(--surface);
  border-bottom: 2px solid var(--primary);
  padding: 12px;
  text-align: center;
  margin-bottom: 20px;
  backdrop-filter: blur(10px);
}

/* ç”»åƒè¡¨ç¤ºã‚µã‚¤ã‚ºã‚’é©æ­£åŒ– */
#imagePreview, #viewImage { 
  max-width: 100%; 
  max-height: 300px; 
  object-fit: contain; 
  border-radius: 12px;
  margin-top: 10px;
}

/* æœªè¨­å®šæ™‚ã®è­¦å‘Šã‚¹ã‚¿ã‚¤ãƒ« */
.goal-warning {
  color: #ff5252;
  font-weight: bold;
  animation: blink 1.5s infinite;
}
@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
  </style>
</head>
<body data-theme="dark">

<div id="emotion-overlay"></div>
<canvas id="bg-canvas"></canvas>

<div id="globalLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9000; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(10px); background: var(--bg); opacity: 0.98;">  <svg class="wave-svg" viewBox="0 0 200 60">
    <path id="logicWave" class="wave-path" d="M 0 30 Q 50 30 100 30 T 200 30" />
  </svg>
  <div id="loaderText" style="margin-top: 20px; font-weight: bold; color: var(--on-surface); letter-spacing: 2px;">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="chartTooltip" class="tooltip"></div>

<div class="container">
  <div class="header">
    <h1 id="app-title">DIARY</h1>
    <div id="yearlyGoalContainer">
  <div id="yearlyGoalText" style="font-size: 0.9rem; font-weight: bold;">
    <span class="goal-warning">ã€é‡è¦ã€‘å¹´é–“ç›®æ¨™ãŒæœªè¨­å®šã§ã™ã€‚è¨­å®šã—ã¦ãã ã•ã„ã€‚</span>
  </div>
</div>
    <div class="header-btns">
      <div id="moon-phase" style="width: 55px; height: 55px; border-radius: 50%; background: #333; position: relative; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.2);">
        <div class="moon-light" id="moon-light-layer" style="position: absolute; height: 100%; background: #fffde7; transition: 0.5s;"></div>
      </div>
      <button onclick="showRandomMemory()" style="border:none; background:none; cursor:pointer; font-size:1.3rem;">ğŸ’¡</button>
      <button onclick="toggleTheme()" style="border:none; background:none; cursor:pointer; font-size:1.3rem;">ğŸŒ“</button>
      <button onclick="openSettings()" style="border:none; background:none; cursor:pointer; font-size:1.3rem;">âš™ï¸</button>
    </div>
  </div>

  <div class="tab-bar">
    <div class="tab active" id="tab-edit" onclick="showTab('edit')">è¨˜éŒ²</div>
    <div class="tab" id="tab-stats" onclick="showTab('stats')">çµ±è¨ˆ</div>
    <div class="tab" id="tab-view" onclick="showTab('view')">å±¥æ­´</div>
  </div>

  <div id="edit" class="content-section" style="display:block;">
    <div id="memoryBox" class="memory-box" onclick="this.style.display='none'"></div>
    
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div class="streak-badge">
        <span>ç¶™ç¶šè¨˜éŒ²: <span id="streakCount">0</span> æ—¥</span>
      </div>
      <div id="monthlyReviewBtn" style="display:none;">
        <button class="btn" style="padding:8px 16px; font-size:0.75rem; width:auto; background:var(--streak-bg); color:var(--primary);" onclick="openMonthlyReview()">ä»Šæœˆã®æŒ¯ã‚Šè¿”ã‚Š</button>
      </div>
    </div>

    <div id="monthlyGoalDisplay" class="card" style="padding:15px; margin-bottom:20px; text-align:center;">
      <label style="margin-bottom:2px; font-size:0.7rem; color:var(--text-sub);">ä»Šæœˆã®ç›®æ¨™</label>
      <div id="goalText" style="font-weight:bold;">æœªè¨­å®š</div>
    </div>

    <div class="card">
      <label>æ—¥ä»˜</label>
      <input type="date" id="date" onchange="autoLoadEntry()">
      
      <div style="display:flex; gap:12px;">
        <div style="flex:1">
          <label>æ°—åˆ†</label>
          <select id="emotion" onchange="applyEmotionColor(this.value)">
            <option value="normal">é€šå¸¸</option>
            <option value="high">æœ€é«˜</option>
            <option value="tired">ç–²ã‚Œ</option>
            <option value="angry">æ€’ã‚Š</option>
            <option value="sad">æ‚²ã—ã¿</option>
            <option value="fuzzy">å›°æƒ‘</option>
          </select>
        </div>
        <div style="flex:1">
          <label>å­¦ç¿’æ™‚é–“ (åˆ†)</label>
          <input type="number" id="studyTime" value="0" readonly>
        </div>
        <div style="flex:0.8">
          <label>è¿½åŠ  (åˆ†)</label>
          <input type="number" id="addStudyTime" value="0">
        </div>
      </div>

      <label>æœ¬æ–‡</label>
      <textarea id="diary" rows="10" placeholder="ä»Šæ—¥ã®å‡ºæ¥äº‹ã‚’æ›¸ãã¾ã—ã‚‡ã†..."></textarea>
      
      <label>ç”»åƒ</label>
      <input type="file" id="imgInput" accept="image/*" onchange="handleImage(this)">
      <div id="imagePreviewContainer" style="display:none; margin-bottom:20px;">
        <img id="imagePreview" style="width:100%; border-radius:12px;">
      </div>
      
      <button class="btn" onclick="checkOverwrite()" id="saveBtn">ä¿å­˜</button>
    </div>
  </div>

  <div id="stats" class="content-section" style="display:none">
    <div class="card">
      <div style="display:flex; gap:10px; margin-bottom:25px;">
        <select id="statYear" onchange="refreshStats()"></select>
        <select id="statMonth" onchange="refreshStats()"></select>
      </div>
      
      <label style="text-align:center;">ç›®æ¨™é”æˆç‡</label>
      <div class="pie-container">
        <svg class="pie-svg" viewBox="0 0 100 100">
          <circle class="pie-bg" cx="50" cy="50" r="40"></circle>
          <circle id="pieFill" class="pie-val" cx="50" cy="50" r="40" stroke-dasharray="0 251.2"></circle>
        </svg>
        <div id="pieLabel" class="pie-text">0%</div>
      </div>
      <p id="progressSub" style="font-size:0.75rem; color:var(--text-sub); text-align:center; margin-bottom:30px;"></p>

      <label>æ—¥åˆ¥å­¦ç¿’æ™‚é–“</label>
      <div class="chart-wrapper">
        <div id="yAxisDaily" class="y-axis"></div>
        <div id="dailyChart" class="bar-frame"></div>
      </div>

      <label style="margin-top:25px;">æœˆåˆ¥å­¦ç¿’æ¨ç§»</label>
      <div class="chart-wrapper">
        <div id="yAxisMonthly" class="y-axis"></div>
        <div id="monthlyChart" class="bar-frame"></div>
      </div>
    </div>
  </div>

  <div id="view" class="content-section" style="display:none">
    <div class="card">
      <div style="display:flex; justify-content: space-between; margin-bottom:20px;">
        <div style="display:flex; gap:10px;">
          <select id="viewYear" onchange="loadList()"></select>
          <select id="viewMonth" onchange="loadList()"></select>
        </div>
        <button onclick="toggleViewMode()" id="viewModeBtn" class="btn" style="width:auto; padding:5px 15px; font-size:0.8rem;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º</button>
      </div>
      <div id="diaryList"></div>
      <div id="calendarView" class="cal-grid" style="display:none;"></div>
    </div>
    
    <div id="viewerCard" class="card" style="display:none; border:2px solid var(--primary);">
      <div id="viewMeta" style="font-size:0.85rem; color:var(--primary); margin-bottom:12px; font-weight:bold;"></div>
      <div id="viewBody" style="white-space:pre-wrap; margin-bottom:20px; line-height:1.8;"></div>
      <div id="viewImageContainer" style="display:none; margin-bottom:20px;"><img id="viewImage" style="width:100%; border-radius:12px;"></div>
      <div style="display:flex; gap:12px;">
        <button class="btn" style="background:#666; color:#fff; flex:1;" onclick="document.getElementById('viewerCard').style.display='none'">é–‰ã˜ã‚‹</button>
        <button class="btn" style="background:#cf6679; color:#fff; flex:1;" id="deleteBtn">å‰Šé™¤</button>
      </div>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal-overlay">
  <div class="modal-card">
    <h3 style="margin:0 0 20px; font-size:1.1rem; color:var(--primary);">è¨­å®š</h3>
    <label>ä»Šæœˆã®ç›®æ¨™ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
    <textarea id="goalTextPrompt" rows="2" placeholder="ä¾‹ï¼šæ¯æ—¥1æ™‚é–“å‹‰å¼·ã™ã‚‹"></textarea>
    <label>å¹´é–“ç›®æ¨™ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
<textarea id="goalYearlyPrompt" rows="2" placeholder="ä¾‹ï¼šä»Šå¹´ã¯ã€‡ã€‡ã‚’ç¿’å¾—ã™ã‚‹"></textarea>
<button class="btn" onclick="saveYearlyGoal()">å¹´é–“ç›®æ¨™ã‚’ä¿å­˜</button>
    <button class="btn" id="goalLockBtnText" onclick="saveGeneralGoal()">ç›®æ¨™ã‚’ä¿å­˜</button>
    <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
    <label>ç›®æ¨™å­¦ç¿’æ™‚é–“ (åˆè¨ˆåˆ†)</label>
    <div id="goalReference" style="font-size:0.7rem; background:rgba(0,0,0,0.05); padding:10px; border-radius:8px; margin-bottom:10px;">
      <div id="lastWeekTotal">ç›´è¿‘7æ—¥é–“: --åˆ†</div>
      <div id="dailyGoalEst">1æ—¥ã®ç›®å®‰: --åˆ†</div>
    </div>
    <input type="number" id="goalTimeInput" oninput="calcDailyEst(this.value)">
    <button class="btn" id="goalLockBtn" onclick="saveGoal()">æ•°å€¤ã‚’ä¿å­˜</button>
    <button class="btn" style="background:none; color:var(--text-sub); margin-top:10px;" onclick="closeSettings()">æˆ»ã‚‹</button>
  </div>
</div>

<div id="monthlyReviewModal" class="modal-overlay">
  <div class="modal-card">
    <h3 style="margin:0 0 15px; color:var(--primary);">ä»Šæœˆã®ã¾ã¨ã‚</h3>
    <p id="reviewStats" style="font-size:0.85rem; margin-bottom:15px;"></p>
    <label>æŒ¯ã‚Šè¿”ã‚Šã‚³ãƒ¡ãƒ³ãƒˆ</label>
    <textarea id="monthlySummary" rows="3"></textarea>
    <button class="btn" onclick="saveMonthlyReview()">æŒ¯ã‚Šè¿”ã‚Šã‚’è¨˜éŒ²</button>
    <button class="btn" style="background:none; color:var(--text-sub);" onclick="document.getElementById('monthlyReviewModal').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<div id="customAlert" class="modal-overlay">
  <div class="modal-card" style="text-align:center;">
    <p id="alertMsg" style="font-weight:bold;"></p>
    <div id="alertBtns" style="display:flex; gap:10px; margin-top:20px; justify-content:center;"></div>
  </div>
</div>

<script>

/**
 * æœˆé½¢ã®æç”»ã¨ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸè¦–è¦šèª¿æ•´
 */
function updateMoonAndMode() {
  const now = new Date();
  const day = now.getDate();
  const moonLayer = document.getElementById('moon-light-layer');
  if (!moonLayer) return;

  const phase = (day % 30) / 30; 
  if (phase <= 0.5) {
    const p = phase * 2;
    moonLayer.style.left = (100 - p * 100) + "%";
    moonLayer.style.width = (p * 100) + "%";
    moonLayer.style.borderRadius = "0 50% 50% 0";
  } else {
    const p = (phase - 0.5) * 2;
    moonLayer.style.left = "0%";
    moonLayer.style.width = (100 - p * 100) + "%";
    moonLayer.style.borderRadius = "50% 0 0 50%";
  }
}

/* --- 1. èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (å®Œå…¨ç¶­æŒ) --- */
const canvas = document.getElementById('bg-canvas');
const ctx = canvas.getContext('2d');
let particles = [];
let mouse = { x: null, y: null, radius: 150 };
window.addEventListener('mousemove', e => { mouse.x = e.x; mouse.y = e.y; });
window.addEventListener('touchstart', e => { mouse.x = e.touches[0].clientX; mouse.y = e.touches[0].clientY; });
class Particle {
  constructor() { this.init(); }
  init() {
    this.x = Math.random() * canvas.width;
    this.y = Math.random() * canvas.height;
    this.size = Math.random() * 2 + 0.5;
    this.baseX = this.x; this.baseY = this.y;
    this.density = (Math.random() * 40) + 5;
    this.color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
  }
  draw() {
    ctx.fillStyle = this.color;
    ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
  }
  update() {
    let dx = mouse.x - this.x; let dy = mouse.y - this.y;
    let distance = Math.sqrt(dx*dx + dy*dy);
    if (distance < mouse.radius) {
      let force = (mouse.radius - distance) / mouse.radius;
      this.x -= (dx / distance) * force * this.density;
      this.y -= (dy / distance) * force * this.density;
    } else {
      this.x += (this.baseX - this.x) * 0.05;
      this.y += (this.baseY - this.y) * 0.05;
    }
  }
}
function initBg() {
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  particles = [];
  let count = (canvas.width * canvas.height) / 10000;
  for (let i = 0; i < count; i++) particles.push(new Particle());
}
function animateBg() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  particles.forEach(p => { p.update(); p.draw(); });
  requestAnimationFrame(animateBg);
}
window.addEventListener('resize', initBg);
initBg(); animateBg();

/* --- 2. æŒ‡ç¤ºã«ã‚ˆã‚‹è¿½åŠ ï¼šè«–ç†ã®æ³¢å½¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡ --- */
let waveFrame = 0;
let waveMode = 'read'; 
let charWeight = 0;

function animateWave() {
  const path = document.getElementById('logicWave');
  if (!path) return;
  waveFrame++;
  let d = "";
  if (waveMode === 'read') {
    let points = [];
    for (let x = 0; x <= 200; x += 5) {
      let y = 30 + Math.sin((x + waveFrame * 5) * 0.05) * 10;
      points.push(`${x} ${y}`);
    }
    d = `M ${points.join(' L ')}`;
  } else {
    // ãƒ‘ãƒ«ã‚¹æ³¢ã®ä¿®æ­£ï¼šä¸­å¤®ã ã‘ã§ãªãå…¨ä½“ãŒæ¸›è¡°ã—ãªãŒã‚‰æ³¢æ‰“ã¤ã‚ˆã†ã«å¤‰æ›´
    let points = [];
    let amp = Math.min(25, 5 + (charWeight / 50));
    for (let x = 0; x <= 200; x += 2) {
      // ä¸­å¤®(x=100)ã§æœ€å¤§ã€ç«¯ã«ã„ãã»ã©å°ã•ããªã‚‹ã‚¬ã‚¦ã‚¹åˆ†å¸ƒçš„ãªæºã‚Œ
      let dist = Math.abs(x - 100);
      let factor = Math.exp(-Math.pow(dist / 40, 2)); 
      let y = 30 + Math.sin((x * 0.2) + (waveFrame * 0.3)) * amp * factor;
      points.push(`${x} ${y}`);
    }
    d = `M ${points.join(' L ')}`;
  }
  path.setAttribute('d', d);
  if (document.getElementById('globalLoader').style.display === 'flex') requestAnimationFrame(animateWave);
}

/* çµ±åˆãƒ­ãƒ¼ãƒ€ãƒ¼é–¢æ•°ï¼ˆæ—¢å­˜ã®toggleLoaderã‚’æ‹¡å¼µï¼‰ */
function toggleLoader(show, mode = 'read', weight = 0, text = "SYNCING...") {
  const loader = document.getElementById("globalLoader");
  document.getElementById("loaderText").textContent = text;
  waveMode = mode;
  charWeight = weight;
  loader.style.display = show ? "flex" : "none";
  if (show) animateWave();
}

/* --- 3. æŒ‡ç¤ºã«ã‚ˆã‚‹è¿½åŠ ï¼šè‡ªç„¶ã®ãƒªã‚ºãƒ  (æœˆãƒ»æ„Ÿæƒ…ãƒ»æ™‚é–“) --- */
function applyEmotionColor(emotion) {
  const overlay = document.getElementById('emotion-overlay');
  const colors = {
    normal: 'transparent',
    high: 'rgba(255, 215, 0, 0.2)',
    tired: 'rgba(72, 61, 139, 0.3)',
    angry: 'rgba(220, 20, 60, 0.2)',
    sad: 'rgba(30, 144, 255, 0.2)',
    fuzzy: 'rgba(128, 0, 128, 0.2)'
  };
  overlay.style.background = colors[emotion] || 'transparent';
}

/* --- 4. ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ (å…¨æ©Ÿèƒ½ç¶­æŒ + æŒ‡ç¤ºãƒãƒ¼ã‚¸) --- */
let currentDataList = [];
let selectedImageData = null;
let viewMode = 'list';
let hasPromptedMonthlyReview = false;
let hasPromptedGoal = false;

function showTab(t) {
  const currentGoal = localStorage.getItem(`goal_text_${new Date().getFullYear()}_${new Date().getMonth() + 1}`);
  if (!currentGoal && !hasPromptedGoal && t !== 'edit') {
    hasPromptedGoal = true;
    showAlert("ä»Šæœˆã®ç›®æ¨™ãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šã—ã¾ã™ã‹ï¼Ÿ", "confirm", openSettings);
    return;
  }
  const now = new Date();
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  if (now.getDate() >= lastDay - 2 && !hasPromptedMonthlyReview && t !== 'edit') {
    hasPromptedMonthlyReview = true;
    showAlert("æœˆæœ«ã«ãªã‚Šã¾ã—ãŸã€‚ä»Šæœˆã®ç·æ‹¬ã‚’è¨˜å…¥ã—ã¾ã›ã‚“ã‹ï¼Ÿ", "confirm", openMonthlyReview);
    return;
  }
  document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  document.getElementById(t).style.display = 'block';
  document.getElementById('tab-' + t).classList.add('active');
  if(t === 'stats') refreshStats();
  if(t === 'view') loadList();
}

function toggleTheme() {
  const b = document.body;
  b.setAttribute("data-theme", b.getAttribute("data-theme") === "dark" ? "light" : "dark");
  particles.forEach(p => p.init());
}

function refreshStats() {
  const y = document.getElementById("statYear").value;
  const m = document.getElementById("statMonth").value;
  toggleLoader(true, 'read', 0, "ANALYZING...");
  google.script.run.withSuccessHandler(res => {
    toggleLoader(false);
    if(!res) return;
    const goal = localStorage.getItem(`goal_${y}_${m}`) || 0;
    const total = res.daily.reduce((a, b) => a + (b.time || 0), 0);
    const percent = goal > 0 ? Math.min(Math.round((total / goal) * 100), 100) : 0;
    document.getElementById("pieFill").setAttribute("stroke-dasharray", `${(percent / 100) * 251.2} 251.2`);
    document.getElementById("pieLabel").textContent = `${percent}%`;
    document.getElementById("progressSub").textContent = goal > 0 ? `åˆè¨ˆ: ${total}åˆ† / ç›®æ¨™: ${goal}åˆ†` : "ç›®æ¨™æœªè¨­å®š";
    drawChart("dailyChart", "yAxisDaily", res.daily.map(d => ({ label: d.day, val: d.time })), 5);
    drawChart("monthlyChart", "yAxisMonthly", res.monthly.map(m => ({ label: m.month, val: m.time })), 1);
  }).getDetailedStudyStats(y, m);
}

function drawChart(chartId, axisId, data, step) {
  const frame = document.getElementById(chartId);
  const axis = document.getElementById(axisId);
  frame.innerHTML = ""; axis.innerHTML = "";
  const vals = data.map(d => d.val || 0);
  const max = Math.max(...vals, 60);
  for(let i=4; i>=0; i--) {
    const d = document.createElement("div"); d.textContent = Math.round(max * (i/4)); axis.appendChild(d);
  }
  data.forEach((d, i) => {
    const bar = document.createElement("div");
    bar.className = "bar"; bar.style.height = `${(d.val / max) * 100}%`;
    bar.onmouseenter = (e) => showTooltip(e, `${d.label}: ${d.val}åˆ†`);
    bar.onmouseleave = hideTooltip;
    if ((i + 1) % step === 0 || i === 0 || i === data.length - 1) {
      const t = document.createElement("div"); t.className = "bar-tick"; t.textContent = d.label; bar.appendChild(t);
    }
    frame.appendChild(bar);
  });
}

/* æŒ‡ç¤ºè¿½åŠ ï¼šãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ»ã‚¹ãƒšãƒ¼ã‚·ãƒ³ã‚°ã®ãƒªã‚¹ãƒŠãƒ¼ */
document.getElementById("diary").addEventListener("input", (e) => {
  const charCount = e.target.value.length;
  const newPadding = Math.max(10, 20 - (charCount / 100));
  document.documentElement.style.setProperty('--padding-dynamic', `${newPadding}px`);
});

function showRandomMemory() {
  const now = new Date();
  google.script.run.withSuccessHandler((list) => {
    // è¿½åŠ ï¼šæœªè¨˜éŒ²æ™‚ã®ã‚¬ãƒ¼ãƒ‰
    if (!list || list.length === 0) {
      showAlert("ã¾ã ä½•ã‚‚è¨˜éŒ²ã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚å±¥æ­´ã‚’è“„ç©ã—ã¦ãã ã•ã„ã€‚", "info");
      return;
    }
    
    // ä»¥ä¸‹ã€æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶­æŒ
    const target = list[Math.floor(Math.random() * list.length)];
    const dateParts = target.name.split("-");
    google.script.run.withSuccessHandler((data) => {
      if (!data) return;
      const box = document.getElementById("memoryBox");
      box.innerHTML = `<div style="font-size:0.7rem; color:var(--primary); margin-bottom:8px;">PAST_LOG: ${target.name}</div>${data.content.substring(0, 100)}...`;
      box.style.display = "block";
      setTimeout(() => { box.style.display = "none"; }, 8000);
    }).getDiaryContent(dateParts[0], dateParts[1], target.name);
  }).getDiaryList(now.getFullYear(), now.getMonth() + 1);
}

function openMonthlyReview() {
  const y = new Date().getFullYear(); const m = new Date().getMonth() + 1;
  google.script.run.withSuccessHandler(res => {
    if(!res) return;
    const total = res.daily.reduce((a, b) => a + (b.time || 0), 0);
    document.getElementById("reviewStats").textContent = `${m}æœˆã®å­¦ç¿’åˆè¨ˆã¯ ${total} åˆ†ã§ã—ãŸã€‚`;
    document.getElementById("monthlyReviewModal").style.display = "flex";
  }).getDetailedStudyStats(y, m);
}

function saveMonthlyReview() {
  const summary = document.getElementById("monthlySummary").value;
  if(!summary) return;
  document.getElementById("diary").value = `ã€ä»Šæœˆã®ç·æ‹¬ã€‘\n${summary}\n\n---\n${document.getElementById("diary").value}`;
  document.getElementById("monthlyReviewModal").style.display = "none";
  showTab('edit');
  showAlert("æ—¥è¨˜æ¬„ã«ç·æ‹¬ã‚’æŒ¿å…¥ã—ã¾ã—ãŸã€‚", "info");
}

function openSettings() {
  const modal = document.getElementById("settingsModal");
  modal.style.display = "flex";
  
  const now = new Date();
  // è¿½åŠ ï¼šå…ˆæœˆã®è¨ˆç®—
  const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const lmYear = lastMonthDate.getFullYear();
  const lmMonth = lastMonthDate.getMonth() + 1;

  // æ—¢å­˜ã®çµ±è¨ˆå–å¾—é–¢æ•°ã‚’åˆ©ç”¨ã—ã€å‚ç…§ç¯„å›²ã‚’å…ˆæœˆã«å¤‰æ›´
  google.script.run.withSuccessHandler((stats) => {
    if (stats && stats.monthly) {
      const lastMonthData = stats.monthly.find(m => m.month === lmMonth);
      const total = lastMonthData ? lastMonthData.time : 0;
      
      // æ—¢å­˜ã®IDã€ŒlastWeekTotalã€ã‚’æµç”¨ã—ã¦è¡¨ç¤º
      document.getElementById("lastWeekTotal").textContent = `å…ˆæœˆ(${lmMonth}æœˆ)ã®åˆè¨ˆ: ${total} åˆ†`;
      
      // æ—¥æ¬¡ç›®å®‰ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ—¢å­˜ç¶­æŒï¼‰
      const daysInMonth = new Date(lmYear, lmMonth, 0).getDate();
      document.getElementById("dailyGoalEst").textContent = `1æ—¥ã®ç›®æ¨™ç›®å®‰: ${Math.floor(total / daysInMonth)} åˆ†`;
    }
  }).getDetailedStudyStats(lmYear, lmMonth);
}

function closeSettings() { document.getElementById("settingsModal").style.display = "none"; }
function saveGoal() {
  localStorage.setItem(`goal_${new Date().getFullYear()}_${new Date().getMonth() + 1}`, document.getElementById("goalTimeInput").value);
  closeSettings(); refreshStats();
}
function saveGeneralGoal() {
  localStorage.setItem(`goal_text_${new Date().getFullYear()}_${new Date().getMonth() + 1}`, document.getElementById("goalTextPrompt").value);
  updateGoalDisplay(); closeSettings();
}
function updateGoalDisplay() {
  const saved = localStorage.getItem(`goal_text_${new Date().getFullYear()}_${new Date().getMonth() + 1}`);
  document.getElementById("goalText").textContent = saved || "æœªè¨­å®š (âš™ï¸ã‚ˆã‚Šè¨­å®š)";
}
function calcDailyEst(val) {
  const days = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
  document.getElementById("dailyGoalEst").textContent = `1æ—¥ã‚ãŸã‚Šç›®å®‰: ${val ? Math.round(val / days) : 0}åˆ†`;
}
function fetchLastWeekStats() {
  google.script.run.withSuccessHandler(res => {
    if(!res) return;
    const total = res.daily.slice(-7).reduce((a, b) => a + (b.time || 0), 0);
    document.getElementById("lastWeekTotal").textContent = `å…ˆé€±: ${total}åˆ†`;
  }).getDetailedStudyStats(new Date().getFullYear(), new Date().getMonth() + 1);
}

function handleImage(input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        const maxSide = 1024; // ãƒªã‚µã‚¤ã‚ºã®ä¸Šé™
        
        if (width > maxSide || height > maxSide) {
          if (width > height) {
            height *= maxSide / width;
            width = maxSide;
          } else {
            width *= maxSide / height;
            height = maxSide;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // åœ§ç¸®ã•ã‚ŒãŸBase64ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const resizedData = canvas.toDataURL('image/jpeg', 0.8);
        document.getElementById('imagePreview').src = resizedData;
        document.getElementById('imagePreviewContainer').style.display = 'block';
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
}

function autoLoadEntry() {
  const dateVal = document.getElementById("date").value;
  if (!dateVal) return;
  const dateParts = dateVal.split("-");

  // å¹´é–“ç›®æ¨™ã®å–å¾—ã¨è¡¨ç¤ºæ›´æ–°
  google.script.run.withSuccessHandler((goal) => {
    const display = document.getElementById("yearlyGoalText");
    if (goal && goal.content) {
      display.innerHTML = `<span style="color:var(--primary);">ã€2025å¹´ç›®æ¨™ã€‘</span> ${goal.content}`;
      display.classList.remove("goal-warning");
    } else {
      display.innerHTML = `<span class="goal-warning">ã€é‡è¦ã€‘å¹´é–“ç›®æ¨™ãŒæœªè¨­å®šã§ã™ã€‚è¨­å®šã‹ã‚‰å„ªå…ˆçš„ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</span>`;
      display.classList.add("goal-warning");
    }
  }).getYearlyGoal();

  // æ—¢å­˜ã®æ—¥è¨˜èª­ã¿è¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯
  google.script.run.withSuccessHandler((data) => {
    const diary = document.getElementById("diary");
    const emotion = document.getElementById("emotion");
    const study = document.getElementById("studyTime");
    const preview = document.getElementById("imagePreview");
    const container = document.getElementById("imagePreviewContainer");
    
    if (data) {
      diary.value = data.content || "";
      emotion.value = data.emotion || "normal";
      study.value = data.studyTime || 0;
      if (data.image) {
        preview.src = data.image;
        container.style.display = "block";
      } else {
        container.style.display = "none";
      }
    } else {
      diary.value = "";
      emotion.value = "normal";
      study.value = 0;
      container.style.display = "none";
    }
  }).getDiaryContent(dateParts[0], parseInt(dateParts[1]), dateVal);
}

function calculateStreak() {
  google.script.run.withSuccessHandler(data => {
    if(!data || data.length === 0) { document.getElementById("streakCount").textContent = "0"; return; }
    const sorted = data.map(d => d.name).sort().reverse();
    const today = new Date(); today.setHours(0,0,0,0);
    let count = 0;
    let last = new Date(sorted[0]); last.setHours(0,0,0,0);
    if ((today - last) / 86400000 > 1) { document.getElementById("streakCount").textContent = "0"; return; }
    for(let i=0; i<sorted.length; i++){
      const d = new Date(sorted[i]); d.setHours(0,0,0,0);
      if(i===0) count=1; else {
        const prev = new Date(sorted[i-1]); prev.setHours(0,0,0,0);
        if((prev - d)/86400000 === 1) count++; else break;
      }
    }
    document.getElementById("streakCount").textContent = count.toString();
  }).getDiaryList(new Date().getFullYear(), new Date().getMonth()+1);
}

function loadList() {
  const y = document.getElementById("viewYear").value;
  const m = document.getElementById("viewMonth").value;
  toggleLoader(true, 'read', 0, "FETCHING...");
  google.script.run.withSuccessHandler(data => {
    currentDataList = data || [];
    if (viewMode === 'list') renderList(currentDataList); else renderCalendar(currentDataList, y, m);
    toggleLoader(false);
  }).getDiaryList(y, m);
}

function renderList(data) {
  const list = document.getElementById("diaryList");
  list.style.display = "block"; document.getElementById("calendarView").style.display = "none";
  list.innerHTML = data.length ? "" : "<div style='text-align:center;padding:40px;opacity:0.3;'>No Records</div>";
  data.forEach(d => {
    const div = document.createElement("div"); 
    div.style = "background:var(--surface); padding:15px; border-radius:15px; margin-bottom:12px; border-left:4px solid var(--primary); cursor:pointer;";
    div.innerHTML = `<strong>${d.name?.toString() || ''}</strong> <span style="font-size:0.75rem; opacity:0.6;">${d.emotion?.toString() || ''}</span><br><small style="opacity:0.7;">${d.preview?.toString() || ''}...</small>`;
    div.onclick = () => openViewer(d.name);
    list.appendChild(div);
  });
}

function renderCalendar(data, year, month) {
  const cal = document.getElementById("calendarView");
  cal.style.display = "grid"; document.getElementById("diaryList").style.display = "none";
  cal.innerHTML = "";
  const days = new Date(year, month, 0).getDate();
  for(let d=1; d<=days; d++){
    const ds = `${year}-${month.toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
    const item = data.find(x => x.name === ds);
    const div = document.createElement("div");
    div.className = "cal-day" + (item ? " has-data" : "");
    div.textContent = d;
    if(item) div.onclick = () => openViewer(ds);
    cal.appendChild(div);
  }
}

function toggleViewMode() {
  viewMode = viewMode === 'list' ? 'calendar' : 'list';
  document.getElementById("viewModeBtn").textContent = viewMode === 'list' ? 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼' : 'ãƒªã‚¹ãƒˆ';
  loadList();
}

function openViewer(name) {
  toggleLoader(true, 'read', 0, "READING...");
  const y = document.getElementById("viewYear").value;
  const m = document.getElementById("viewMonth").value;
  google.script.run.withSuccessHandler(json => {
    toggleLoader(false);
    if(!json) return;
    document.getElementById("viewerCard").style.display = "block";
    document.getElementById("viewMeta").textContent = `${json.date} / ${json.emotion} / ${json.studyTime}min`;
    document.getElementById("viewBody").textContent = json.content;
    const imgBox = document.getElementById("viewImageContainer");
    if(json.image) { imgBox.style.display="block"; document.getElementById("viewImage").src=json.image; } else imgBox.style.display="none";
    document.getElementById("deleteBtn").onclick = () => showAlert("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", "danger", () => {
      toggleLoader(true, 'read', 0, "DELETING...");
      google.script.run.withSuccessHandler(() => { toggleLoader(false); document.getElementById("viewerCard").style.display="none"; loadList(); }).deleteDiary(y, m, name);
    });
    window.scrollTo({top: document.getElementById("viewerCard").offsetTop - 20, behavior: 'smooth'});
  }).getDiaryContent(y, m, name);
}

function showTooltip(e, text) {
  const tt = document.getElementById("chartTooltip");
  tt.textContent = text; tt.style.opacity = 1;
  tt.style.left = (e.clientX + 10) + "px"; tt.style.top = (e.clientY - 30) + "px";
}
function hideTooltip() { document.getElementById("chartTooltip").style.opacity = 0; }

function showAlert(msg, type, onConfirm) {
  const modal = document.getElementById("customAlert"); const btns = document.getElementById("alertBtns");
  document.getElementById("alertMsg").textContent = msg; btns.innerHTML = "";
  if (type === 'info') {
    const b = document.createElement("button"); b.className="btn"; b.style.width="100px"; b.textContent="OK"; b.onclick=()=>modal.style.display="none";
    btns.appendChild(b);
  } else {
    const b1 = document.createElement("button"); b1.className="btn"; b1.style.background="#888"; b1.textContent="ã‚­ãƒ£ãƒ³ã‚»ãƒ«"; b1.onclick=()=>modal.style.display="none";
    const b2 = document.createElement("button"); b2.className="btn"; b2.style.background = (type === 'danger' ? '#cf6679' : 'var(--primary)'); b2.textContent = "å®Ÿè¡Œ"; b2.onclick=()=>{ modal.style.display="none"; if(onConfirm) onConfirm(); };
    btns.appendChild(b1); btns.appendChild(b2);
  }
  modal.style.display = "flex";
}

function checkOverwrite() {
  const dateVal = document.getElementById("date").value;
  if (!dateVal) return;

  // è¿½åŠ ï¼šæ—¥ä»˜åˆ¶é™ãƒ­ã‚¸ãƒƒã‚¯
  const targetDate = new Date(dateVal);
  targetDate.setHours(0, 0, 0, 0);
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const yesterday = new Date();
  yesterday.setDate(today.getDate() - 1);
  yesterday.setHours(0, 0, 0, 0);

  if (targetDate.getTime() !== today.getTime() && targetDate.getTime() !== yesterday.getTime()) {
    showAlert("åˆ¶é™ï¼šè¨˜éŒ²ã®ä½œæˆãƒ»ç·¨é›†ã¯ã€Œä»Šæ—¥ã€ã¾ãŸã¯ã€Œæ˜¨æ—¥ã€ã®æ—¥ä»˜ã®ã¿å¯èƒ½ã§ã™ã€‚", "info");
    return;
  }

  // ä»¥ä¸‹ã€æ—¢å­˜ã®é‡è¤‡ç¢ºèªãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶­æŒ
  const dateParts = dateVal.split("-");
  google.script.run.withSuccessHandler((exists) => {
    if (exists) {
      showAlert("æ—¢ã«ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ", "confirm", () => {
        executeSave();
      });
    } else {
      executeSave();
    }
  }).getDiaryContent(dateParts[0], parseInt(dateParts[1]), dateVal);
}

window.onload = () => {
  const now = new Date();
  document.getElementById("date").valueAsDate = now;
  const sy = document.getElementById("statYear"); const sm = document.getElementById("statMonth");
  const vy = document.getElementById("viewYear"); const vm = document.getElementById("viewMonth");
  for(let i=now.getFullYear(); i>=now.getFullYear()-2; i--){ sy.add(new Option(i,i)); vy.add(new Option(i,i)); }
  for(let i=1; i<=12; i++){ sm.add(new Option(i,i)); vm.add(new Option(i,i)); }
  sm.value = vm.value = now.getMonth() + 1;
  updateGoalDisplay(); 
  updateMoonAndMode();
  calculateStreak(); 
  autoLoadEntry();
};
</script>
</body>
</html>
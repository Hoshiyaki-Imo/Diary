<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Diary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root { 
      --primary: #bb86fc; 
      --primary-variant: #3700b3;
      --bg: #f5f5f5; 
      --surface: #ffffff; 
      --on-surface: #333; 
      --border: #eee; 
      --text-sub: #888; 
      --streak-bg: rgba(187, 134, 252, 0.1);
      --streak-text: #bb86fc;
    }
    [data-theme="dark"] { 
      --primary: #cfa6ff; 
      --bg: #121212; 
      --surface: #1e1e1e; 
      --on-surface: #e1e1e1; 
      --border: #333; 
      --text-sub: #aaa;
      --streak-bg: rgba(207, 166, 255, 0.15);
    }
    
    body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--on-surface); transition: 0.3s; line-height: 1.5; overflow-x: hidden; }
    .container { max-width: 900px; margin: 0 auto; padding: 0 20px 60px; position: relative; z-index: 10; }
    
    /* é›†ä¸­ãƒ¢ãƒ¼ãƒ‰èƒŒæ™¯ï¼šé™ã‹ãªç²’å­ã®å‹•ã */
    #bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; opacity: 0.4; }

    .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; }
    .header-btns { display: flex; align-items: center; gap: 10px; }
    
    .tab-bar { display: flex; background: var(--surface); border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .tab { flex: 1; text-align: center; padding: 14px; cursor: pointer; font-size: 0.9rem; color: var(--text-sub); font-weight: bold; border-bottom: 3px solid transparent; }
    .tab.active { color: var(--primary); background: rgba(187, 134, 252, 0.08); border-bottom: 3px solid var(--primary); }
    
    .card { background: var(--surface); padding: 24px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); position: relative; overflow: hidden; margin-bottom: 20px; border: 1px solid var(--border); }
    label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 8px; color: var(--primary); }
    input, select, textarea, button { width: 100%; padding: 12px; font-size: 1rem; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--on-surface); box-sizing: border-box; margin-bottom: 16px; outline: none; }
    
    .btn { background: var(--primary); color: #000; font-weight: bold; border: none; cursor: pointer; transition: 0.2s; }
    .btn:active { transform: scale(0.98); }
    .locked { opacity: 0.6; pointer-events: none; background: var(--border) !important; color: var(--text-sub) !important; }

    /* èŠ¸è¡“çš„ãªæ³¢å½¢ãƒ­ãƒ¼ãƒ€ãƒ¼ */
    #globalLoader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; backdrop-filter: blur(8px); flex-direction: column; color: #fff; }
    .wave-container { display: flex; align-items: center; gap: 4px; height: 60px; }
    .wave-bar { width: 4px; height: 20px; background: var(--primary); border-radius: 4px; animation: wave 1.2s infinite ease-in-out; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; }
    @keyframes wave { 0%, 100% { height: 20px; transform: scaleY(1); } 50% { height: 60px; transform: scaleY(1.5); opacity: 0.5; } }

    /* è½ã¡ç€ã„ãŸé€£ç¶šè¨˜éŒ²ãƒãƒƒã‚¸ */
    .streak-badge { background: var(--streak-bg); color: var(--streak-text); padding: 8px 16px; border-radius: 20px; display: inline-flex; align-items: center; gap: 8px; font-weight: bold; font-size: 0.85rem; margin-bottom: 15px; border: 1px solid rgba(187, 134, 252, 0.3); }

    /* æ€ã„å‡ºè¡¨ç¤º */
    .memory-box { display: none; background: rgba(187, 134, 252, 0.05); border: 1px dashed var(--primary); padding: 15px; border-radius: 16px; margin-bottom: 15px; font-size: 0.9rem; position: relative; animation: fadeIn 0.5s; }
    .memory-box small { color: var(--primary); font-weight: bold; display: block; margin-bottom: 4px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* å††ã‚°ãƒ©ãƒ• */
    .pie-container { display: flex; flex-direction: column; align-items: center; margin: 20px 0; }
    .pie-svg { width: 120px; height: 120px; transform: rotate(-90deg); }
    .pie-bg { fill: none; stroke: var(--border); stroke-width: 8; }
    .pie-val { fill: none; stroke: var(--primary); stroke-width: 8; stroke-linecap: round; transition: stroke-dasharray 1s ease; }
    .pie-text { text-align: center; margin-top: -70px; font-weight: bold; font-size: 1.1rem; margin-bottom: 50px; }

    /* ã‚°ãƒ©ãƒ• */
    .chart-wrapper { position: relative; padding-left: 35px; margin-bottom: 35px; margin-top: 10px; }
    .y-axis { position: absolute; left: 0; top: 0; bottom: 0; width: 35px; display: flex; flex-direction: column; justify-content: space-between; font-size: 0.6rem; color: var(--text-sub); text-align: right; padding-right: 5px; box-sizing: border-box; border-right: 1px solid var(--border); }
    .bar-frame { height: 100px; display: flex; align-items: flex-end; border-bottom: 2px solid var(--border); gap: 2px; position: relative; }
    .bar { flex: 1; background: var(--primary); border-radius: 2px 2px 0 0; position: relative; transition: 0.2s; }
    .bar:hover { filter: brightness(1.2); }
    .bar-tick { position: absolute; bottom: -22px; font-size: 0.5rem; color: var(--text-sub); transform: translateX(-50%); left: 50%; white-space: nowrap; }

    .tooltip { position: fixed; background: #333; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; pointer-events: none; opacity: 0; transition: 0.1s; z-index: 4000; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
    .modal-card { background: var(--surface); padding: 25px; border-radius: 24px; width: 90%; max-width: 400px; }
  </style>
</head>
<body data-theme="dark">

<canvas id="bg-animation"></canvas>

<div id="globalLoader">
  <div class="wave-container">
    <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
  </div>
  <div id="loaderText" style="margin-top:20px; font-size:0.8rem; letter-spacing:2px;">SYNCING...</div>
</div>

<div id="chartTooltip" class="tooltip"></div>

<div class="container">
  <div class="header">
    <h1 style="margin:0; font-size: 1.2rem; letter-spacing: 1px; opacity: 0.8;">DIARY</h1>
    <div class="header-btns">
      <button onclick="showRandomMemory()" style="border:none; background:none; cursor:pointer; font-size:1.2rem;" title="æ€ã„å‡ºã‚’è¦‹ã‚‹">ğŸ’¡</button>
      <button onclick="toggleTheme()" style="border:none; background:none; cursor:pointer; font-size:1.2rem;">ğŸŒ“</button>
      <button onclick="openSettings()" style="border:none; background:none; cursor:pointer; font-size:1.2rem;">âš™ï¸</button>
    </div>
  </div>

  <div class="tab-bar">
    <div class="tab active" onclick="showTab('edit')">è¨˜éŒ²</div>
    <div class="tab" onclick="showTab('stats')">å­¦ç¿’</div>
    <div class="tab" onclick="showTab('view')">å±¥æ­´</div>
  </div>

  <div id="edit" class="content-section">
    <div id="memoryBox" class="memory-box" onclick="this.style.display='none'"></div>
    
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div class="streak-badge">
        <span>âœ§</span>
        <span>è¨˜éŒ²ç¶™ç¶š: <span id="streakCount">0</span> æ—¥</span>
      </div>
      <div id="monthlyReviewBtn" style="display:none;">
        <button class="btn" style="padding:6px 12px; font-size:0.75rem; width:auto;" onclick="openMonthlyReview()">ä»Šæœˆã®ç·æ‹¬</button>
      </div>
    </div>

    <div id="monthlyGoalDisplay" class="card" style="padding:15px; margin-bottom:15px; text-align:center; background:rgba(187,134,252,0.03);">
      <label style="margin-bottom:4px; font-size:0.7rem;">MONTHLY GOAL</label>
      <div id="goalText" style="font-weight:bold; font-size:1rem;">æœªè¨­å®š</div>
    </div>

    <div class="card">
      <label>æ—¥ä»˜</label><input type="date" id="date" onchange="autoLoadEntry()">
      
      <div style="display:flex; gap:10px;">
        <div style="flex:1"><label>æ°—åˆ†</label><select id="emotion"><option>æ™®é€š</option><option>ç–²ã‚ŒãŸ</option><option>æ€’ã£ã¦ã‚‹</option><option>æ‚²ã—ã„</option><option>ã‚‚ã‚„ã‚‚ã‚„</option></select></div>
        <div style="flex:1">
          <label>å‹‰å¼·åˆè¨ˆ (åˆ†)</label>
          <input type="number" id="studyTime" value="0" readonly style="background:rgba(0,0,0,0.05); color:var(--text-sub);">
        </div>
        <div style="flex:0.8">
          <label>è¿½åŠ  (åˆ†)</label>
          <input type="number" id="addStudyTime" value="0" style="border:1px solid var(--primary);">
        </div>
      </div>

      <label>å†…å®¹</label><textarea id="diary" rows="6" placeholder="é™ã‹ã«ä»Šæ—¥ã‚’æŒ¯ã‚Šè¿”ã‚‹..."></textarea>
      
      <label>å†™çœŸ</label>
      <input type="file" id="imgInput" accept="image/*" onchange="handleImage(this)">
      <div id="imagePreviewContainer" style="display:none; margin-bottom:16px; border-radius:12px; overflow:hidden;">
        <img id="imagePreview" style="width:100%; display:block;">
      </div>
      
      <button class="btn" onclick="checkOverwrite()" id="saveBtn">ã“ã®æ—¥ã‚’åˆ»ã‚€</button>
    </div>
  </div>

  <div id="stats" class="content-section" style="display:none">
    <div class="card">
      <div style="display:flex; gap:8px; margin-bottom:20px;">
        <select id="statYear" onchange="refreshStats()"></select>
        <select id="statMonth" onchange="refreshStats()"></select>
      </div>
      
      <label style="text-align:center;">ä»Šæœˆã®ç›®æ¨™é”æˆç‡</label>
      <div class="pie-container">
        <svg class="pie-svg" viewBox="0 0 100 100">
          <circle class="pie-bg" cx="50" cy="50" r="40"></circle>
          <circle id="pieFill" class="pie-val" cx="50" cy="50" r="40" stroke-dasharray="0 251.2"></circle>
        </svg>
        <div id="pieLabel" class="pie-text">0%</div>
      </div>
      <p id="progressSub" style="font-size:0.7rem; color:var(--text-sub); text-align:center; margin-bottom:25px;"></p>

      <label>æ—¥åˆ¥å‹‰å¼·æ™‚é–“</label>
      <div class="chart-wrapper">
        <div id="yAxisDaily" class="y-axis"></div>
        <div id="dailyChart" class="bar-frame"></div>
      </div>

      <label style="margin-top:20px;">æœˆåˆ¥å‹‰å¼·æ™‚é–“ (å¹´æ¨ç§»)</label>
      <div class="chart-wrapper">
        <div id="yAxisMonthly" class="y-axis"></div>
        <div id="monthlyChart" class="bar-frame"></div>
      </div>
    </div>
  </div>

  <div id="view" class="content-section" style="display:none">
    <div class="card">
      <div style="display:flex; justify-content: space-between; margin-bottom:15px;">
        <div style="display:flex; gap:8px;">
          <select id="viewYear" onchange="loadList()"></select>
          <select id="viewMonth" onchange="loadList()"></select>
        </div>
        <button onclick="toggleViewMode()" id="viewModeBtn" class="btn" style="width:auto; padding:5px 15px; font-size:0.8rem;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
      </div>
      <div id="diaryList"></div>
      <div id="calendarView" style="display:none;"></div>
    </div>
    <div id="viewerCard" class="card" style="display:none; border:2px solid var(--primary);">
      <div id="viewMeta" style="font-size:0.8rem; color:var(--primary); margin-bottom:10px; font-weight:bold;"></div>
      <div id="viewBody" style="white-space:pre-wrap; margin-bottom:20px;"></div>
      <div id="viewImageContainer" style="display:none; margin-bottom:15px;"><img id="viewImage" style="width:100%; border-radius:12px;"></div>
      <div style="display:flex; gap:10px;">
        <button class="btn" style="background:#888; flex:1;" onclick="document.getElementById('viewerCard').style.display='none'">é–‰ã˜ã‚‹</button>
        <button class="btn" style="background:#cf6679; color:#fff; flex:1;" id="deleteBtn">å‰Šé™¤</button>
      </div>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal-overlay">
  <div class="modal-card">
    <h3 style="margin:0 0 15px; font-size:1.1rem; color:var(--primary);">SETTING</h3>
    <label>ä»Šæœˆã®ç›®æ¨™</label>
    <textarea id="goalTextPrompt" rows="2"></textarea>
    <button class="btn" id="goalLockBtnText" onclick="saveGeneralGoal()">ç›®æ¨™ã‚’ãƒ­ãƒƒã‚¯</button>
    <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
    <label>å­¦ç¿’ç›®æ¨™æ™‚é–“ (åˆ†)</label>
    <div id="goalReference" style="font-size:0.7rem; background:rgba(187,134,252,0.1); padding:10px; border-radius:10px; margin-bottom:10px;">
      <div id="lastWeekTotal">å…ˆé€±: èª­è¾¼ä¸­...</div>
      <div id="dailyGoalEst">1æ—¥ã‚ãŸã‚Šç›®å®‰: 0åˆ†</div>
    </div>
    <input type="number" id="goalTimeInput" oninput="calcDailyEst(this.value)">
    <button class="btn" id="goalLockBtn" onclick="saveGoal()">æ™‚é–“ã‚’ãƒ­ãƒƒã‚¯</button>
    <button class="btn" style="background:transparent; color:var(--text-sub); margin-top:10px;" onclick="closeSettings()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div id="monthlyReviewModal" class="modal-overlay">
  <div class="modal-card">
    <h3 style="margin:0 0 15px; color:var(--primary);">ä»Šæœˆã®ãµã‚Šã‹ãˆã‚Š</h3>
    <p id="reviewStats" style="font-size:0.85rem; margin-bottom:15px;"></p>
    <label>ä»Šæœˆã‚’ä¸€è¨€ã§ã„ã†ã¨ï¼Ÿ</label>
    <textarea id="monthlySummary" rows="3" placeholder="é ‘å¼µã£ãŸã“ã¨ã‚„æ¥æœˆã¸ã®æ„æ°—è¾¼ã¿"></textarea>
    <button class="btn" onclick="saveMonthlyReview()">ç·æ‹¬ã‚’ä¿å­˜ã—ã¦æ—¥è¨˜ã«æ›¸ã</button>
    <button class="btn" style="background:none; color:var(--text-sub);" onclick="document.getElementById('monthlyReviewModal').style.display='none'">ã¾ãŸä»Šåº¦</button>
  </div>
</div>

<div id="customAlert" class="modal-overlay">
  <div class="modal-card" style="text-align:center;">
    <p id="alertMsg" style="font-weight:bold;"></p>
    <div id="alertBtns" style="display:flex; gap:10px; margin-top:20px;"></div>
  </div>
</div>

<script>
let currentDataList = [];
let selectedImageData = null;
let viewMode = 'list';

/* --- èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (é›†ä¸­ãƒ¢ãƒ¼ãƒ‰) --- */
const canvas = document.getElementById('bg-animation');
const ctx = canvas.getContext('2d');
let particles = [];
function initBg() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  particles = [];
  for(let i=0; i<30; i++) particles.push({
    x: Math.random()*canvas.width, y: Math.random()*canvas.height,
    r: Math.random()*2+1, s: Math.random()*0.5+0.1, o: Math.random()
  });
}
function drawBg() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
  ctx.fillStyle = color;
  particles.forEach(p => {
    ctx.globalAlpha = Math.abs(Math.sin(p.o)) * 0.3;
    ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
    p.y -= p.s; p.o += 0.01;
    if(p.y < -10) p.y = canvas.height + 10;
  });
  requestAnimationFrame(drawBg);
}
window.addEventListener('resize', initBg);
initBg(); drawBg();

/* --- åŸºæœ¬å…±é€šæ©Ÿèƒ½ --- */
function toggleLoader(show, text = "SYNCING...") {
  const loader = document.getElementById("globalLoader");
  document.getElementById("loaderText").textContent = text;
  loader.style.display = show ? "flex" : "none";
}

function showTab(t) {
  document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  const btn = document.querySelector(`.tab[onclick*="${t}"]`);
  if(btn) btn.classList.add('active');
  document.getElementById(t).style.display = 'block';
  if(t === 'stats') refreshStats();
  if(t === 'view') loadList();
  if(t === 'edit') checkMonthlyReviewAvailability();
}

function toggleTheme() {
  const b = document.body;
  b.setAttribute("data-theme", b.getAttribute("data-theme") === "dark" ? "light" : "dark");
}

/* --- å­¦ç¿’åˆ†æ (ã‚°ãƒ©ãƒ•å¾©æ´») --- */
function refreshStats() {
  const y = document.getElementById("statYear").value;
  const m = document.getElementById("statMonth").value;
  toggleLoader(true, "ANALYZING...");
  google.script.run.withSuccessHandler(res => {
    toggleLoader(false);
    const goal = localStorage.getItem(`goal_${y}_${m}`) || 0;
    const total = res.daily.reduce((a, b) => a + b.time, 0);
    const percent = goal > 0 ? Math.min(Math.round((total / goal) * 100), 100) : 0;
    
    document.getElementById("pieFill").setAttribute("stroke-dasharray", `${(percent / 100) * 251.2} 251.2`);
    document.getElementById("pieLabel").textContent = `${percent}%`;
    document.getElementById("progressSub").textContent = goal > 0 ? `åˆè¨ˆ: ${total}åˆ† / ç›®æ¨™: ${goal}åˆ†` : "ç›®æ¨™æœªè¨­å®š";
    
    drawChart("dailyChart", "yAxisDaily", res.daily.map(d => ({ label: d.day, val: d.time })), 5);
    drawChart("monthlyChart", "yAxisMonthly", res.monthly.map(m => ({ label: m.month, val: m.time })), 1);
  }).getDetailedStudyStats(y, m);
}

function drawChart(chartId, axisId, data, step) {
  const frame = document.getElementById(chartId);
  const axis = document.getElementById(axisId);
  frame.innerHTML = ""; axis.innerHTML = "";
  const vals = data.map(d => d.val);
  const max = Math.max(...vals, 60);
  for(let i=4; i>=0; i--) {
    const d = document.createElement("div"); d.textContent = Math.round(max * (i/4)); axis.appendChild(d);
  }
  data.forEach((d, i) => {
    const bar = document.createElement("div");
    bar.className = "bar"; bar.style.height = `${(d.val / max) * 100}%`;
    bar.onmouseenter = (e) => showTooltip(e, `${d.label}: ${d.val}åˆ†`);
    bar.onmouseleave = hideTooltip;
    if ((i + 1) % step === 0 || i === 0 || i === data.length - 1) {
      const t = document.createElement("div"); t.className = "bar-tick"; t.textContent = d.label; bar.appendChild(t);
    }
    frame.appendChild(bar);
  });
}

/* --- åŠ ç®—å…¥åŠ›ãƒ­ã‚¸ãƒƒã‚¯ --- */
function checkOverwrite() {
  const addVal = parseInt(document.getElementById("addStudyTime").value) || 0;
  if(addVal > 0) {
    const current = parseInt(document.getElementById("studyTime").value) || 0;
    document.getElementById("studyTime").value = current + addVal;
  }
  executeSave();
}

function executeSave() {
  toggleLoader(true, "SAVING...");
  const date = document.getElementById("date").value;
  google.script.run.withSuccessHandler(() => { 
    toggleLoader(false); 
    document.getElementById("addStudyTime").value = 0; // ãƒªã‚»ãƒƒãƒˆ
    showAlert("è¨˜éŒ²ã—ã¾ã—ãŸ", 'info'); 
    calculateStreak(); 
    // ä¿å­˜å¾Œã€30%ã®ç¢ºç‡ã§æ€ã„å‡ºã‚’è¡¨ç¤º
    if(Math.random() < 0.3) setTimeout(showRandomMemory, 1000);
  }).saveDiary(date, document.getElementById("diary").value, document.getElementById("emotion").value, document.getElementById("studyTime").value, selectedImageData);
}

/* --- æ€ã„å‡ºæ©Ÿèƒ½ (é›»çƒãƒ»ãƒ©ãƒ³ãƒ€ãƒ ) --- */
function showRandomMemory() {
  google.script.run.withSuccessHandler(data => {
    if(!data || data.length < 1) return;
    const past = data.filter(d => d.name < document.getElementById("date").value);
    if(past.length === 0) return;
    const item = past[Math.floor(Math.random() * past.length)];
    const box = document.getElementById("memoryBox");
    box.innerHTML = `<small>âœ§ Past Memory (${item.name})</small>${item.preview}...`;
    box.style.display = "block";
    box.scrollIntoView({behavior: "smooth"});
  }).getDiaryList(null, null);
}

/* --- æœˆæœ«æŒ¯ã‚Šè¿”ã‚Š --- */
function checkMonthlyReviewAvailability() {
  const now = new Date();
  const day = now.getDate();
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  if (day >= lastDay - 5) { // æœˆæœ«5æ—¥å‰ã‹ã‚‰è¡¨ç¤º
    document.getElementById("monthlyReviewBtn").style.display = "block";
  }
}
function openMonthlyReview() {
  const y = new Date().getFullYear();
  const m = new Date().getMonth() + 1;
  google.script.run.withSuccessHandler(res => {
    const total = res.daily.reduce((a, b) => a + b.time, 0);
    document.getElementById("reviewStats").textContent = `${m}æœˆã®å­¦ç¿’åˆè¨ˆã¯ ${total} åˆ†ã§ã—ãŸã€‚`;
    document.getElementById("monthlyReviewModal").style.display = "flex";
  }).getDetailedStudyStats(y, m);
}
function saveMonthlyReview() {
  const summary = document.getElementById("monthlySummary").value;
  if(!summary) return;
  const currentText = document.getElementById("diary").value;
  document.getElementById("diary").value = `ã€ä»Šæœˆã®ç·æ‹¬ã€‘\n${summary}\n\n---\n${currentText}`;
  document.getElementById("monthlyReviewModal").style.display = "none";
  showAlert("æ—¥è¨˜æ¬„ã«ç·æ‹¬ã‚’æŒ¿å…¥ã—ã¾ã—ãŸã€‚ä¿å­˜ã—ã¦ãã ã•ã„ã€‚", "info");
}

/* --- è¨­å®šãƒ»ç›®æ¨™ãƒ»ãã®ä»–(æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ç¶­æŒ) --- */
function openSettings() {
  const now = new Date();
  fetchLastWeekStats();
  const keyTime = `goal_${now.getFullYear()}_${now.getMonth() + 1}`;
  const savedTime = localStorage.getItem(keyTime);
  const inputTime = document.getElementById("goalTimeInput");
  const btnTime = document.getElementById("goalLockBtn");
  if (savedTime) {
    inputTime.value = savedTime; inputTime.classList.add("locked"); btnTime.classList.add("locked"); btnTime.textContent = "ãƒ­ãƒƒã‚¯æ¸ˆ";
  } else {
    inputTime.value = ""; inputTime.classList.remove("locked"); btnTime.classList.remove("locked"); btnTime.textContent = "æ™‚é–“ã‚’ãƒ­ãƒƒã‚¯";
  }
  const keyText = `goal_text_${now.getFullYear()}_${now.getMonth() + 1}`;
  const savedText = localStorage.getItem(keyText);
  const inputText = document.getElementById("goalTextPrompt");
  const btnText = document.getElementById("goalLockBtnText");
  if (savedText) {
    inputText.value = savedText; inputText.classList.add("locked"); btnText.classList.add("locked"); btnText.textContent = "ãƒ­ãƒƒã‚¯æ¸ˆ";
  } else {
    inputText.value = ""; inputText.classList.remove("locked"); btnText.classList.remove("locked"); btnText.textContent = "ç›®æ¨™ã‚’ãƒ­ãƒƒã‚¯";
  }
  document.getElementById("settingsModal").style.display = "flex";
}
function closeSettings() { document.getElementById("settingsModal").style.display = "none"; }
function saveGoal() {
  const val = document.getElementById("goalTimeInput").value;
  localStorage.setItem(`goal_${new Date().getFullYear()}_${new Date().getMonth() + 1}`, val);
  closeSettings(); refreshStats();
}
function saveGeneralGoal() {
  const val = document.getElementById("goalTextPrompt").value;
  localStorage.setItem(`goal_text_${new Date().getFullYear()}_${new Date().getMonth() + 1}`, val);
  updateGoalDisplay(); closeSettings();
}
function updateGoalDisplay() {
  const saved = localStorage.getItem(`goal_text_${new Date().getFullYear()}_${new Date().getMonth() + 1}`);
  document.getElementById("goalText").textContent = saved || "æœªè¨­å®š (âš™ï¸ã‚ˆã‚Šè¨­å®š)";
}
function calcDailyEst(val) {
  const days = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
  document.getElementById("dailyGoalEst").textContent = `1æ—¥ã‚ãŸã‚Šç›®å®‰: ${val ? Math.round(val / days) : 0}åˆ†`;
}
function fetchLastWeekStats() {
  google.script.run.withSuccessHandler(res => {
    const total = res.daily.slice(-7).reduce((a, b) => a + b.time, 0);
    document.getElementById("lastWeekTotal").textContent = `å…ˆé€±: ${total}åˆ†`;
  }).getDetailedStudyStats(new Date().getFullYear(), new Date().getMonth() + 1);
}

function handleImage(input) {
  if (input.files && input.files[0]) {
    toggleLoader(true, "PROCESSING...");
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX_WIDTH = 800; const scale = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH; canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        selectedImageData = canvas.toDataURL('image/jpeg', 0.7);
        document.getElementById("imagePreview").src = selectedImageData;
        document.getElementById("imagePreviewContainer").style.display = "block";
        toggleLoader(false);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
  }
}

function autoLoadEntry() {
  const dateStr = document.getElementById("date").value;
  if (!dateStr) return;
  toggleLoader(true, "LOADING...");
  google.script.run.withSuccessHandler(json => {
    toggleLoader(false);
    if (json) {
      document.getElementById("emotion").value = json.emotion;
      document.getElementById("studyTime").value = json.studyTime;
      document.getElementById("diary").value = json.content;
      if (json.image) {
        selectedImageData = json.image; document.getElementById("imagePreview").src = json.image;
        document.getElementById("imagePreviewContainer").style.display = "block";
      } else { selectedImageData=null; document.getElementById("imagePreviewContainer").style.display = "none"; }
    } else {
      document.getElementById("diary").value = ""; document.getElementById("studyTime").value = 0;
      selectedImageData=null; document.getElementById("imagePreviewContainer").style.display = "none";
    }
  }).getDiaryContent(new Date(dateStr).getFullYear(), new Date(dateStr).getMonth() + 1, dateStr);
}

function calculateStreak() {
  google.script.run.withSuccessHandler(data => {
    if(!data || data.length === 0) { document.getElementById("streakCount").textContent = "0"; return; }
    const sorted = data.map(d => d.name).sort().reverse();
    const today = new Date(); today.setHours(0,0,0,0);
    let count = 0;
    let last = new Date(sorted[0]); last.setHours(0,0,0,0);
    if ((today - last) / 86400000 > 1) { document.getElementById("streakCount").textContent = "0"; return; }
    for(let i=0; i<sorted.length; i++){
      const d = new Date(sorted[i]); d.setHours(0,0,0,0);
      if(i===0) count=1; else {
        const prev = new Date(sorted[i-1]); prev.setHours(0,0,0,0);
        if((prev - d)/86400000 === 1) count++; else break;
      }
    }
    document.getElementById("streakCount").textContent = count;
  }).getDiaryList(new Date().getFullYear(), new Date().getMonth()+1);
}

function loadList() {
  const y = document.getElementById("viewYear").value;
  const m = document.getElementById("viewMonth").value;
  toggleLoader(true, "FETCHING...");
  google.script.run.withSuccessHandler(data => {
    currentDataList = data || [];
    if (viewMode === 'list') renderList(currentDataList); else renderCalendar(currentDataList, y, m);
    toggleLoader(false);
  }).getDiaryList(y, m);
}
function renderList(data) {
  const list = document.getElementById("diaryList");
  list.style.display = "block"; document.getElementById("calendarView").style.display = "none";
  list.innerHTML = data.length ? "" : "<div style='text-align:center;padding:40px;opacity:0.3;'>No Records</div>";
  data.forEach(d => {
    const div = document.createElement("div"); 
    div.style = "background:var(--surface); padding:15px; border-radius:15px; margin-bottom:10px; border-left:4px solid var(--primary); cursor:pointer;";
    div.innerHTML = `<strong>${d.name}</strong> <span style="font-size:0.7rem; opacity:0.5;">${d.emotion}</span><br><small style="opacity:0.7;">${d.preview}...</small>`;
    div.onclick = () => openViewer(d.name);
    list.appendChild(div);
  });
}
function renderCalendar(data, year, month) {
  const container = document.getElementById("calendarView");
  container.style.display = "block"; document.getElementById("diaryList").style.display = "none";
  container.innerHTML = "";
  const grid = document.createElement("div"); 
  grid.style = "display:grid; grid-template-columns:repeat(7,1fr); gap:5px;";
  const first = new Date(year, month-1, 1).getDay();
  const days = new Date(year, month, 0).getDate();
  for(let i=0; i<first; i++) grid.appendChild(document.createElement("div"));
  for(let d=1; d<=days; d++){
    const ds = `${year}-${month.toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
    const item = data.find(x => x.name === ds);
    const div = document.createElement("div");
    div.style = `aspect-ratio:1; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:0.8rem; background:${item ? 'var(--primary)' : 'var(--border)'}; color:${item ? '#000' : 'inherit'}; cursor:pointer; opacity:${item ? 1 : 0.5};`;
    div.textContent = d;
    if(item) div.onclick = () => openViewer(ds);
    grid.appendChild(div);
  }
  container.appendChild(grid);
}
function openViewer(name) {
  toggleLoader(true, "READING...");
  google.script.run.withSuccessHandler(json => {
    toggleLoader(false);
    document.getElementById("viewerCard").style.display = "block";
    document.getElementById("viewMeta").textContent = `${json.date} / ${json.emotion} / ${json.studyTime}min`;
    document.getElementById("viewBody").textContent = json.content;
    const imgBox = document.getElementById("viewImageContainer");
    if(json.image) { imgBox.style.display="block"; document.getElementById("viewImage").src=json.image; } else imgBox.style.display="none";
    document.getElementById("deleteBtn").onclick = () => showAlert("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", "danger", () => {
      toggleLoader(true, "DELETING...");
      google.script.run.withSuccessHandler(() => { toggleLoader(false); document.getElementById("viewerCard").style.display="none"; loadList(); })
      .deleteDiary(document.getElementById("viewYear").value, document.getElementById("viewMonth").value, name);
    });
    window.scrollTo({top: document.getElementById("viewerCard").offsetTop - 20, behavior: 'smooth'});
  }).getDiaryContent(document.getElementById("viewYear").value, document.getElementById("viewMonth").value, name);
}

function showTooltip(e, text) {
  const tt = document.getElementById("chartTooltip");
  tt.textContent = text; tt.style.opacity = 1;
  tt.style.left = e.clientX + "px"; tt.style.top = (e.clientY - 30) + "px";
}
function hideTooltip() { document.getElementById("chartTooltip").style.opacity = 0; }

function showAlert(msg, type, onConfirm) {
  const modal = document.getElementById("customAlert");
  const btns = document.getElementById("alertBtns");
  document.getElementById("alertMsg").textContent = msg;
  btns.innerHTML = "";
  if (type === 'info') {
    const b = document.createElement("button"); b.className="btn"; b.textContent="OK"; b.onclick=()=>modal.style.display="none";
    btns.appendChild(b);
  } else {
    const b1 = document.createElement("button"); b1.className="btn"; b1.style.background="#888"; b1.textContent="Cancel"; b1.onclick=()=>modal.style.display="none";
    const b2 = document.createElement("button"); b2.className="btn"; b2.textContent="Execute"; b2.onclick=()=>{ modal.style.display="none"; onConfirm(); };
    btns.appendChild(b1); btns.appendChild(b2);
  }
  modal.style.display = "flex";
}

function toggleViewMode() {
  viewMode = (viewMode === 'list' ? 'calendar' : 'list');
  document.getElementById("viewModeBtn").textContent = (viewMode === 'list' ? "ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼" : "ãƒªã‚¹ãƒˆ");
  loadList();
}

window.addEventListener('DOMContentLoaded', () => {
  const now = new Date();
  document.getElementById("date").valueAsDate = now;
  ["statYear", "viewYear"].forEach(id => {
    const s = document.getElementById(id);
    for(let y=2024; y<=now.getFullYear(); y++) s.add(new Option(y+"å¹´", y));
    s.value = now.getFullYear();
  });
  ["statMonth", "viewMonth"].forEach(id => {
    const s = document.getElementById(id);
    for(let m=1; m<=12; m++) s.add(new Option(m+"æœˆ", m));
    s.value = now.getMonth()+1;
  });
  calculateStreak();
  updateGoalDisplay();
  checkMonthlyReviewAvailability();
  loadList();
});
</script>
</body>
</html>
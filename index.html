<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Growth Diary</title>
  <style>
    :root { --primary: #4caf50; --accent: #2196f3; --bg: #f0f2f5; --card: #ffffff; }
    body { font-family: sans-serif; margin: 0; background: var(--bg); font-size: 18px; color: #333; }
    .container { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }
    
    /* タブメニュー */
    .tab-bar { display: flex; background: #fff; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .tab { flex: 1; text-align: center; padding: 15px; font-weight: bold; font-size: 0.9rem; color: #888; border-bottom: 3px solid transparent; }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }

    .content-section { display: none; padding: 15px; }
    .content-section.active { display: block; }

    .card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 0.85rem; color: #666; }
    input, select, textarea { width: 100%; padding: 12px; font-size: 18px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; margin-bottom: 15px; }
    
    .btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
    .btn-sub { background: var(--accent); margin-top: 10px; }

    /* 分析パネル */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .stat-box { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; }
    .stat-val { font-size: 1.4rem; font-weight: bold; display: block; }
    .stat-label { font-size: 0.75rem; color: #777; }

    /* グラフ */
    .chart-frame { height: 150px; display: flex; align-items: flex-end; gap: 3px; border-bottom: 2px solid #eee; margin-bottom: 20px; }
    .bar { flex: 1; background: var(--primary); border-radius: 3px 3px 0 0; min-width: 5px; }

    /* リスト */
    .diary-item { border-bottom: 1px solid #eee; padding: 12px 0; cursor: pointer; }
    .diary-item:last-child { border: none; }
    .item-date { font-weight: bold; font-size: 0.9rem; }
    .item-preview { font-size: 0.8rem; color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    #feedbackArea { background: #e3f2fd; border-left: 5px solid var(--accent); display: none; }
  </style>
</head>
<body>

<div class="container">
  <div class="tab-bar">
    <div class="tab active" onclick="showTab('edit')">記録</div>
    <div class="tab" onclick="showTab('stats')">分析</div>
    <div class="tab" onclick="showTab('view')">閲覧</div>
  </div>

  <div id="edit" class="content-section active">
    <div class="card">
      <label>日付</label>
      <input type="date" id="date">
      
      <div style="display: flex; gap: 10px;">
        <div style="flex:1"><label>気分</label><select id="emotion"><option>普通</option><option>最高</option><option>疲れた</option></select></div>
        <div style="flex:1"><label>勉強(分)</label><input type="number" id="studyTime" value="0"></div>
      </div>

      <label>日記</label>
      <textarea id="diary" placeholder="自由に書いてください"></textarea>
      <button class="btn" onclick="save()">保存する</button>

      <div id="feedbackArea" class="card" style="margin-top:20px;">
        <div id="streakMsg" style="font-weight:bold;"></div>
        <div id="mysteryMsg" style="font-size:0.85rem; margin-bottom:10px;"></div>
        <div id="pastReflect" style="font-size:0.8rem; color:#555; padding-top:10px; border-top:1px dashed #ccc;"></div>
      </div>
    </div>
  </div>

  <div id="stats" class="content-section">
    <div class="card">
      <h3>学習レポート</h3>
      <div class="stats-grid">
        <div class="stat-box"><span class="stat-val" id="totalTime">0</span><span class="stat-label">今月の合計(分)</span></div>
        <div class="stat-box"><span class="stat-val" id="avgTime">0</span><span class="stat-label">1日平均(分)</span></div>
        <div class="stat-box"><span class="stat-val" id="compareVal">--</span><span class="stat-label">先月比</span></div>
        <div class="stat-box"><span class="stat-val" id="monthCount">0</span><span class="stat-label">記録日数</span></div>
      </div>
      <label>日別グラフ</label>
      <div id="studyChart" class="chart-frame"></div>
    </div>
  </div>

  <div id="view" class="content-section">
    <div class="card">
      <div style="display:flex; gap:5px;">
        <select id="viewYear" style="flex:2"></select>
        <select id="viewMonth" style="flex:1"></select>
      </div>
      <button class="btn btn-sub" onclick="loadList()">リストを表示</button>
      <div id="diaryList" style="margin-top:15px;"></div>
    </div>
    <div id="viewerCard" class="card" style="display:none;">
      <div id="viewDate" style="font-weight:bold; margin-bottom:10px;"></div>
      <div id="viewBody" style="white-space:pre-wrap; font-size:0.95rem;"></div>
    </div>
  </div>
</div>

<script>
window.onload = () => {
  const now = new Date();
  document.getElementById("date").valueAsDate = now;
  const ys = document.getElementById("viewYear");
  const ms = document.getElementById("viewMonth");
  for(let y=2024; y<=now.getFullYear(); y++) ys.add(new Option(y+"年", y));
  for(let m=1; m<=12; m++) ms.add(new Option(m+"月", m.toString().padStart(2,"0")));
  ys.value = now.getFullYear();
  ms.value = (now.getMonth()+1).toString().padStart(2,"0");
  refreshData();
};

function showTab(id) {
  document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  event.currentTarget.classList.add('active');
  if(id === 'stats') refreshData();
}

function save() {
  const btn = event.target;
  btn.disabled = true;
  google.script.run.withSuccessHandler(res => {
    btn.disabled = false;
    document.getElementById("feedbackArea").style.display = "block";
    document.getElementById("streakMsg").textContent = res.streak + "日連続！";
    document.getElementById("mysteryMsg").textContent = "記録は嘘をつきません。";
    if(res.pastDiary) document.getElementById("pastReflect").innerHTML = "<strong>1週間前:</strong><br>" + res.pastDiary.content.split('\n')[1];
    alert("保存完了！");
  }).saveDiary(document.getElementById("date").value, document.getElementById("diary").value, document.getElementById("emotion").value, document.getElementById("studyTime").value);
}

function refreshData() {
  const d = new Date(document.getElementById("date").value);
  google.script.run.withSuccessHandler(res => {
    document.getElementById("totalTime").textContent = res.total;
    const avg = res.count ? Math.round(res.total / res.count) : 0;
    document.getElementById("avgTime").textContent = avg;
    document.getElementById("monthCount").textContent = res.count;
    
    // 先月比計算
    if(res.prevMonthTotal > 0) {
      const diff = Math.round(((res.total - res.prevMonthTotal) / res.prevMonthTotal) * 100);
      document.getElementById("compareVal").textContent = (diff > 0 ? "+" : "") + diff + "%";
      document.getElementById("compareVal").style.color = diff >= 0 ? "green" : "red";
    }

    // グラフ描画
    const chart = document.getElementById("studyChart");
    chart.innerHTML = "";
    const max = Math.max(...res.daily.map(x => x.time), 60);
    res.daily.forEach(item => {
      const bar = document.createElement("div");
      bar.className = "bar";
      bar.style.height = (item.time / max * 100) + "%";
      chart.appendChild(bar);
    });
  }).getDetailedStudyStats(d.getFullYear().toString(), (d.getMonth()+1).toString().padStart(2,"0"));
}

function loadList() {
  google.script.run.withSuccessHandler(data => {
    const list = document.getElementById("diaryList");
    list.innerHTML = data.length ? "" : "なし";
    data.forEach(d => {
      const div = document.createElement("div");
      div.className = "diary-item";
      div.innerHTML = `<div class="item-date">${d.name}</div><div class="item-preview">${d.preview}</div>`;
      div.onclick = () => {
        google.script.run.withSuccessHandler(txt => {
          document.getElementById("viewerCard").style.display = "block";
          document.getElementById("viewDate").textContent = d.name;
          document.getElementById("viewBody").textContent = txt;
          window.scrollTo(0, document.body.scrollHeight);
        }).getDiaryContent(document.getElementById("viewYear").value, document.getElementById("viewMonth").value, d.name);
      };
      list.appendChild(div);
    });
  }).getDiaryList(document.getElementById("viewYear").value, document.getElementById("viewMonth").value);
}
</script>
</body>
</html>
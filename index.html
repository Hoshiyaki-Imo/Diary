<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Diary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root { --primary: #bb86fc; --bg: #f5f5f5; --surface: #ffffff; --on-surface: #333; --border: #eee; --text-sub: #888; --success: #03dac6; --gold: #ffb100; }
    [data-theme="dark"] { --primary: #cfa6ff; --bg: #121212; --surface: #1e1e1e; --on-surface: #e1e1e1; --border: #333; --text-sub: #aaa; }
    
    body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--on-surface); transition: 0.3s; line-height: 1.5; }
    .container { max-width: 900px; margin: 0 auto; padding: 0 20px 60px; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; }
    .header-btns { display: flex; align-items: center; gap: 10px; }
    
    .tab-bar { display: flex; background: var(--surface); border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .tab { flex: 1; text-align: center; padding: 14px; cursor: pointer; font-size: 0.9rem; color: var(--text-sub); font-weight: bold; border-bottom: 3px solid transparent; }
    .tab.active { color: var(--primary); background: rgba(187, 134, 252, 0.08); border-bottom: 3px solid var(--primary); }
    
    .card { background: var(--surface); padding: 24px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); position: relative; overflow: hidden; margin-bottom: 20px; }
    label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 8px; color: var(--primary); }
    input, select, textarea, button { width: 100%; padding: 12px; font-size: 1rem; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--on-surface); box-sizing: border-box; margin-bottom: 16px; outline: none; }
    
    .btn { background: var(--primary); color: #000; font-weight: bold; border: none; cursor: pointer; transition: 0.2s; position: relative; }
    .btn:active { transform: scale(0.98); }
    .btn-danger { background: #cf6679; color: #fff; }
    .locked { opacity: 0.6; pointer-events: none; background: var(--border) !important; color: var(--text-sub) !important; }

    #globalLoader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; backdrop-filter: blur(4px); flex-direction: column; color: #fff; }
    .spinner { width: 45px; height: 45px; border: 5px solid rgba(255,255,255,0.2); border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
    .cal-header { font-size: 0.7rem; color: var(--text-sub); font-weight: bold; padding-bottom: 10px; }
    .cal-day { aspect-ratio: 1; border-radius: 10px; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--border); cursor: pointer; position: relative; }
    .cal-day.has-entry { background: rgba(187, 134, 252, 0.15); border: 1px solid var(--primary); }
    .cal-day .dot { width: 4px; height: 4px; background: var(--primary); border-radius: 50%; margin-top: 2px; }

    .image-box { width: 100%; max-height: 300px; display: flex; align-items: center; justify-content: center; background: #000; border-radius: 12px; margin-bottom: 16px; overflow: hidden; border: 1px solid var(--border); }
    .image-box img { max-width: 100%; max-height: 300px; object-fit: contain; }

    .diary-item { background: var(--surface); padding: 15px; border-radius: 16px; margin-bottom: 12px; border-left: 6px solid var(--primary); cursor: pointer; transition: 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .diary-item:hover { transform: translateX(5px); }

    .chart-wrapper { position: relative; padding-left: 35px; margin-bottom: 35px; margin-top: 10px; }
    .y-axis { position: absolute; left: 0; top: 0; bottom: 0; width: 35px; display: flex; flex-direction: column; justify-content: space-between; font-size: 0.6rem; color: var(--text-sub); text-align: right; padding-right: 5px; box-sizing: border-box; border-right: 1px solid var(--border); }
    .bar-frame { height: 120px; display: flex; align-items: flex-end; border-bottom: 2px solid var(--border); gap: 2px; position: relative; }
    .bar { flex: 1; background: var(--primary); border-radius: 2px 2px 0 0; position: relative; cursor: pointer; transition: 0.2s; }
    .bar:hover { filter: brightness(1.2); }
    .bar-tick { position: absolute; bottom: -22px; font-size: 0.6rem; color: var(--text-sub); transform: translateX(-50%); left: 50%; white-space: nowrap; }
    
    .avg-line { position: absolute; left: 0; right: 0; border-top: 1px dashed #cf6679; z-index: 10; pointer-events: none; }
    .avg-label { position: absolute; right: 0; font-size: 0.6rem; color: #cf6679; background: var(--surface); padding: 0 2px; transform: translateY(-50%); z-index: 11; font-weight: bold; }

    .tooltip { position: fixed; background: #333; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; pointer-events: none; opacity: 0; transition: 0.1s; z-index: 4000; white-space: nowrap; transform: translate(-50%, -120%); }

    /* ç¶™ç¶šæ—¥æ•°ãƒ»ç›®æ¨™ãƒãƒƒã‚¸ */
    .streak-badge { background: linear-gradient(135deg, #ffb100, #ff6d00); color: #000; padding: 12px; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: bold; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(255,177,0,0.2); }
    .monthly-goal-box { background: rgba(187, 134, 252, 0.1); border: 1px dashed var(--primary); padding: 12px; border-radius: 12px; margin-bottom: 15px; text-align: center; }

    .progress-frame { height: 20px; background: var(--border); border-radius: 10px; overflow: hidden; margin: 10px 0; position: relative; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); width: 0%; transition: 1s; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
    .modal-card { background: var(--surface); padding: 25px; border-radius: 24px; width: 90%; max-width: 400px; border: 2px solid var(--primary); }
  </style>
</head>
<body data-theme="dark">

<div id="globalLoader">
  <div class="spinner"></div>
  <div id="loaderText">èª­è¾¼ä¸­...</div>
</div>
<div id="chartTooltip" class="tooltip"></div>

<div class="container">
  <div class="header">
    <h1 style="margin:0; font-size: 1.4rem;">Diary</h1>
    <div class="header-btns">
      <button onclick="toggleTheme()" style="border:none; background:none; cursor:pointer; font-size:1.4rem;">ğŸŒ“</button>
      <button onclick="openSettings()" style="border:none; background:none; cursor:pointer; font-size:1.4rem;">âš™ï¸</button>
    </div>
  </div>

  <div class="tab-bar">
    <div class="tab active" onclick="showTab('edit')">è¨˜éŒ²</div>
    <div class="tab" onclick="showTab('stats')">å­¦ç¿’</div>
    <div class="tab" onclick="showTab('view')">å±¥æ­´</div>
  </div>

  <div id="edit" class="content-section">
    <div class="streak-badge">
      <span style="font-size:1.2rem;">ğŸ”¥</span>
      <span>é€£ç¶šè¨˜éŒ²: <span id="streakCount" style="font-size:1.4rem;">0</span> æ—¥</span>
    </div>
    
    <div id="monthlyGoalDisplay" class="monthly-goal-box">
      <label style="margin-bottom:4px;">ä»Šæœˆã®ç›®æ¨™</label>
      <div id="goalText" style="font-weight:bold; font-size:1.1rem; color:var(--on-surface);">æœªè¨­å®š</div>
    </div>

    <div class="card">
      <label>æ—¥ä»˜</label><input type="date" id="date" onchange="autoLoadEntry()">
      <div style="display:flex; gap:10px;">
        <div style="flex:1"><label>æ°—åˆ†</label><select id="emotion"><option>æ™®é€š</option><option>ç–²ã‚ŒãŸ</option><option>æ€’ã£ã¦ã‚‹</option><option>æ‚²ã—ã„</option><option>ã‚‚ã‚„ã‚‚ã‚„</option></select></div>
        <div style="flex:1"><label>å‹‰å¼·(åˆ†)</label><input type="number" id="studyTime" value="0"></div>
      </div>
      <label>å†…å®¹</label><textarea id="diary" rows="5" placeholder="ä½•ãŒã‚ã£ãŸï¼Ÿ"></textarea>
      <label>ä»Šæ—¥ã®å†™çœŸ</label>
      <input type="file" id="imgInput" accept="image/*" onchange="handleImage(this)">
      <div id="imagePreviewContainer" class="image-box" style="display:none; position:relative;">
        <img id="imagePreview" src="">
        <div style="position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.6); color:#fff; width:28px; height:28px; border-radius:50%; text-align:center; line-height:28px; cursor:pointer; font-weight:bold;" onclick="clearImage()">Ã—</div>
      </div>
      <button class="btn" onclick="checkOverwrite()" id="saveBtn">ä¿å­˜</button>
    </div>
  </div>

  <div id="stats" class="content-section" style="display:none">
    <div class="card">
      <div style="display:flex; gap:8px; margin-bottom:20px;">
        <select id="statYear" onchange="refreshStats()"></select>
        <select id="statMonth" onchange="refreshStats()"></select>
      </div>
      
      <label id="progressLabel">ä»Šæœˆã®å‹‰å¼·ç›®æ¨™é”æˆç‡: 0%</label>
      <div class="progress-frame"><div id="progressBar" class="progress-bar"></div></div>
      <p id="progressSub" style="font-size:0.7rem; color:var(--text-sub); margin-bottom:20px;"></p>

      <label>æ—¥åˆ¥å‹‰å¼·æ™‚é–“ (åˆ†)</label>
      <div class="chart-wrapper">
        <div id="yAxisDaily" class="y-axis"></div>
        <div id="dailyChart" class="bar-frame"></div>
      </div>

      <label>æœˆåˆ¥å‹‰å¼·æ™‚é–“ (åˆ†)</label>
      <div class="chart-wrapper">
        <div id="yAxisMonthly" class="y-axis"></div>
        <div id="monthlyChart" class="bar-frame"></div>
      </div>
    </div>
  </div>

  <div id="view" class="content-section" style="display:none">
    <div class="card">
      <div style="display:flex; justify-content: space-between; margin-bottom:15px;">
        <div style="display:flex; gap:8px;">
          <select id="viewYear" onchange="loadList()"></select>
          <select id="viewMonth" onchange="loadList()"></select>
        </div>
        <button onclick="toggleViewMode()" id="viewModeBtn" class="btn" style="width:auto; padding:5px 15px;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
      </div>
      <div id="diaryList"></div>
      <div id="calendarView" style="display:none;"></div>
    </div>
    <div id="viewerCard" class="card" style="display:none; border:2px solid var(--primary);">
      <div id="viewMeta" style="font-size:0.8rem; color:var(--primary); margin-bottom:10px; font-weight:bold;"></div>
      <div id="viewBody" style="white-space:pre-wrap; margin-bottom:20px;"></div>
      <div id="viewImageContainer" class="image-box" style="display:none;"><img id="viewImage" src=""></div>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="btn" style="background:#888; flex:1;" onclick="document.getElementById('viewerCard').style.display='none'">é–‰ã˜ã‚‹</button>
        <button class="btn btn-danger" style="flex:1;" id="deleteBtn">å‰Šé™¤</button>
      </div>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal-overlay">
  <div class="modal-card">
    <h3 style="margin:0 0 15px;">ç›®æ¨™è¨­å®š</h3>
    
    <label>ä»Šæœˆã®ç›®æ¨™ï¼ˆå…¨èˆ¬ï¼‰</label>
    <textarea id="goalTextPrompt" rows="2" placeholder="ä¾‹: æ¯æ—¥é‹å‹•ã™ã‚‹ã€èª­äº†ã™ã‚‹ãªã©" style="width:100%; margin-bottom:10px; border-radius:12px; border:1px solid var(--border); padding:10px; background:var(--bg); color:var(--on-surface); font-family:inherit;"></textarea>
    <button class="btn" id="goalLockBtnText" onclick="saveGeneralGoal()">ç›®æ¨™ã‚’ä¿å­˜ã—ã¦ãƒ­ãƒƒã‚¯</button>

    <div style="border-top:1px solid var(--border); margin:15px 0; padding-top:15px;"></div>

    <label>å­¦ç¿’ç›®æ¨™æ™‚é–“ (åˆ†)</label>
    <input type="number" id="goalTimeInput" placeholder="ä¾‹: 3000">
    <button class="btn" id="goalLockBtn" onclick="saveGoal()">æ™‚é–“ã‚’ä¿å­˜ã—ã¦ãƒ­ãƒƒã‚¯</button>
    
    <p style="font-size: 0.7rem; color: var(--text-sub); margin-top: 5px;">â€»ä¸€åº¦ä¿å­˜ã™ã‚‹ã¨ãã®æœˆã¯å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚</p>
    <button class="btn" style="background:#888;" onclick="closeSettings()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div id="customAlert" class="modal-overlay">
  <div class="modal-card" style="text-align:center;">
    <p id="alertMsg" style="font-weight:bold;"></p>
    <div id="alertBtns" style="display:flex; gap:10px; margin-top:20px;"></div>
  </div>
</div>

<script>
let currentDataList = [];
let selectedImageData = null;
let viewMode = 'list';

function toggleLoader(show, text = "èª­è¾¼ä¸­...") {
  const loader = document.getElementById("globalLoader");
  if(!loader) return;
  document.getElementById("loaderText").textContent = text;
  loader.style.display = show ? "flex" : "none";
}

function showTab(t) {
  document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  const btn = document.querySelector(`.tab[onclick*="${t}"]`);
  if(btn) btn.classList.add('active');
  document.getElementById(t).style.display = 'block';
  if(t === 'stats') refreshStats();
  if(t === 'view') loadList();
  if(t === 'edit') calculateStreak();
}

function toggleTheme() {
  const b = document.body;
  b.setAttribute("data-theme", b.getAttribute("data-theme") === "dark" ? "light" : "dark");
}

/* --- è¨­å®šãƒ»ç›®æ¨™ãƒ­ãƒƒã‚¯ --- */
function openSettings() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  
  // å­¦ç¿’æ™‚é–“ç›®æ¨™
  const keyTime = `goal_${year}_${month}`;
  const savedTime = localStorage.getItem(keyTime);
  const inputTime = document.getElementById("goalTimeInput");
  const btnTime = document.getElementById("goalLockBtn");
  if (savedTime) {
    inputTime.value = savedTime; inputTime.classList.add("locked"); btnTime.classList.add("locked"); btnTime.textContent = "ãƒ­ãƒƒã‚¯æ¸ˆã¿";
  } else {
    inputTime.value = ""; inputTime.classList.remove("locked"); btnTime.classList.remove("locked"); btnTime.textContent = "æ™‚é–“ã‚’ä¿å­˜ã—ã¦ãƒ­ãƒƒã‚¯";
  }

  // å…¨èˆ¬ç›®æ¨™
  const keyText = `goal_text_${year}_${month}`;
  const savedText = localStorage.getItem(keyText);
  const inputText = document.getElementById("goalTextPrompt");
  const btnText = document.getElementById("goalLockBtnText");
  if (savedText) {
    inputText.value = savedText; inputText.classList.add("locked"); btnText.classList.add("locked"); btnText.textContent = "ãƒ­ãƒƒã‚¯æ¸ˆã¿";
  } else {
    inputText.value = ""; inputText.classList.remove("locked"); btnText.classList.remove("locked"); btnText.textContent = "ç›®æ¨™ã‚’ä¿å­˜ã—ã¦ãƒ­ãƒƒã‚¯";
  }

  document.getElementById("settingsModal").style.display = "flex";
}
function closeSettings() { document.getElementById("settingsModal").style.display = "none"; }

function saveGoal() {
  const val = document.getElementById("goalTimeInput").value;
  if (!val) return;
  showAlert(`å­¦ç¿’ç›®æ¨™ã‚’${val}åˆ†ã§ãƒ­ãƒƒã‚¯ã—ã¾ã™ã‹ï¼Ÿ`, 'confirm', () => {
    const now = new Date();
    localStorage.setItem(`goal_${now.getFullYear()}_${now.getMonth() + 1}`, val);
    closeSettings(); refreshStats();
  });
}

function saveGeneralGoal() {
  const val = document.getElementById("goalTextPrompt").value;
  if (!val) return;
  showAlert(`ã“ã®ç›®æ¨™ã§ãƒ­ãƒƒã‚¯ã—ã¾ã™ã‹ï¼Ÿ`, 'confirm', () => {
    const now = new Date();
    localStorage.setItem(`goal_text_${now.getFullYear()}_${now.getMonth() + 1}`, val);
    updateGoalDisplay();
    closeSettings();
  });
}

function updateGoalDisplay() {
  const now = new Date();
  const saved = localStorage.getItem(`goal_text_${now.getFullYear()}_${now.getMonth() + 1}`);
  document.getElementById("goalText").textContent = saved || "æœªè¨­å®š (âš™ï¸ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„)";
}

/* --- è¨˜éŒ²æ©Ÿèƒ½ --- */
function handleImage(input) {
  if (input.files && input.files[0]) {
    toggleLoader(true, "ç”»åƒã‚’å‡¦ç†ä¸­...");
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX_WIDTH = 800; const scale = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH; canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        selectedImageData = canvas.toDataURL('image/jpeg', 0.7);
        document.getElementById("imagePreview").src = selectedImageData;
        document.getElementById("imagePreviewContainer").style.display = "flex";
        toggleLoader(false);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
  }
}
function clearImage() {
  selectedImageData = null; document.getElementById("imgInput").value = ""; document.getElementById("imagePreviewContainer").style.display = "none";
}
function autoLoadEntry() {
  const dateStr = document.getElementById("date").value;
  if (!dateStr) return;
  toggleLoader(true, "ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...");
  google.script.run.withSuccessHandler(json => {
    toggleLoader(false);
    if (json) {
      document.getElementById("emotion").value = json.emotion;
      document.getElementById("studyTime").value = json.studyTime;
      document.getElementById("diary").value = json.content;
      if (json.image) {
        selectedImageData = json.image; document.getElementById("imagePreview").src = json.image; document.getElementById("imagePreviewContainer").style.display = "flex";
      } else { clearImage(); }
    } else {
      document.getElementById("diary").value = ""; document.getElementById("studyTime").value = 0; clearImage();
    }
  }).getDiaryContent(new Date(dateStr).getFullYear(), new Date(dateStr).getMonth() + 1, dateStr);
}
function checkOverwrite() {
  const date = document.getElementById("date").value;
  if (currentDataList.some(d => d.name === date)) showAlert("æ—¢ã«è¨˜éŒ²ãŒã‚ã‚Šã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ", 'confirm', executeSave);
  else executeSave();
}
function executeSave() {
  toggleLoader(true, "ä¿å­˜ä¸­...");
  google.script.run.withSuccessHandler(() => { toggleLoader(false); showAlert("ä¿å­˜ã—ã¾ã—ãŸ", 'info'); calculateStreak(); loadList(); })
    .saveDiary(document.getElementById("date").value, document.getElementById("diary").value, document.getElementById("emotion").value, document.getElementById("studyTime").value, selectedImageData);
}

/* --- å±¥æ­´ --- */
function toggleViewMode() {
  viewMode = (viewMode === 'list' ? 'calendar' : 'list');
  document.getElementById("viewModeBtn").textContent = (viewMode === 'list' ? "ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼" : "ãƒªã‚¹ãƒˆ");
  loadList();
}
function loadList() {
  const y = document.getElementById("viewYear").value;
  const m = document.getElementById("viewMonth").value;
  toggleLoader(true, "å–å¾—ä¸­...");
  google.script.run.withSuccessHandler(data => {
    currentDataList = data || [];
    if (viewMode === 'list') renderList(currentDataList); else renderCalendar(currentDataList, y, m);
    toggleLoader(false);
  }).getDiaryList(y, m);
}
function renderList(data) {
  const list = document.getElementById("diaryList");
  list.style.display = "block"; document.getElementById("calendarView").style.display = "none";
  list.innerHTML = data.length ? "" : "<div style='text-align:center;padding:20px;opacity:0.5;'>ãªã—</div>";
  data.forEach(d => {
    const div = document.createElement("div"); div.className = "diary-item";
    div.innerHTML = `<strong>${d.name}${d.hasImage ? " ğŸ–¼ï¸" : ""}</strong> <small style="float:right">${d.saveTime}</small><br><span style="font-size:0.8rem; opacity:0.7;">${d.preview}...</span>`;
    div.onclick = () => openViewer(d.name);
    list.appendChild(div);
  });
}
function renderCalendar(data, year, month) {
  const container = document.getElementById("calendarView");
  container.style.display = "block"; document.getElementById("diaryList").style.display = "none";
  container.innerHTML = "";
  const grid = document.createElement("div"); grid.className = "calendar-grid";
  ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(h => { const d = document.createElement("div"); d.className = "cal-header"; d.textContent = h; grid.appendChild(d); });
  const first = new Date(year, month-1, 1).getDay();
  const days = new Date(year, month, 0).getDate();
  for(let i=0; i<first; i++) grid.appendChild(document.createElement("div"));
  for(let d=1; d<=days; d++) {
    const ds = `${year}-${month.toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
    const item = data.find(x => x.name === ds);
    const div = document.createElement("div"); div.className = "cal-day"; div.textContent = d;
    if(item) {
      div.classList.add("has-entry");
      const dot = document.createElement("div"); dot.className = "dot"; div.appendChild(dot);
      div.style.backgroundColor = `rgba(187, 134, 252, ${0.15 + Math.min(item.studyTime / 180, 1) * 0.7})`;
      div.onclick = () => openViewer(ds);
    }
    grid.appendChild(div);
  }
  container.appendChild(grid);
}
function openViewer(name) {
  toggleLoader(true, "è©³ç´°...");
  google.script.run.withSuccessHandler(json => {
    toggleLoader(false);
    const vc = document.getElementById("viewerCard"); vc.style.display = "block";
    document.getElementById("viewMeta").textContent = `${json.date} [${json.emotion}] ${json.studyTime}åˆ†`;
    document.getElementById("viewBody").textContent = json.content;
    const imgBox = document.getElementById("viewImageContainer");
    if(json.image) { imgBox.style.display="flex"; document.getElementById("viewImage").src=json.image; } else imgBox.style.display="none";
    document.getElementById("deleteBtn").onclick = () => showAlert("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", "danger", () => {
      toggleLoader(true, "å‰Šé™¤ä¸­...");
      google.script.run.withSuccessHandler(() => { toggleLoader(false); vc.style.display="none"; loadList(); }).deleteDiary(document.getElementById("viewYear").value, document.getElementById("viewMonth").value, name);
    });
    vc.scrollIntoView({behavior: "smooth"});
  }).getDiaryContent(document.getElementById("viewYear").value, document.getElementById("viewMonth").value, name);
}

/* --- å­¦ç¿’åˆ†æ --- */
function refreshStats() {
  const y = document.getElementById("statYear").value;
  const m = document.getElementById("statMonth").value;
  toggleLoader(true, "åˆ†æä¸­...");
  google.script.run.withSuccessHandler(res => {
    toggleLoader(false);
    const goal = localStorage.getItem(`goal_${y}_${m}`) || 0;
    const total = res.daily.reduce((a, b) => a + b.time, 0);
    const percent = goal > 0 ? Math.min(Math.round((total / goal) * 100), 100) : 0;
    document.getElementById("progressBar").style.width = percent + "%";
    document.getElementById("progressLabel").textContent = `ä»Šæœˆã®å‹‰å¼·ç›®æ¨™é”æˆç‡: ${percent}%`;
    document.getElementById("progressSub").textContent = goal > 0 ? `åˆè¨ˆ: ${total}åˆ† / ç›®æ¨™: ${goal}åˆ†` : "å­¦ç¿’ç›®æ¨™æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“";
    drawChartWithAxis("dailyChart", "yAxisDaily", res.daily.map(d => ({ label: d.day, val: d.time })), true, 5);
    drawChartWithAxis("monthlyChart", "yAxisMonthly", res.monthly.map(m => ({ label: m.month, val: m.time })), false, 1);
  }).getDetailedStudyStats(y, m);
}

function calculateStreak() {
  const y = new Date().getFullYear();
  const m = new Date().getMonth() + 1;
  google.script.run.withSuccessHandler(data => {
    if(!data || data.length === 0) { document.getElementById("streakCount").textContent = "0"; return; }
    const sorted = data.map(d => d.name).sort().reverse();
    const today = new Date(); today.setHours(0,0,0,0);
    let count = 0;
    let checkDate = new Date(sorted[0]); checkDate.setHours(0,0,0,0);
    const diff = (today - checkDate) / (1000 * 60 * 60 * 24);
    if (diff > 1) { document.getElementById("streakCount").textContent = "0"; return; }
    for(let i=0; i < sorted.length; i++) {
      const d = new Date(sorted[i]); d.setHours(0,0,0,0);
      if (i === 0) { count = 1; } else {
        const prev = new Date(sorted[i-1]); prev.setHours(0,0,0,0);
        const gap = (prev - d) / (1000 * 60 * 60 * 24);
        if (gap === 1) count++; else break;
      }
    }
    document.getElementById("streakCount").textContent = count;
  }).getDiaryList(y, m); 
}

function drawChartWithAxis(chartId, axisId, data, drawAvg, step) {
  const frame = document.getElementById(chartId);
  const axis = document.getElementById(axisId);
  const tooltip = document.getElementById("chartTooltip");
  frame.innerHTML = ""; axis.innerHTML = "";
  const vals = data.map(d => d.val);
  const max = Math.max(...vals, 60);
  const avg = vals.length ? (vals.reduce((a,b)=>a+b,0) / vals.length) : 0;
  for(let i=4; i>=0; i--) {
    const d = document.createElement("div"); d.textContent = Math.round(max * (i/4)); axis.appendChild(d);
  }
  if(drawAvg && avg > 0) {
    const line = document.createElement("div"); line.className = "avg-line"; line.style.bottom = `${(avg/max)*100}%`;
    const lbl = document.createElement("div"); lbl.className = "avg-label"; lbl.textContent = `å¹³å‡:${Math.round(avg)}`;
    line.appendChild(lbl); frame.appendChild(line);
  }
  data.forEach((d, i) => {
    const bar = document.createElement("div");
    bar.className = "bar"; bar.style.height = `${(d.val / max) * 100}%`;
    const showTT = (e) => {
      tooltip.textContent = `${d.label}: ${d.val}åˆ†`; tooltip.style.opacity = 1;
      tooltip.style.left = e.clientX + "px"; tooltip.style.top = (e.clientY - 20) + "px";
    };
    bar.onmousemove = showTT; bar.onmouseenter = showTT;
    bar.onmouseleave = () => tooltip.style.opacity = 0;
    if ((i + 1) % step === 0 || i === 0 || i === data.length - 1) {
      const t = document.createElement("div"); t.className = "bar-tick"; t.textContent = d.label; bar.appendChild(t);
    }
    frame.appendChild(bar);
  });
}

function showAlert(msg, type, onConfirm) {
  const modal = document.getElementById("customAlert");
  const btns = document.getElementById("alertBtns");
  document.getElementById("alertMsg").textContent = msg;
  btns.innerHTML = "";
  const close = () => modal.style.display = "none";
  if (type === 'info') {
    const b = document.createElement("button"); b.className="btn"; b.textContent="OK"; b.onclick=close; btns.appendChild(b);
  } else {
    const b1 = document.createElement("button"); b1.className="btn"; b1.style.background="#888"; b1.textContent="ã‚­ãƒ£ãƒ³ã‚»ãƒ«"; b1.onclick=close;
    const b2 = document.createElement("button"); b2.className="btn"; b2.textContent="å®Ÿè¡Œ";
    if(type==='danger') b2.style.background="#cf6679";
    b2.onclick=()=>{ close(); onConfirm(); };
    btns.appendChild(b1); btns.appendChild(b2);
  }
  modal.style.display = "flex";
}

window.addEventListener('DOMContentLoaded', () => {
  const now = new Date();
  document.getElementById("date").valueAsDate = now;
  ["statYear", "viewYear"].forEach(id => {
    const s = document.getElementById(id);
    for(let y=2024; y<=now.getFullYear(); y++) s.add(new Option(y+"å¹´", y));
    s.value = now.getFullYear();
  });
  ["statMonth", "viewMonth"].forEach(id => {
    const s = document.getElementById(id);
    for(let m=1; m<=12; m++) s.add(new Option(m+"æœˆ", m));
    s.value = now.getMonth()+1;
  });
  calculateStreak();
  updateGoalDisplay();
  loadList();
});
</script>
</body>
</html>
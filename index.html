<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Diary</title>
  <style>
    :root { --primary: #bb86fc; --bg: #f5f5f5; --surface: #ffffff; --on-surface: #333; --border: #eee; --text-sub: #888; }
    [data-theme="dark"] { --primary: #cfa6ff; --bg: #121212; --surface: #1e1e1e; --on-surface: #e1e1e1; --border: #333; --text-sub: #aaa; }
    
    html { font-size: 16px; } 
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--on-surface); transition: 0.3s; line-height: 1.5; }

    /* ã‚³ãƒ³ãƒ†ãƒŠã‚’æœ€å¤§å¹…ã¾ã§å¼•ãä¼¸ã°ã—ã€ä¸­å¤®å¯„ã›ã‚’ç¢ºå®Ÿã«ã™ã‚‹ */
    .container { 
      max-width: 1000px; /* æ¨ªå¹…ã‚’åºƒã’ã¾ã—ãŸ */
      margin: 0 auto; 
      padding: 0 20px 60px;
      box-sizing: border-box;
    }

    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 30px 0; 
    }
    
    /* PCã§ã‚‚1ã‚«ãƒ©ãƒ ï¼ˆæ¨ªå¹…ã„ã£ã±ã„ï¼‰ã‚’åŸºæœ¬ã¨ã—ã€ä¸­å¤®ã«é…ç½® */
    .main-grid { 
      display: block; 
      width: 100%;
    }

    .tab-bar { 
      display: flex; 
      background: var(--surface); 
      border-radius: 16px; 
      overflow: hidden; 
      margin-bottom: 30px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
    }
    .tab { 
      flex: 1; 
      text-align: center; 
      padding: 16px 5px; 
      cursor: pointer; 
      font-size: 1rem; 
      color: var(--text-sub); 
      font-weight: bold; 
      transition: 0.3s; 
      border-bottom: 4px solid transparent; 
    }
    .tab.active { 
      color: var(--primary); 
      background: rgba(187, 134, 252, 0.1); 
      border-bottom: 4px solid var(--primary); 
    }
    
    .card { 
      background: var(--surface); 
      padding: 32px; 
      border-radius: 24px; 
      box-shadow: 0 8px 30px rgba(0,0,0,0.08); 
      position: relative; 
      overflow: hidden; 
      margin-bottom: 30px; 
      width: 100%;
      box-sizing: border-box;
    }

    label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 10px; color: var(--primary); letter-spacing: 0.05em; }
    
    /* å…¥åŠ›è¦ç´ ã‚‚æ¨ªã«å¼•ãä¼¸ã°ã™ */
    input, select, textarea, button { 
      width: 100%; 
      padding: 14px; 
      font-size: 1.1rem; 
      border-radius: 14px; 
      border: 1px solid var(--border); 
      background: var(--bg); 
      color: var(--on-surface); 
      box-sizing: border-box; 
      margin-bottom: 20px; 
      outline: none; 
      transition: 0.2s; 
    }
    input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(187,134,252,0.1); }
    
    .char-count { font-size: 0.8rem; color: var(--text-sub); text-align: right; margin-top: -15px; margin-bottom: 15px; }
    
    .btn { 
      background: var(--primary); 
      color: #000; 
      font-weight: bold; 
      border: none; 
      cursor: pointer; 
      padding: 18px; 
      font-size: 1.1rem;
      transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    }
    .btn:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(187,134,252,0.3); }
    .btn:active { transform: scale(0.98); }
    .btn-danger { background: #cf6679; color: #fff; }
    .btn-danger:hover { box-shadow: 0 5px 15px rgba(207,102,121,0.3); }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .save-progress { position: absolute; bottom: 0; left: 0; height: 6px; background: var(--primary); width: 0; }
    @keyframes saving-bar { from { width: 0%; } to { width: 95%; } }
    .is-saving .save-progress { animation: saving-bar 3s forwards; }

    .loading-overlay { display: none; font-weight: bold; color: var(--primary); text-align: center; padding: 30px; animation: pulse 1.5s infinite; font-size: 1.2rem; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* ã‚°ãƒ©ãƒ•ï¼šPCã§è¦‹æ „ãˆãŒè‰¯ã„ã‚ˆã†ã«å°‘ã—é«˜ãã€å¤ªã */
    .chart-container { 
      position: relative; 
      height: 250px; 
      border-bottom: 3px solid var(--border); 
      display: flex; 
      align-items: flex-end; 
      margin: 50px 0 40px; 
      padding: 0 10px;
    }
    .bar { flex: 1; background: var(--primary); margin: 0 5px; position: relative; border-radius: 6px 6px 0 0; min-height: 4px; transition: 0.3s; }
    .bar:hover { filter: brightness(1.2); }
    .bar-label { position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%); font-size: 11px; color: var(--text-sub); font-weight: bold; }
    .avg-line { position: absolute; left: 0; right: 0; border-top: 2px dashed #ff4081; z-index: 10; }
    .avg-label { position: absolute; right: 10px; top: -22px; color: #ff4081; font-size: 0.8rem; font-weight: bold; }

    .content-section { display: none; width: 100%; }
    .content-section.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .diary-item { 
      background: var(--surface); 
      padding: 20px; 
      border-radius: 18px; 
      margin-bottom: 15px; 
      border-left: 8px solid var(--primary); 
      cursor: pointer; 
      transition: 0.2s; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.04); 
    }
    .diary-item:hover { transform: translateX(5px); background: rgba(187, 134, 252, 0.05); }
    .diary-item .time-tag { font-size: 0.8rem; color: var(--text-sub); float: right; background: var(--bg); padding: 4px 12px; border-radius: 20px; font-weight: bold; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #customAlert { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; backdrop-filter: blur(6px); }
    .alert-card { background: var(--surface); padding: 40px; border-radius: 30px; width: 100%; max-width: 400px; text-align: center; border: 2px solid var(--primary); box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .alert-success { border-color: var(--primary); box-shadow: 0 0 40px rgba(187, 134, 252, 0.5); animation: success-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes success-pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .alert-btns { display: flex; gap: 15px; margin-top: 30px; }
  </style>
</head>
<body data-theme="dark">

<div class="container">
  <div class="header">
    <h1 style="margin:0; font-size: 1.8rem; letter-spacing: -0.03em; font-weight: 900; color: var(--primary);">Diary</h1>
    <button onclick="toggleTheme()" style="width:50px; height:50px; border-radius:50%; border:none; background:var(--surface); cursor:pointer; font-size:1.4rem; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">ğŸŒ“</button>
  </div>

  <div class="tab-bar">
    <div class="tab active" onclick="showTab('edit')">è¨˜éŒ²ã‚’ã¤ã‘ã‚‹</div>
    <div class="tab" onclick="showTab('stats')">åˆ†æã‚’è¦‹ã‚‹</div>
    <div class="tab" onclick="showTab('view')">å±¥æ­´ã‚’ç¢ºèª</div>
  </div>

  <div class="main-grid">
    <div id="edit" class="content-section active">
      <div id="inputCard" class="card">
        <label>æ—¥ä»˜ã‚’é¸æŠ</label>
        <input type="date" id="date">
        <div style="display:flex; gap:20px;">
          <div style="flex:1"><label>ä»Šã®æ°—åˆ†</label>
            <select id="emotion">
              <option>æ™®é€š</option><option>ç–²ã‚ŒãŸ</option><option>æ€’ã£ã¦ã‚‹</option><option>æ‚²ã—ã„</option><option>ã‚‚ã‚„ã‚‚ã‚„</option>
            </select>
          </div>
          <div style="flex:1"><label>å‹‰å¼·æ™‚é–“ (åˆ†)</label>
            <input type="number" id="studyTime" value="0" min="0">
          </div>
        </div>
        <label>ä»Šæ—¥ã®å†…å®¹</label>
        <textarea id="diary" rows="6" oninput="updateCharCount()" placeholder="ç´ æ™´ã‚‰ã—ã„ä¸€æ—¥ã§ã—ãŸã‹ï¼Ÿ"></textarea>
        <div id="charCount" class="char-count">0 æ–‡å­—</div>
        <button class="btn" onclick="checkOverwrite()" id="saveBtn">è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹</button>
        <div class="save-progress" id="saveProgress"></div>
      </div>
    </div>

    <div id="stats" class="content-section">
      <div class="card">
        <div style="display:flex; gap:15px; margin-bottom:30px;">
          <select id="statYear" onchange="refreshStats()" style="flex:1; margin:0;"></select>
          <select id="statMonth" onchange="refreshStats()" style="flex:1; margin:0;"></select>
          <select id="statMode" onchange="refreshStats()" style="flex:1; margin:0;"><option value="daily">æ—¥åˆ¥ã®æ¨ç§»</option><option value="monthly">æœˆåˆ¥ã®æ¨ç§»</option></select>
        </div>
        <div id="chartTitle" style="font-size: 1.2rem; font-weight:bold; text-align:center; color: var(--primary); margin-bottom:10px;"></div>
        <div class="chart-container" id="chartFrame"><div id="avgLine" class="avg-line"><span class="avg-label" id="avgLabel"></span></div></div>
        <div id="statsSummary" style="font-size:1.1rem; text-align:center; font-weight: bold; background: rgba(187,134,252,0.1); padding:20px; border-radius:16px; color: var(--primary);"></div>
      </div>
    </div>

    <div id="view" class="content-section">
      <div class="card" style="margin-bottom: 30px;">
        <div style="display:flex; gap:15px; margin-bottom:25px;">
          <select id="viewYear" onchange="loadList()" style="flex:1; margin:0;"></select>
          <select id="viewMonth" onchange="loadList()" style="flex:1; margin:0;"></select>
        </div>
        <div id="diaryList"></div>
      </div>
      
      <div id="viewerCard" class="card" style="display:none; border:3px solid var(--primary); scroll-margin-top: 30px;">
        <div id="loadingIndicator" class="loading-overlay">ğŸ“„ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™...</div>
        <div id="viewerContent">
          <div id="viewDate" style="font-weight:900; color:var(--primary); margin-bottom:20px; font-size:1.5rem; border-bottom: 2px solid var(--border); padding-bottom: 15px;"></div>
          <div id="viewBody" style="white-space:pre-wrap; font-size:1.1rem; margin-bottom:35px; min-height: 120px; color: var(--on-surface);"></div>
          <div style="display:flex; gap:20px;">
            <button class="btn" style="background:#666; color:#fff; flex:1; margin:0;" onclick="document.getElementById('viewerCard').style.display='none'">é–‰ã˜ã‚‹</button>
            <button class="btn btn-danger" style="flex:1; margin:0;" id="deleteBtn">ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã™ã‚‹</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="customAlert">
  <div class="alert-card" id="alertCard">
    <p id="alertMsg" style="margin-bottom:15px; font-weight:900; font-size: 1.3rem;"></p>
    <div id="alertBtns" class="alert-btns"></div>
  </div>
</div>

<script>
let currentDiaryList = [];
let deleteTarget = null;

function toggleTheme() { const b = document.body; b.setAttribute("data-theme", b.getAttribute("data-theme") === "dark" ? "light" : "dark"); }

function showTab(t) {
  document.querySelectorAll('.tab, .content-section').forEach(el => el.classList.remove('active'));
  const activeTab = document.querySelector(`.tab[onclick*="${t}"]`);
  if(activeTab) activeTab.classList.add('active');
  document.getElementById(t).classList.add('active');
  if(t === 'stats') refreshStats();
  if(t === 'view') loadList();
}

function updateCharCount() {
  const text = document.getElementById("diary").value;
  document.getElementById("charCount").textContent = text.length + " æ–‡å­—";
}

function showModal(msg, type = 'info', onConfirm = null) {
  const modal = document.getElementById("customAlert");
  const card = document.getElementById("alertCard");
  const btnsEl = document.getElementById("alertBtns");
  document.getElementById("alertMsg").textContent = msg;
  btnsEl.innerHTML = "";
  card.className = "alert-card";
  
  if (type === 'success') {
    card.classList.add('alert-success');
    const b = document.createElement("button"); b.className = "btn btn-ok"; b.textContent = "ç¢ºèªã—ã¾ã—ãŸ";
    b.onclick = () => modal.style.display = "none";
    btnsEl.appendChild(b);
  } else if (type === 'confirm' || type === 'danger') {
    const b1 = document.createElement("button"); b1.className = "btn btn-cancel"; b1.textContent = "æˆ»ã‚‹";
    b1.onclick = () => modal.style.display = "none";
    const b2 = document.createElement("button"); b2.className = "btn btn-ok"; b2.textContent = "å®Ÿè¡Œ";
    if(type === 'danger') b2.style.background = "#cf6679";
    b2.onclick = () => { modal.style.display = "none"; if(onConfirm) onConfirm(); };
    btnsEl.appendChild(b1); btnsEl.appendChild(b2);
  }
  modal.style.display = "flex";
}

function checkOverwrite() {
  const date = document.getElementById("date").value;
  if (currentDiaryList.some(d => d.name === date)) {
    showModal("æ—¢ã«åŒã˜æ—¥ã®è¨˜éŒ²ãŒå­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ", 'confirm', executeSave);
  } else {
    executeSave();
  }
}

function executeSave() {
  const btn = document.getElementById("saveBtn");
  const card = document.getElementById("inputCard");
  btn.disabled = true; btn.textContent = "ä¿å­˜ä¸­...";
  card.classList.add('is-saving');
  
  google.script.run.withSuccessHandler(() => { 
    card.classList.remove('is-saving');
    showModal("æ—¥è¨˜ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼", 'success'); 
    btn.disabled = false; btn.textContent = "è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹";
    loadList(); refreshStats();
  }).saveDiary(document.getElementById("date").value, document.getElementById("diary").value, document.getElementById("emotion").value, document.getElementById("studyTime").value);
}

function confirmDelete() {
  if(!deleteTarget) return;
  showModal("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚", 'danger', () => {
    google.script.run.withSuccessHandler(() => {
      document.getElementById('viewerCard').style.display = 'none';
      showModal("å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸ", 'success');
      loadList(); refreshStats();
    }).deleteDiary(deleteTarget.year, deleteTarget.month, deleteTarget.name);
  });
}

window.onload = () => {
  const now = new Date();
  document.getElementById("date").valueAsDate = now;
  const ys = [document.getElementById("statYear"), document.getElementById("viewYear")];
  const ms = [document.getElementById("statMonth"), document.getElementById("viewMonth")];
  ys.forEach(s => { for(let y=2024; y<=now.getFullYear(); y++) s.add(new Option(y+"å¹´", y)); s.value = now.getFullYear(); });
  ms.forEach(s => { for(let m=1; m<=12; m++) s.add(new Option(m+"æœˆ", m)); s.value = now.getMonth()+1; });
  loadList(); refreshStats();
};

function refreshStats() {
  const y = document.getElementById("statYear").value, m = document.getElementById("statMonth").value, mode = document.getElementById("statMode").value;
  google.script.run.withSuccessHandler(res => {
    const frame = document.getElementById("chartFrame");
    const data = mode === 'daily' ? res.daily : res.monthly;
    frame.querySelectorAll('.bar').forEach(b => b.remove());
    const max = Math.max(...data.map(d => d.time), 60);
    const sum = data.reduce((a, b) => a + b.time, 0);
    const recorded = data.filter(d => mode === 'monthly' || d.recorded);
    const avg = recorded.length ? Math.round(sum / recorded.length) : 0;
    data.forEach(d => {
      const bar = document.createElement("div"); bar.className = "bar"; bar.style.height = (d.time / max * 100) + "%";
      if(mode === 'daily' && !d.recorded) bar.style.opacity = "0.15";
      const lbl = document.createElement("span"); lbl.className = "bar-label";
      const val = mode === 'daily' ? d.day : d.month;
      if(mode === 'monthly' || val === 1 || val % 5 === 0) lbl.textContent = mode === 'daily' ? val : val + "æœˆ";
      bar.appendChild(lbl); frame.appendChild(bar);
    });
    document.getElementById("avgLine").style.bottom = (avg / max * 100) + "%";
    document.getElementById("avgLabel").textContent = "å¹³å‡ " + avg + "åˆ†";
    document.getElementById("chartTitle").textContent = mode === 'daily' ? res.targetLabel + " ã®çµ±è¨ˆ" : y + "å¹´ ã®æœˆåˆ¥çµ±è¨ˆ";
    document.getElementById("statsSummary").textContent = `ç·å­¦ç¿’æ™‚é–“: ${sum}åˆ† / ä¸€æ—¥å¹³å‡: ${avg}åˆ†`;
  }).getDetailedStudyStats(y, m);
}

function loadList() {
  const y = document.getElementById("viewYear").value, m = document.getElementById("viewMonth").value;
  google.script.run.withSuccessHandler(data => {
    currentDiaryList = data;
    const list = document.getElementById("diaryList");
    list.innerHTML = data.length ? "" : "<div style='text-align:center;padding:40px;font-size:1rem;opacity:0.6;'>ã“ã®æœˆã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
    data.forEach(d => {
      const div = document.createElement("div"); div.className = "diary-item";
      div.innerHTML = `<span class="time-tag">${d.saveTime}</span><strong>${d.name} [${d.emotion}]</strong><br><small style="color:var(--text-sub)">${d.preview}...</small>`;
      div.onclick = () => {
        const vCard = document.getElementById("viewerCard");
        const vContent = document.getElementById("viewerContent");
        const vLoading = document.getElementById("loadingIndicator");
        vCard.style.display = "block";
        vContent.style.opacity = "0";
        vLoading.style.display = "block";
        vCard.scrollIntoView({ behavior: 'smooth' });
        google.script.run.withSuccessHandler(txt => {
          vLoading.style.display = "none";
          vContent.style.opacity = "1";
          document.getElementById("viewDate").textContent = d.name;
          document.getElementById("viewBody").textContent = txt;
          deleteTarget = { year: y, month: m, name: d.name };
          document.getElementById("deleteBtn").onclick = confirmDelete;
        }).getDiaryContent(y, m, d.name);
      };
      list.appendChild(div);
    });
  }).getDiaryList(y, m);
}
</script>
</body>
</html>
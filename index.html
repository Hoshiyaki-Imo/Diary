<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --accent-color: #7b5cff;
      --accent-dark: #5a3ec8;
      --panel-bg: #2d2d2d;
      --input-bg: #3d3d3d;
      --danger: #ff4d4d;
      --gold: #ffd700;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Noto Sans JP', sans-serif;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background-image: radial-gradient(#333 1px, transparent 1px);
      background-size: 30px 30px;
      animation: bgScroll 60s linear infinite;
    }

    @keyframes bgScroll {
      0% { background-position: 0 0; }
      100% { background-position: 30px 30px; }
    }

    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 20px;
      background: rgba(26, 26, 26, 0.95);
      border-bottom: 1px solid #333;
      z-index: 10;
      backdrop-filter: blur(5px);
    }
    .app-title { font-weight: 700; font-size: 1.2rem; letter-spacing: 0.05em; }
    .header-icons span { margin-left: 15px; cursor: pointer; font-size: 1.2rem; }

    #main-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 80px;
      position: relative;
    }

    .tab-content { display: none; opacity: 0; transition: opacity 0.3s ease; }
    .tab-content.active { display: block; opacity: 1; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .bottom-nav {
      position: fixed; bottom: 0; width: 100%;
      background: #222;
      display: flex; justify-content: space-around;
      padding: 10px 0;
      border-top: 1px solid #333;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
      z-index: 20;
    }
    .nav-item {
      padding: 10px; color: #666; font-size: 0.9rem; cursor: pointer;
      text-align: center; transition: color 0.2s;
    }
    .nav-item.active { color: var(--accent-color); font-weight: bold; }

    .card {
      background: var(--panel-bg);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h2, h3 { margin-top: 0; font-weight: 500; font-size: 1rem; color: #ccc; margin-bottom: 10px; }
    
    input[type="text"], input[type="number"], textarea, select {
      width: 100%;
      background: var(--input-bg);
      border: 1px solid #444;
      color: #fff;
      padding: 12px;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 10px;
      outline: none;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--accent-color); }
    textarea { resize: none; height: 100px; }

    button {
      background: var(--accent-color);
      color: #fff; border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 1rem; cursor: pointer;
      width: 100%;
      font-weight: bold;
      transition: background 0.2s;
    }
    button:active { transform: scale(0.98); }
    button.secondary { background: #444; color: #ccc; }
    button.secondary.active { background: #eee; color: #000; }
    button.danger { background: var(--danger); }
    
    .btn-icon-subtle {
      background: transparent; color: #666; font-size: 1.2rem;
      padding: 5px 10px; width: auto; border: 1px solid transparent;
    }
    .btn-icon-subtle:hover { color: var(--danger); background: rgba(255, 77, 77, 0.1); }

    .slider-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    input[type="range"] {
      -webkit-appearance: none; width: 100%; height: 6px; background: #444; border-radius: 3px; outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--accent-color); cursor: pointer;
    }

    .photo-area {
      border: 2px dashed #555; border-radius: 8px; padding: 20px;
      text-align: center; margin-bottom: 15px; position: relative;
      background-size: cover; background-position: center; min-height: 150px;
      display: flex; justify-content: center; align-items: center; overflow: hidden;
    }
    .photo-preview { max-width: 100%; max-height: 300px; display: none; border-radius: 4px; }
    .photo-btn-group { position: absolute; bottom: 10px; right: 10px; display: flex; gap: 5px; }
    .mini-btn { padding: 5px 10px; font-size: 0.8rem; width: auto; background: rgba(0,0,0,0.6); }

    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 3000;
      display: none;
      backdrop-filter: blur(4px);
    }
    
    .wave-container {
      display: flex; justify-content: center; align-items: flex-end;
      height: 40px; gap: 6px; margin-bottom: 20px;
    }
    .wave-bar {
      width: 6px; background: var(--accent-color); border-radius: 3px;
      animation: waveMove 1s ease-in-out infinite;
    }
    .wave-bar:nth-child(1) { animation-delay: 0.0s; height: 20px; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 35px; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 25px; }
    .wave-bar:nth-child(4) { animation-delay: 0.1s; height: 30px; }
    .wave-bar:nth-child(5) { animation-delay: 0.0s; height: 20px; }

    @keyframes waveMove {
      0% { transform: scaleY(1); opacity: 0.6; }
      50% { transform: scaleY(1.5); opacity: 1; box-shadow: 0 0 10px var(--accent-color); }
      100% { transform: scaleY(1); opacity: 0.6; }
    }

    #loading-text {
      color: #fff; font-size: 0.9rem; font-family: monospace;
      letter-spacing: 0.05em; opacity: 0.9;
    }

    #notification {
      position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
      background: var(--accent-color); color: #fff;
      padding: 10px 20px; border-radius: 25px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 4000;
      transition: top 0.5s ease;
    }

    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 1000;
      justify-content: center; align-items: center; padding: 20px;
    }
    #dialog-modal { z-index: 2000; }
    #confirm-delete-modal { z-index: 2500; }

    .modal-content {
      background: var(--panel-bg); padding: 20px; border-radius: 12px;
      width: 100%; max-width: 400px; display:flex; flex-direction: column; max-height: 85vh;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .modal-body { overflow-y: auto; flex: 1; margin-bottom: 20px; }
    .modal-actions { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
    .modal-actions-right { display: flex; gap: 10px; margin-left: auto; }

    .memo-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
    .memo-tab { flex: 1; padding: 10px; background: #333; text-align: center; border-radius: 5px 5px 0 0; cursor: pointer; color:#888; }
    .memo-tab.active { background: var(--accent-color); color: white; }
    #memo-area { height: 300px; border-radius: 0 0 5px 5px; }

    .pie-container { width: 200px; height: 200px; margin: 0 auto 20px auto; position: relative; }
    .pie-center-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; font-weight: bold; }
    
    .history-list-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px; border-bottom: 1px solid #444; cursor: pointer; transition: background 0.2s;
    }
    .history-list-item:hover { background: rgba(255,255,255,0.05); }
    .history-meta { font-size: 0.8rem; color: #888; margin-bottom: 4px; }
    .history-preview { font-weight: 500; font-size: 0.95rem; }
    .history-weekday { font-size: 0.75rem; color: #999; margin-left: 5px; }

    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
    .cal-cell {
      aspect-ratio: 1; background: #333; border-radius: 4px;
      display: flex; justify-content: center; align-items: center; font-size: 0.8rem;
      position: relative; cursor: pointer; color:#666;
    }
    .cal-cell.has-data { border: 1px solid var(--accent-color); color:#fff; }
    .cal-dot { width: 4px; height: 4px; background: #fff; border-radius: 50%; position: absolute; bottom: 3px; }

    .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
    .grid-photo { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px; cursor: pointer; }
    
    .streak-container { 
      text-align: center; margin-bottom: 15px; 
      background: rgba(123, 92, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
    }
    .streak-row { display: flex; justify-content: center; align-items: center; gap: 20px; }
    .streak-item { text-align: center; }
    .streak-label { font-size: 0.8rem; color: #999; margin-bottom: 5px; }
    .streak-num { font-size: 1.5rem; font-weight: bold; color: var(--accent-color); }
    .streak-num.record-breaking { 
      color: var(--gold); 
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .date-selector { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    .date-selector button { width: auto; padding: 8px 15px; }
    .date-selector select { width: auto; margin: 0 5px; }

    .year-month-selector { display: flex; gap: 10px; margin-bottom: 15px; }
    .year-month-selector select { flex: 1; }

    .photo-sort-controls { display: flex; gap: 5px; margin-bottom: 10px; }
    .photo-sort-btn { padding: 5px 10px; font-size: 0.75rem; width: auto; }
  </style>
</head>
<body>

<header>
  <div class="app-title">Diary</div>
  <div class="header-icons">
    <span onclick="showRandomDiary()">ğŸ’¡</span>
    <span onclick="openSettings()">âš™ï¸</span>
  </div>
</header>

<div id="main-container">

  <div id="tab-record" class="tab-content active">
    <div class="card">
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button id="btn-today" onclick="setDateMode('today')" class="active">ä»Šæ—¥</button>
        <button id="btn-yesterday" onclick="setDateMode('yesterday')" class="secondary">æ˜¨æ—¥</button>
      </div>
      <div id="current-date-display" style="text-align:right; font-size:0.9rem; margin-bottom:10px; color:#888;"></div>
      
      <div class="streak-container">
        <div class="streak-row">
          <div class="streak-item">
            <div class="streak-label">é€£ç¶šè¨˜éŒ²</div>
            <div id="streak-count" class="streak-num">--</div>
          </div>
          <div class="streak-item">
            <div class="streak-label">æœ€é•·è¨˜éŒ²</div>
            <div id="max-streak-count" class="streak-num">--</div>
          </div>
        </div>
      </div>

      <h3>æ°—åˆ†: <span id="emotion-val">3</span></h3>
      <div class="slider-container">
        <span>1</span>
        <input type="range" id="emotion-input" min="1" max="5" value="3" oninput="updateEmotionDisplay()">
        <span>5</span>
      </div>

      <h3>å­¦ç¿’æ™‚é–“ (åˆ†)</h3>
      <div style="display:flex; gap:10px;">
        <input type="number" id="study-time" value="0">
        <input type="number" id="study-add" placeholder="+è¿½åŠ " style="width:80px;">
      </div>

      <h3>æœ¬æ–‡</h3>
      <textarea id="diary-content" placeholder="è¨˜éŒ²..."></textarea>

      <h3>è‡ªå·±å«Œæ‚ª</h3>
      <textarea id="self-hate" placeholder="åãå‡ºã—..." style="height: 80px;"></textarea>

      <h3>å†™çœŸ (1æš)</h3>
      <div class="photo-area" id="photo-drop-area">
        <span id="photo-placeholder">ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸æŠ</span>
        <img id="photo-preview-img" class="photo-preview">
        <input type="file" id="photo-input" accept="image/*" style="display:none" onchange="handlePhotoSelect(this)">
        <div class="photo-btn-group" id="photo-controls" style="display:none;">
          <button class="mini-btn danger" onclick="removePhoto(event)">å‰Šé™¤</button>
        </div>
      </div>

      <button onclick="preSaveCheck()">ä¿å­˜</button>
    </div>
  </div>

  <div id="tab-study" class="tab-content">
    <div class="card">
      <div class="year-month-selector">
        <select id="study-year-select" onchange="loadStudyData()"></select>
        <select id="study-month-select" onchange="loadStudyData()"></select>
      </div>

      <h3>ä»Šæœˆã®ç›®æ¨™é”æˆåº¦</h3>
      <div class="pie-container">
        <canvas id="goalChart"></canvas>
        <div class="pie-center-text" id="goal-percent">0%</div>
      </div>
      <div style="text-align:center; font-size:0.9rem;">
        ç›®æ¨™: <span id="goal-val">0</span>åˆ† / å®Ÿç¸¾: <span id="current-val">0</span>åˆ†
      </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:center; gap:10px; margin-bottom:10px;">
        <button id="btn-chart-daily" class="mini-btn active" onclick="switchChart('daily')">æ—¥åˆ¥</button>
        <button id="btn-chart-monthly" class="mini-btn secondary" onclick="switchChart('monthly')">æœˆåˆ¥</button>
      </div>
      <canvas id="studyBarChart" style="height:250px;"></canvas>
    </div>
  </div>

  <div id="tab-history" class="tab-content">
    <div class="card">
      <div class="date-selector">
        <button onclick="changeHistoryMonth(-1)">â—€</button>
        <div>
          <select id="history-year-select" onchange="loadHistoryData()"></select>
          <select id="history-month-select" onchange="loadHistoryData()"></select>
        </div>
        <button onclick="changeHistoryMonth(1)">â–¶</button>
      </div>
    </div>

    <div style="display:flex; overflow-x:auto; gap:5px; margin-bottom:10px; padding-bottom:5px;">
      <button id="hist-btn-list" class="mini-btn secondary active" onclick="setHistoryMode('list')">ãƒªã‚¹ãƒˆ</button>
      <button id="hist-btn-calendar" class="mini-btn secondary" onclick="setHistoryMode('calendar')">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
      <button id="hist-btn-emotion" class="mini-btn secondary" onclick="setHistoryMode('emotion')">æ°—åˆ†</button>
      <button id="hist-btn-photo" class="mini-btn secondary" onclick="setHistoryMode('photo')">å†™çœŸ</button>
    </div>
    
    <div id="photo-sort-container" class="photo-sort-controls" style="display:none;">
      <button id="sort-newest" class="photo-sort-btn secondary active" onclick="setPhotoSort('newest')">æ–°ã—ã„é †</button>
      <button id="sort-oldest" class="photo-sort-btn secondary" onclick="setPhotoSort('oldest')">å¤ã„é †</button>
      <button id="sort-random" class="photo-sort-btn secondary" onclick="setPhotoSort('random')">ãƒ©ãƒ³ãƒ€ãƒ </button>
    </div>
    
    <div id="history-view-container" class="card" style="min-height:300px;"></div>
  </div>

  <div id="tab-memo" class="tab-content">
    <div class="memo-tabs">
      <div class="memo-tab active" onclick="switchMemo(1)">1</div>
      <div class="memo-tab" onclick="switchMemo(2)">2</div>
      <div class="memo-tab" onclick="switchMemo(3)">3</div>
      <div class="memo-tab" onclick="switchMemo(4)">4</div>
      <div class="memo-tab" onclick="switchMemo(5)">5</div>
    </div>
    <textarea id="memo-area" oninput="debounceMemoSave()" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
    <div id="memo-status" style="text-align:right; font-size:0.8rem; color:#888; height:1rem;"></div>
  </div>

</div>

<div class="bottom-nav">
  <div class="nav-item active" onclick="switchTab('record')">è¨˜éŒ²</div>
  <div class="nav-item" onclick="switchTab('study')">å­¦ç¿’</div>
  <div class="nav-item" onclick="switchTab('history')">å±¥æ­´</div>
  <div class="nav-item" onclick="switchTab('memo')">ãƒ¡ãƒ¢</div>
</div>

<div id="loading-overlay">
  <div class="wave-container">
    <div class="wave-bar"></div>
    <div class="wave-bar"></div>
    <div class="wave-bar"></div>
    <div class="wave-bar"></div>
    <div class="wave-bar"></div>
  </div>
  <div id="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...</div>
</div>

<div id="notification">ä¿å­˜ã—ã¾ã—ãŸ</div>

<div id="dialog-modal" class="modal">
  <div class="modal-content" style="max-width:320px;">
    <h3 id="dialog-title">ç¢ºèª</h3>
    <div class="modal-body">
      <p id="dialog-message">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
    </div>
    <div class="modal-actions" style="justify-content: flex-end; gap:10px;">
      <div id="dialog-actions" style="display:flex; gap:10px; width:100%; justify-content:flex-end;"></div>
    </div>
  </div>
</div>

<div id="confirm-delete-modal" class="modal">
  <div class="modal-content" style="max-width:320px;">
    <h3>å‰Šé™¤ç¢ºèª</h3>
    <div class="modal-body">
      <p id="confirm-delete-message">æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
    </div>
    <div class="modal-actions" style="justify-content: flex-end; gap:10px;">
      <button class="secondary" onclick="closeConfirmDelete()" style="width:auto;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="danger" onclick="executeDelete()" style="width:auto;">å‰Šé™¤ã™ã‚‹</button>
    </div>
  </div>
</div>

<div id="settings-modal" class="modal">
  <div class="modal-content">
    <h3>è¨­å®š</h3>
    <div class="modal-body">
      <p>ä»Šæœˆã®ç›®æ¨™å­¦ç¿’æ™‚é–“(åˆ†)</p>
      <input type="number" id="setting-goal" placeholder="ä¾‹: 3000">
      <p style="font-size:0.8rem; color:#aaa;">
        å…ˆæœˆã®ç·å‹‰å¼·æ™‚é–“: <span id="prev-month-total">--</span>åˆ†<br>
        1æ—¥ã®ç›®å®‰: <span id="daily-guideline">--</span>åˆ†
      </p>
    </div>
    <div class="modal-actions" style="justify-content: flex-end; gap:10px;">
      <button class="secondary" onclick="closeSettings()" style="width:auto;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button onclick="saveSettings()" style="width:auto;">ä¿å­˜</button>
    </div>
  </div>
</div>

<div id="detail-modal" class="modal">
  <div class="modal-content">
    <h3 id="detail-date">YYYY/MM/DD</h3>
    <div class="modal-body">
      <p>æ°—åˆ†: <span id="detail-emotion"></span> / å­¦ç¿’: <span id="detail-study"></span>åˆ†</p>
      <div id="detail-photo-container" style="margin-bottom:10px;"></div>
      <div id="detail-content" style="white-space: pre-wrap; background:#333; padding:10px; border-radius:8px; font-size:0.95rem;"></div>
    </div>
    <div class="modal-actions">
      <button id="btn-delete-diary" class="btn-icon-subtle" onclick="confirmDelete()">ğŸ—‘ï¸</button>
      <div class="modal-actions-right">
        <button class="secondary" onclick="closeDetail()" style="width:auto;">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<script>
  let currentTab = 'record';
  let recordDate = new Date();
  let memoData = {};
  let currentMemoIdx = 1;
  let chartInstances = {};
  let currentHistory = [];
  let currentGoal = 0;
  let currentDetailItem = null;
  let currentStudyYear = new Date().getFullYear();
  let currentStudyMonth = ("0" + (new Date().getMonth() + 1)).slice(-2);
  let currentHistoryYear = new Date().getFullYear();
  let currentHistoryMonth = ("0" + (new Date().getMonth() + 1)).slice(-2);
  let currentChartMode = 'daily';
  let currentPhotoSort = 'newest';
  let pendingDeleteItem = null;

  const loadingMessages = [
    "ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...",
    "ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ§‹ç¯‰ä¸­...",
    "æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...",
    "ç”»åƒã‚’è§£æã—ã¦ã„ã¾ã™...",
    "ã‚µãƒ¼ãƒãƒ¼ã¨é€šä¿¡ä¸­...",
    "ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¦ã„ã¾ã™...",
    "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°ä¸­..."
  ];

  window.onload = function() {
    initRecordTab();
    loadMemoData();
    fetchStartupData();
    initYearMonthSelectors();
    checkMonthGoalRequired();
  };

  function showLoading(text) {
    let display = text;
    if (!text || text === 'èª­ã¿è¾¼ã¿ä¸­...') {
      display = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
    }
    document.getElementById('loading-text').innerText = display;
    document.getElementById('loading-overlay').style.display = 'flex';
  }

  function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
  }

  function showNotification(msg) {
    const el = document.getElementById('notification');
    el.innerText = msg;
    el.style.top = '20px';
    setTimeout(() => { el.style.top = '-100px'; }, 3000);
  }
  
  function showDialog(title, msg, onConfirm, showCancel=true) {
    document.getElementById('dialog-title').innerText = title;
    document.getElementById('dialog-message').innerText = msg;
    const actions = document.getElementById('dialog-actions');
    actions.innerHTML = '';
    
    if(showCancel) {
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'secondary';
      cancelBtn.innerText = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
      cancelBtn.style.width = 'auto';
      cancelBtn.onclick = () => document.getElementById('dialog-modal').style.display = 'none';
      actions.appendChild(cancelBtn);
    }
    
    const confirmBtn = document.createElement('button');
    confirmBtn.innerText = 'OK';
    confirmBtn.style.width = 'auto';
    confirmBtn.onclick = () => {
      document.getElementById('dialog-modal').style.display = 'none';
      if(onConfirm) onConfirm();
    };
    actions.appendChild(confirmBtn);
    
    document.getElementById('dialog-modal').style.display = 'flex';
  }

  function checkMonthGoalRequired() {
    const now = new Date();
    if (now.getDate() <= 5) {
      showLoading('ç›®æ¨™è¨­å®šã‚’ç¢ºèªä¸­...');
      google.script.run.withSuccessHandler(goal => {
        hideLoading();
        if (goal === 0) {
          showDialog('æœˆåˆã®ç›®æ¨™è¨­å®š', 'ä»Šæœˆã®ç›®æ¨™å­¦ç¿’æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„', () => {
            openSettings();
          }, false);
        }
      }).withFailureHandler(err => {
        hideLoading();
      }).getMonthGoal(now.getFullYear(), ("0" + (now.getMonth() + 1)).slice(-2));
    }
  }

  function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    
    document.getElementById('tab-' + tabName).classList.add('active');
    document.querySelectorAll('.nav-item')[['record','study','history','memo'].indexOf(tabName)].classList.add('active');
    
    currentTab = tabName;
    
    if(tabName === 'study') loadStudyData();
    if(tabName === 'history') loadHistoryData();
    if(tabName === 'memo') renderMemo();
  }

  function initRecordTab() {
    updateEmotionDisplay();
    document.getElementById('photo-drop-area').onclick = () => document.getElementById('photo-input').click();
    setDateMode('today');
  }

  function setDateMode(mode) {
    const today = new Date();
    if(mode === 'today') {
      recordDate = today;
      document.getElementById('btn-today').className = 'active';
      document.getElementById('btn-yesterday').className = 'secondary';
    } else {
      recordDate = new Date(today);
      recordDate.setDate(today.getDate() - 1);
      document.getElementById('btn-today').className = 'secondary';
      document.getElementById('btn-yesterday').className = 'active';
    }
    
    const y = recordDate.getFullYear();
    const m = ("0"+(recordDate.getMonth()+1)).slice(-2);
    const d = ("0"+recordDate.getDate()).slice(-2);
    document.getElementById('current-date-display').innerText = `${y}/${m}/${d}`;
    loadDiaryForDate(y, m, d);
  }

  function updateEmotionDisplay() {
    document.getElementById('emotion-val').innerText = document.getElementById('emotion-input').value;
  }

  function handlePhotoSelect(input) {
    if(input.files && input.files[0]) {
      const file = input.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          if (width > height) {
            if (width > 800) { height *= 800 / width; width = 800; }
          } else {
            if (height > 800) { width *= 800 / height; height = 800; }
          }
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          const dataUrl = canvas.toDataURL('image/png', 0.8);
          document.getElementById('photo-preview-img').src = dataUrl;
          document.getElementById('photo-preview-img').style.display = 'block';
          document.getElementById('photo-placeholder').style.display = 'none';
          document.getElementById('photo-controls').style.display = 'flex';
        };
        img.src = e.target.result;
      }
      reader.readAsDataURL(file);
    }
  }

  function removePhoto(e) {
    e.stopPropagation();
    document.getElementById('photo-input').value = "";
    document.getElementById('photo-preview-img').src = "";
    document.getElementById('photo-preview-img').style.display = 'none';
    document.getElementById('photo-placeholder').style.display = 'block';
    document.getElementById('photo-controls').style.display = 'none';
  }

  function loadDiaryForDate(y, m, d) {
    showLoading('æ—¥è¨˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...'); 
    google.script.run.withSuccessHandler(res => {
      hideLoading();
      if(res.exists) {
        const data = res.data;
        document.getElementById('emotion-input').value = data.emotion;
        updateEmotionDisplay();
        document.getElementById('study-time').value = data.studyTime;
        document.getElementById('diary-content').value = data.content || "";
        document.getElementById('self-hate').value = data.hateMyself || "";
        
        if(res.image) {
          document.getElementById('photo-preview-img').src = res.image;
          document.getElementById('photo-preview-img').style.display = 'block';
          document.getElementById('photo-placeholder').style.display = 'none';
          document.getElementById('photo-controls').style.display = 'flex';
        } else {
          removePhoto({stopPropagation:()=>{}}); 
        }
      } else {
        document.getElementById('emotion-input').value = 3;
        updateEmotionDisplay();
        document.getElementById('study-time').value = 0;
        document.getElementById('diary-content').value = "";
        document.getElementById('self-hate').value = "";
        removePhoto({stopPropagation:()=>{}});
      }
    }).withFailureHandler(err => {
      hideLoading();
      showNotification('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
    }).getDiaryData(y, m, d);
  }

  function preSaveCheck() {
    const y = recordDate.getFullYear();
    const m = ("0"+(recordDate.getMonth()+1)).slice(-2);
    const d = ("0"+recordDate.getDate()).slice(-2);

    showLoading('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªä¸­...');
    google.script.run.withSuccessHandler(exists => {
      hideLoading();
      if(exists) {
        showDialog('ä¸Šæ›¸ãç¢ºèª', 'ã“ã®æ—¥ã®è¨˜éŒ²ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹?', () => {
          doSave(y, m, d);
        });
      } else {
        doSave(y, m, d);
      }
    }).withFailureHandler(err => {
      hideLoading();
      doSave(y, m, d);
    }).checkDiaryExists(y, m, d);
  }

  function doSave(y, m, d) {
    showLoading('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­...');
    
    let baseTime = parseInt(document.getElementById('study-time').value) || 0;
    let addTime = parseInt(document.getElementById('study-add').value) || 0;
    let totalTime = baseTime + addTime;
    
    const photoImg = document.getElementById('photo-preview-img');
    const hasPhoto = photoImg.style.display === 'block';
    
    const now = new Date();
    const timeStr = ("0" + now.getHours()).slice(-2) + ":" + ("0" + now.getMinutes()).slice(-2);
    
    const data = {
      year: y, 
      month: m, 
      day: d,
      time: timeStr,
      emotion: parseInt(document.getElementById('emotion-input').value),
      studyTime: totalTime,
      content: document.getElementById('diary-content').value,
      hateMyself: document.getElementById('self-hate').value,
      photo: hasPhoto,
      ver: 1.1
    };

    const imageBase64 = hasPhoto ? photoImg.src : null;

    google.script.run.withSuccessHandler(() => {
      hideLoading();
      showNotification('ä¿å­˜ã—ã¾ã—ãŸ');
      document.getElementById('study-time').value = totalTime;
      document.getElementById('study-add').value = "";
      
      if(Math.random() < 0.15) {
        setTimeout(() => showRandomDiary(), 500);
      }
      fetchStartupData(); 

    }).withFailureHandler(err => {
      hideLoading();
      showNotification('ä¿å­˜ã‚¨ãƒ©ãƒ¼');
    }).saveDiary(data, imageBase64);
  }

  function fetchStartupData() {
    const today = new Date();
    const y = today.getFullYear();
    const m = ("0"+(today.getMonth()+1)).slice(-2);
    const d = ("0"+today.getDate()).slice(-2);
    
    google.script.run.withSuccessHandler(streakData => {
      document.getElementById('streak-count').innerText = streakData.current;
      document.getElementById('max-streak-count').innerText = streakData.max;
      
      const currentEl = document.getElementById('streak-count');
      if (streakData.isRecordBreaking) {
        currentEl.classList.add('record-breaking');
      } else {
        currentEl.classList.remove('record-breaking');
      }
    }).withFailureHandler(err => {
      document.getElementById('streak-count').innerText = '0';
      document.getElementById('max-streak-count').innerText = '0';
    }).calculateStreakData(y, m, d);
  }

  function initYearMonthSelectors() {
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    
    const studyYearSelect = document.getElementById('study-year-select');
    const studyMonthSelect = document.getElementById('study-month-select');
    const historyYearSelect = document.getElementById('history-year-select');
    const historyMonthSelect = document.getElementById('history-month-select');
    
    for (let y = currentYear; y >= currentYear - 10; y--) {
      const opt1 = document.createElement('option');
      opt1.value = y;
      opt1.innerText = y + 'å¹´';
      studyYearSelect.appendChild(opt1);
      
      const opt2 = document.createElement('option');
      opt2.value = y;
      opt2.innerText = y + 'å¹´';
      historyYearSelect.appendChild(opt2);
    }
    
    for (let m = 1; m <= 12; m++) {
      const mStr = ("0" + m).slice(-2);
      const opt1 = document.createElement('option');
      opt1.value = mStr;
      opt1.innerText = m + 'æœˆ';
      studyMonthSelect.appendChild(opt1);
      
      const opt2 = document.createElement('option');
      opt2.value = mStr;
      opt2.innerText = m + 'æœˆ';
      historyMonthSelect.appendChild(opt2);
    }
    
    studyYearSelect.value = currentYear;
    studyMonthSelect.value = ("0" + currentMonth).slice(-2);
    historyYearSelect.value = currentYear;
    historyMonthSelect.value = ("0" + currentMonth).slice(-2);
    
    currentStudyYear = currentYear;
    currentStudyMonth = ("0" + currentMonth).slice(-2);
    currentHistoryYear = currentYear;
    currentHistoryMonth = ("0" + currentMonth).slice(-2);
  }

  function loadStudyData() {
    showLoading('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
    
    currentStudyYear = document.getElementById('study-year-select').value;
    currentStudyMonth = document.getElementById('study-month-select').value;
    
    if (currentChartMode === 'daily') {
      google.script.run.withSuccessHandler(res => {
        hideLoading();
        renderPieChart(res.totalStudyTime, res.goal);
        renderDailyBarChart(res.dailyData, currentStudyYear, currentStudyMonth);
      }).withFailureHandler(err => {
        hideLoading();
        showNotification('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
      }).getMonthStudyData(currentStudyYear, currentStudyMonth);
    } else {
      google.script.run.withSuccessHandler(res => {
        hideLoading();
        let yearTotal = 0;
        for (let m in res.monthlyData) {
          yearTotal += res.monthlyData[m];
        }
        
        google.script.run.withSuccessHandler(yearGoal => {
          renderPieChart(yearTotal, yearGoal);
          renderMonthlyBarChart(res.monthlyData, currentStudyYear);
        }).withFailureHandler(err => {
          renderPieChart(yearTotal, 0);
          renderMonthlyBarChart(res.monthlyData, currentStudyYear);
        }).getMonthGoal(currentStudyYear, currentStudyMonth);
        
      }).withFailureHandler(err => {
        hideLoading();
        showNotification('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
      }).getYearStudyData(currentStudyYear);
    }
  }

  function renderPieChart(current, goal) {
    currentGoal = goal;
    document.getElementById('current-val').innerText = current;
    document.getElementById('goal-val').innerText = goal;
    
    const percent = goal > 0 ? Math.round((current / goal) * 100) : 0;
    document.getElementById('goal-percent').innerText = percent + "%";

    const ctx = document.getElementById('goalChart').getContext('2d');
    if(chartInstances.pie) chartInstances.pie.destroy();
    
    chartInstances.pie = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['å®Ÿç¸¾', 'æ®‹ã‚Š'],
        datasets: [{
          data: [current, Math.max(0, goal - current)],
          backgroundColor: ['#7b5cff', '#333'],
          borderWidth: 0
        }]
      },
      options: { cutout: '80%', plugins: { legend: { display: false } } }
    });
  }

  function renderDailyBarChart(dailyData, y, m) {
    const daysInMonth = new Date(y, m, 0).getDate();
    const labels = [];
    const data = [];
    let sum = 0;
    
    for(let i=1; i<=daysInMonth; i++) {
      labels.push(i);
      const val = dailyData[i] || 0;
      data.push(val);
      sum += val;
    }
    const avg = sum / daysInMonth;

    const ctx = document.getElementById('studyBarChart').getContext('2d');
    if(chartInstances.bar) chartInstances.bar.destroy();

    chartInstances.bar = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            type: 'bar',
            label: 'å­¦ç¿’æ™‚é–“',
            data: data,
            backgroundColor: '#7b5cff',
            borderRadius: 3
          },
          {
            type: 'line',
            label: 'å¹³å‡',
            data: Array(daysInMonth).fill(avg),
            borderColor: '#ff4d4d',
            borderWidth: 1,
            pointRadius: 0
          }
        ]
      },
      options: {
        scales: {
          x: { grid: { color: '#333' } },
          y: { grid: { color: '#333' } }
        },
        plugins: {
          tooltip: {
             callbacks: {
               label: function(context) { return context.raw + ' åˆ†'; }
             }
          }
        }
      }
    });
  }

  function renderMonthlyBarChart(monthlyData, year) {
    const labels = Array.from({length:12}, (_, i) => i + 1);
    const data = labels.map(m => monthlyData[m] || 0);
    
    const ctx = document.getElementById('studyBarChart').getContext('2d');
    if(chartInstances.bar) chartInstances.bar.destroy();
    
    chartInstances.bar = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'æœˆåˆ¥å­¦ç¿’æ™‚é–“',
          data: data,
          backgroundColor: '#7b5cff',
          borderRadius: 3
        }]
      },
      options: { 
        scales: { 
          x: { grid: { color:'#333'}}, 
          y: { grid: { color:'#333'}}
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) { return context.raw + ' åˆ†'; }
            }
          }
        }
      }
    });
  }

  function switchChart(type) {
    currentChartMode = type;
    
    document.getElementById('btn-chart-daily').className = type === 'daily' ? 'mini-btn active' : 'mini-btn secondary';
    document.getElementById('btn-chart-monthly').className = type === 'monthly' ? 'mini-btn active' : 'mini-btn secondary';
    
    loadStudyData();
  }

  function loadHistoryData() {
    showLoading('å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
    
    currentHistoryYear = document.getElementById('history-year-select').value;
    currentHistoryMonth = document.getElementById('history-month-select').value;
    
    google.script.run.withSuccessHandler(list => {
      hideLoading();
      currentHistory = list.filter(item => item && item.day && item.content !== undefined);
      setHistoryMode('list');
    }).withFailureHandler(err => {
      hideLoading();
      currentHistory = [];
      setHistoryMode('list');
    }).getHistoryList(currentHistoryYear, currentHistoryMonth);
  }

  function changeHistoryMonth(direction) {
    let year = parseInt(currentHistoryYear);
    let month = parseInt(currentHistoryMonth);
    
    month += direction;
    
    if (month > 12) {
      month = 1;
      year++;
    } else if (month < 1) {
      month = 12;
      year--;
    }
    
    currentHistoryYear = year;
    currentHistoryMonth = ("0" + month).slice(-2);
    
    document.getElementById('history-year-select').value = year;
    document.getElementById('history-month-select').value = ("0" + month).slice(-2);
    
    loadHistoryData();
  }

  function setHistoryMode(mode) {
    const btns = {
      'list': 'hist-btn-list',
      'calendar': 'hist-btn-calendar',
      'emotion': 'hist-btn-emotion',
      'photo': 'hist-btn-photo'
    };
    
    Object.values(btns).forEach(id => {
      const btn = document.getElementById(id);
      btn.classList.remove('active');
    });
    document.getElementById(btns[mode]).classList.add('active');

    const sortContainer = document.getElementById('photo-sort-container');
    if (mode === 'photo') {
      sortContainer.style.display = 'flex';
    } else {
      sortContainer.style.display = 'none';
    }

    const container = document.getElementById('history-view-container');
    container.innerHTML = '';
    
    if (mode === 'list') {
      if (currentHistory.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#666;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }
      
      currentHistory.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-list-item';
        
        const contentPreview = item.content ? item.content.substring(0, 30) + (item.content.length > 30 ? '...' : '') : '(æœ¬æ–‡ãªã—)';
        
        div.innerHTML = `
          <div>
            <div class="history-meta">${item.day}æ—¥<span class="history-weekday">(${item.weekday})</span></div>
            <div class="history-preview">${contentPreview}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:0.75rem; color:#666;">${item.updateDay}æ—¥ ${item.time}</div>
            <div style="margin-top:3px;">${item.hasPhoto ? 'ğŸ“·' : ''}</div>
          </div>
        `;
        div.onclick = () => openDetail(item);
        container.appendChild(div);
      });
    } else if (mode === 'calendar') {
      const grid = document.createElement('div');
      grid.className = 'calendar-grid';
      for(let i=1; i<=31; i++) {
        const item = currentHistory.find(h => parseInt(h.day) === i);
        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        cell.innerText = i;
        if(item) {
          cell.classList.add('has-data');
          const opacity = Math.min(1, Math.max(0.2, item.studyTime / 180));
          cell.style.backgroundColor = `rgba(123, 92, 255, ${opacity})`;
          if(item.hasPhoto) {
            const dot = document.createElement('div');
            dot.className = 'cal-dot';
            cell.appendChild(dot);
          }
          cell.onclick = () => openDetail(item);
        }
        grid.appendChild(cell);
      }
      container.appendChild(grid);
    } else if (mode === 'emotion') {
      if (currentHistory.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#666;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }
      
      const canvas = document.createElement('canvas');
      container.appendChild(canvas);
      const sorted = [...currentHistory].sort((a,b) => parseInt(a.day) - parseInt(b.day));
      
      new Chart(canvas, {
        type: 'line',
        data: {
          labels: sorted.map(i => i.day + 'æ—¥'),
          datasets: [{
            label: 'æ°—åˆ†',
            data: sorted.map(i => i.emotion),
            borderColor: '#7b5cff',
            backgroundColor: 'rgba(123, 92, 255, 0.1)',
            tension: 0.2,
            fill: true
          }]
        },
        options: {
          scales: { 
            y: { min: 1, max: 5, grid: {color:'#333'} }, 
            x: { grid: {color:'#333'} } 
          },
          onClick: (e, els) => {
            if(els.length > 0) {
              const idx = els[0].index;
              openDetail(sorted[idx]);
            }
          }
        }
      });
    } else if (mode === 'photo') {
      renderPhotoMode();
    }
  }

  function setPhotoSort(sortType) {
    currentPhotoSort = sortType;
    
    document.getElementById('sort-newest').className = sortType === 'newest' ? 'photo-sort-btn secondary active' : 'photo-sort-btn secondary';
    document.getElementById('sort-oldest').className = sortType === 'oldest' ? 'photo-sort-btn secondary active' : 'photo-sort-btn secondary';
    document.getElementById('sort-random').className = sortType === 'random' ? 'photo-sort-btn secondary active' : 'photo-sort-btn secondary';
    
    renderPhotoMode();
  }

  function renderPhotoMode() {
    const container = document.getElementById('history-view-container');
    container.innerHTML = '';
    
    let photoItems = currentHistory.filter(h => h.hasPhoto);
    
    if (photoItems.length === 0) {
      container.innerHTML = '<p style="text-align:center; color:#666;">å†™çœŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
      return;
    }
    
    if (currentPhotoSort === 'newest') {
      photoItems.sort((a, b) => parseInt(b.day) - parseInt(a.day));
    } else if (currentPhotoSort === 'oldest') {
      photoItems.sort((a, b) => parseInt(a.day) - parseInt(b.day));
    } else if (currentPhotoSort === 'random') {
      photoItems = photoItems.sort(() => Math.random() - 0.5);
    }
    
    const grid = document.createElement('div');
    grid.className = 'photo-grid';
    
    photoItems.forEach(item => {
      const img = document.createElement('img');
      img.className = 'grid-photo';
      img.src = '';
      img.style.background = 'rgba(255,255,255,0.05)';
      
      google.script.run.withSuccessHandler(base64 => {
        if (base64) {
          img.src = base64;
        }
      }).withFailureHandler(err => {
        // Fail silently
      }).getImageById(item.imageId);
      
      img.onclick = () => openDetail(item);
      grid.appendChild(img);
    });
    container.appendChild(grid);
  }

  function loadMemoData() {
    showLoading('ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
    google.script.run.withSuccessHandler(data => {
      hideLoading();
      memoData = data;
      renderMemo();
    }).withFailureHandler(err => {
      hideLoading();
      memoData = { "1": "", "2": "", "3": "", "4": "", "5": "" };
      renderMemo();
    }).getMemoData();
  }

  function switchMemo(idx) {
    currentMemoIdx = idx;
    document.querySelectorAll('.memo-tab').forEach((el, i) => {
      if(i+1 === idx) el.classList.add('active');
      else el.classList.remove('active');
    });
    renderMemo();
  }

  function renderMemo() {
    showLoading('ãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã¿ä¸­...');
    const area = document.getElementById('memo-area');
    area.value = memoData[currentMemoIdx] || "";
    area.style.opacity = 0.5;
    setTimeout(() => {
      area.style.opacity = 1;
      hideLoading();
    }, 150);
  }

  let memoTimeout;
  function debounceMemoSave() {
    document.getElementById('memo-status').innerText = "å…¥åŠ›ä¸­...";
    clearTimeout(memoTimeout);
    memoTimeout = setTimeout(() => {
      memoData[currentMemoIdx] = document.getElementById('memo-area').value;
      google.script.run.withSuccessHandler(() => {
        document.getElementById('memo-status').innerText = "ä¿å­˜å®Œäº†";
        setTimeout(() => {
          document.getElementById('memo-status').innerText = "";
        }, 2000);
      }).withFailureHandler(err => {
        document.getElementById('memo-status').innerText = "ä¿å­˜ã‚¨ãƒ©ãƒ¼";
      }).saveMemoData(memoData);
    }, 1500);
  }

  function openDetail(item, context = 'history') {
    currentDetailItem = item;
    const modal = document.getElementById('detail-modal');
    document.getElementById('detail-date').innerText = `${item.year}/${item.month}/${item.day} (${item.weekday || ''})`;
    document.getElementById('detail-emotion').innerText = item.emotion;
    document.getElementById('detail-study').innerText = item.studyTime;
    document.getElementById('detail-content').innerText = item.content || '(æœ¬æ–‡ãªã—)';
    
    const deleteBtn = document.getElementById('btn-delete-diary');
    if (context === 'random') {
      deleteBtn.style.display = 'none';
    } else {
      deleteBtn.style.display = 'block';
    }

    const photoContainer = document.getElementById('detail-photo-container');
    photoContainer.innerHTML = '';
    
    if (item.hasPhoto) {
       showLoading('ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å±•é–‹ä¸­...');
       if (item.imageId) {
         google.script.run.withSuccessHandler(base64 => {
           hideLoading();
           if (base64) {
             const img = document.createElement('img');
             img.src = base64;
             img.style.maxWidth = '100%';
             img.style.borderRadius = '8px';
             photoContainer.appendChild(img);
           }
         }).withFailureHandler(err => {
           hideLoading();
         }).getImageById(item.imageId);
       } else {
         google.script.run.withSuccessHandler(res => {
            hideLoading();
            if(res.image) {
               const img = document.createElement('img');
               img.src = res.image;
               img.style.maxWidth = '100%';
               img.style.borderRadius = '8px';
               photoContainer.appendChild(img);
            }
         }).withFailureHandler(err => {
           hideLoading();
         }).getDiaryData(item.year, item.month, item.day);
       }
    }

    modal.style.display = 'flex';
  }

  function closeDetail() {
    document.getElementById('detail-modal').style.display = 'none';
  }

  function confirmDelete() {
    if(!currentDetailItem) return;
    pendingDeleteItem = currentDetailItem;
    document.getElementById('confirm-delete-message').innerText = `${currentDetailItem.year}å¹´${currentDetailItem.month}æœˆ${currentDetailItem.day}æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚å…ƒã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚`;
    document.getElementById('confirm-delete-modal').style.display = 'flex';
  }

  function closeConfirmDelete() {
    document.getElementById('confirm-delete-modal').style.display = 'none';
    pendingDeleteItem = null;
  }

  function executeDelete() {
    if (!pendingDeleteItem) return;
    
    closeConfirmDelete();
    showLoading('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å‰Šé™¤ä¸­...');
    
    google.script.run.withSuccessHandler(() => {
      hideLoading();
      document.getElementById('detail-modal').style.display = 'none';
      showNotification('å‰Šé™¤å®Œäº†');
      if(currentTab === 'history') {
        setTimeout(() => loadHistoryData(), 500);
      }
      pendingDeleteItem = null;
    }).withFailureHandler(err => {
      hideLoading();
      showNotification('å‰Šé™¤ã‚¨ãƒ©ãƒ¼');
      pendingDeleteItem = null;
    }).deleteDiary(pendingDeleteItem.year, pendingDeleteItem.month, pendingDeleteItem.day);
  }

  function showRandomDiary() {
    showLoading('éå»ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ä¸­...');
    google.script.run.withSuccessHandler(res => {
      hideLoading();
      if(res && res.exists) {
        const item = {
          year: res.data.year,
          month: res.data.month,
          day: res.data.day,
          emotion: res.data.emotion,
          studyTime: res.data.studyTime,
          content: res.data.content,
          hasPhoto: !!res.image,
          imageId: null
        };
        openDetail(item, 'random');
        
        if(res.image) {
          const c = document.getElementById('detail-photo-container');
          c.innerHTML = '';
          const img = document.createElement('img');
          img.src = res.image;
          img.style.maxWidth = '100%';
          img.style.borderRadius = '8px';
          c.appendChild(img);
        }
      } else {
        showDialog('é€šçŸ¥', 'éå»ã®æ—¥è¨˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', null, false);
      }
    }).withFailureHandler(err => {
      hideLoading();
      showDialog('é€šçŸ¥', 'éå»ã®æ—¥è¨˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', null, false);
    }).getRandomDiaryData();
  }

  function openSettings() {
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = ("0" + (now.getMonth() + 1)).slice(-2);
    
    showLoading('è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
    google.script.run.withSuccessHandler(goal => {
      hideLoading();
      
      if (goal > 0) {
        document.getElementById('setting-goal').value = goal;
        const lastDay = new Date(currentYear, now.getMonth() + 1, 0).getDate();
        if (now.getDate() >= lastDay - 2) {
          document.getElementById('setting-goal').disabled = false;
        } else {
          document.getElementById('setting-goal').disabled = true;
        }
      } else {
        document.getElementById('setting-goal').disabled = false;
        document.getElementById('setting-goal').value = "";
      }
      
      google.script.run.withSuccessHandler(total => {
        document.getElementById('prev-month-total').innerText = total;
        const daysInMonth = new Date(currentYear, now.getMonth() + 1, 0).getDate();
        const isAfternoon = now.getHours() >= 12;
        const remain = isAfternoon ? (daysInMonth - now.getDate()) : (daysInMonth - now.getDate() + 1);
        
        const input = document.getElementById('setting-goal');
        input.oninput = () => {
           const val = parseInt(input.value) || 0;
           const currentStudy = parseInt(document.getElementById('current-val').innerText) || 0;
           const daily = remain > 0 ? Math.round((val - currentStudy) / remain) : 0;
           document.getElementById('daily-guideline').innerText = daily > 0 ? daily : 0;
        };
        
        if (goal > 0) {
          const currentStudy = parseInt(document.getElementById('current-val').innerText) || 0;
          const daily = remain > 0 ? Math.round((goal - currentStudy) / remain) : 0;
          document.getElementById('daily-guideline').innerText = daily > 0 ? daily : 0;
        }
      }).withFailureHandler(err => {
        document.getElementById('prev-month-total').innerText = '0';
      }).getLastMonthTotalTime();
      
      document.getElementById('settings-modal').style.display = 'flex';
    }).withFailureHandler(err => {
      hideLoading();
      document.getElementById('setting-goal').disabled = false;
      document.getElementById('setting-goal').value = "";
      document.getElementById('settings-modal').style.display = 'flex';
    }).getMonthGoal(currentYear, currentMonth);
  }

  function closeSettings() {
    document.getElementById('settings-modal').style.display = 'none';
  }

  function saveSettings() {
    const val = document.getElementById('setting-goal').value;
    if(!val || parseInt(val) <= 0) {
      showDialog('ã‚¨ãƒ©ãƒ¼', 'æœ‰åŠ¹ãªç›®æ¨™æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', null, false);
      return;
    }
    
    showLoading('è¨­å®šã‚’ä¿å­˜ä¸­...');
    const now = new Date();
    const year = now.getFullYear();
    const month = ("0" + (now.getMonth() + 1)).slice(-2);
    
    google.script.run.withSuccessHandler(() => {
      hideLoading();
      closeSettings();
      showNotification('è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      if(currentTab === 'study') {
        setTimeout(() => loadStudyData(), 500);
      }
    }).withFailureHandler(err => {
      hideLoading();
      showNotification('ä¿å­˜ã‚¨ãƒ©ãƒ¼');
    }).saveMonthGoal(year, month, val);
  }

</script>
</body>
</html>
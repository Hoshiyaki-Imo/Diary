<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Growth Diary</title>
  <style>
    :root {
      --primary: #4caf50;
      --bg: #f8f9fa;
      --card: #ffffff;
      --text: #2d3436;
    }
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 15px;
      background: var(--bg);
      color: var(--text);
      font-size: 18px; /* 全体的に文字を大きく */
    }
    .container { max-width: 500px; margin: 0 auto; }
    h1 { text-align: center; font-size: 1.8rem; margin: 20px 0; }
    .card {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    label { display: block; font-weight: bold; margin: 15px 0 5px; font-size: 0.9rem; color: #636e72; }
    input, select, textarea {
      width: 100%;
      padding: 15px; /* タップしやすい大きさ */
      font-size: 18px;
      border: 2px solid #edf2f7;
      border-radius: 10px;
      box-sizing: border-box;
      background: #fdfdfd;
    }
    button {
      width: 100%;
      padding: 18px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: bold;
      margin-top: 20px;
      cursor: pointer;
    }
    /* 簡易グラフのスタイル */
    .chart-container {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 100px;
      margin-top: 10px;
      border-bottom: 2px solid #eee;
    }
    .bar {
      flex: 1;
      background: var(--primary);
      border-radius: 2px 2px 0 0;
      min-width: 8px;
    }
    #feedbackArea {
      display: none;
      background: #e3f2fd;
      border: none;
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .monthly-bar-bg { width: 100%; height: 12px; background: #eee; border-radius: 6px; overflow: hidden; margin: 10px 0; }
    #monthlyBar { height: 100%; background: var(--primary); width: 0; transition: width 0.8s ease; }
  </style>
</head>
<body>

<div class="container">
  <h1>My Growth</h1>

  <div class="card">
    <label>日付</label>
    <input type="date" id="date">

    <div style="display: flex; gap: 10px;">
      <div style="flex: 1;">
        <label>気分</label>
        <select id="emotion">
          <option value="普通" selected>普通</option>
          <option value="最高">最高</option>
          <option value="疲れた">疲れた</option>
        </select>
      </div>
      <div style="flex: 1;">
        <label>勉強（分）</label>
        <input type="number" id="studyTime" value="0" min="0">
      </div>
    </div>

    <label>今日の一言</label>
    <textarea id="diary" placeholder="書かなくてもOK"></textarea>

    <button onclick="save()" id="saveBtn">保存する</button>

    <div id="feedbackArea" class="card">
      <div id="streakMsg" style="font-weight:bold; color:#2e7d32;"></div>
      <div id="mysteryMsg" style="font-size:0.9rem; margin: 5px 0;"></div>
      <div id="pastReflect" style="font-size:0.85rem; color:#555; border-top:1px solid #ccc; margin-top:10px; padding-top:10px;"></div>
    </div>
  </div>

  <div class="card">
    <label>今月の学習記録（グラフ）</label>
    <div id="studyChart" class="chart-container"></div>
    <div id="monthlyText" style="text-align:right; font-size:0.8rem; margin-top:5px;"></div>
    <div class="monthly-bar-bg"><div id="monthlyBar"></div></div>
  </div>

  <button onclick="location.reload()" style="background:#636e72; font-size:0.9rem; padding:10px;">画面を更新</button>
</div>

<script>
window.onload = () => {
  document.getElementById("date").valueAsDate = new Date();
  loadStats();
};

function save() {
  const dateStr = document.getElementById("date").value;
  const text = document.getElementById("diary").value;
  const emotion = document.getElementById("emotion").value;
  const studyTime = document.getElementById("studyTime").value || 0;
  const btn = document.getElementById("saveBtn");

  btn.disabled = true;
  btn.textContent = "保存中...";

  google.script.run.withSuccessHandler(res => {
    btn.disabled = false;
    btn.textContent = "保存する";
    
    document.getElementById("feedbackArea").style.display = "block";
    document.getElementById("streakMsg").textContent = `${res.streak}日連続達成！`;
    document.getElementById("mysteryMsg").textContent = getMysteryMessage(res.streak);
    
    if (res.pastDiary) {
      document.getElementById("pastReflect").innerHTML = `<strong>1週間前の自分:</strong><br>${res.pastDiary.content.split('\n')[1] || '（文字なし）'}`;
    }
    
    loadStats(); // グラフとバーを更新
    alert("記録しました！");
  }).saveDiary(dateStr, text, emotion, studyTime);
}

function loadStats() {
  const d = new Date(document.getElementById("date").value);
  const y = d.getFullYear().toString();
  const m = (d.getMonth() + 1).toString().padStart(2, "0");

  // グラフデータ取得
  google.script.run.withSuccessHandler(data => {
    const chart = document.getElementById("studyChart");
    chart.innerHTML = "";
    const maxTime = Math.max(...data.map(d => d.time), 60); // 最低でも60分を基準に
    data.forEach(item => {
      const bar = document.createElement("div");
      bar.className = "bar";
      bar.style.height = `${(item.time / maxTime) * 100}%`;
      bar.title = `${item.day}日: ${item.time}分`;
      chart.appendChild(bar);
    });
  }).getStudyStats(y, m);

  // 記録日数バー取得
  google.script.run.withSuccessHandler(res => {
    const percent = (res.count / res.daysInMonth) * 100;
    document.getElementById("monthlyBar").style.width = percent + "%";
    document.getElementById("monthlyText").textContent = `${res.count} / ${res.daysInMonth}日達成`;
  }).getMonthlyStats(y, m);
}

function getMysteryMessage(streak) {
  const msgs = { 1:"一歩目！", 3:"三日坊主を卒業！", 7:"最高の1週間！", 30:"達人の領域です！" };
  return msgs[streak] || `${streak}日目。その調子です！`;
}
</script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Deep Mind Diary - Complete</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root { 
      --primary: #bb86fc; 
      --primary-variant: #3700b3;
      --bg: #f5f5f5; 
      --surface: #ffffff; 
      --on-surface: #333; 
      --border: #eee; 
      --text-sub: #888; 
      --streak-bg: rgba(187, 134, 252, 0.1);
      --streak-text: #bb86fc;
      --transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
    [data-theme="dark"] { 
      --primary: #cfa6ff; 
      --bg: #050505; /* æ¼†é»’ */
      --surface: #121212; 
      --on-surface: #e1e1e1; 
      --border: #222; 
      --text-sub: #777;
      --streak-bg: rgba(207, 166, 255, 0.1);
    }
    
    body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; background: var(--bg); color: var(--on-surface); transition: background 0.5s; line-height: 1.5; overflow-x: hidden; }
    
    /* æ”¹è‰¯ï¼šã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ç²’å­èƒŒæ™¯ */
    #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: var(--bg); }

    .container { max-width: 900px; margin: 0 auto; padding: 0 20px 60px; position: relative; z-index: 10; }
    
    .header { display: flex; justify-content: space-between; align-items: center; padding: 30px 0; }
    .header h1 { margin:0; font-size: 1.1rem; letter-spacing: 5px; opacity: 0.7; font-weight: 200; }
    .header-btns { display: flex; align-items: center; gap: 15px; }
    
    .tab-bar { 
      display: flex; background: var(--surface); border-radius: 50px; margin-bottom: 25px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 5px; border: 1px solid var(--border);
    }
    .tab { 
      flex: 1; text-align: center; padding: 14px; cursor: pointer; font-size: 0.9rem; 
      color: var(--text-sub); font-weight: bold; border-radius: 50px; transition: var(--transition);
    }
    .tab.active { color: #000; background: var(--primary); box-shadow: 0 5px 15px rgba(187,134,252,0.4); }
    
    .card { 
      background: var(--surface); padding: 25px; border-radius: 24px; 
      box-shadow: 0 15px 35px rgba(0,0,0,0.2); position: relative; overflow: hidden; 
      margin-bottom: 20px; border: 1px solid var(--border); backdrop-filter: blur(10px);
      animation: cardSlideUp 0.6s ease-out;
    }
    @keyframes cardSlideUp {
      from { opacity: 0; transform: translateY(25px); }
      to { opacity: 1; transform: translateY(0); }
    }

    label { display: block; font-size: 0.75rem; font-weight: bold; margin-bottom: 8px; color: var(--primary); letter-spacing: 1px; }
    input, select, textarea, button { 
      width: 100%; padding: 14px; font-size: 1rem; border-radius: 12px; border: 1px solid var(--border); 
      background: rgba(128,128,128,0.05); color: var(--on-surface); box-sizing: border-box; 
      margin-bottom: 18px; outline: none; transition: var(--transition);
    }
    input:focus, textarea:focus { border-color: var(--primary); background: rgba(187,134,252,0.05); }
    
    .btn { background: var(--primary); color: #000; font-weight: bold; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(187,134,252,0.4); }
    .btn:active { transform: scale(0.98); }
    .locked { opacity: 0.6; pointer-events: none; background: var(--border) !important; color: var(--text-sub) !important; }

    /* æ³¢å½¢ãƒ­ãƒ¼ãƒ€ãƒ¼ */
    #globalLoader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9000; justify-content: center; align-items: center; backdrop-filter: blur(10px); flex-direction: column; color: #fff; }
    .wave-container { display: flex; align-items: center; gap: 4px; height: 60px; }
    .wave-bar { width: 4px; height: 20px; background: var(--primary); border-radius: 4px; animation: wave 1.2s infinite ease-in-out; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; }
    @keyframes wave { 0%, 100% { height: 20px; transform: scaleY(1); } 50% { height: 60px; transform: scaleY(1.5); opacity: 0.5; } }

    .streak-badge { background: var(--streak-bg); color: var(--streak-text); padding: 10px 20px; border-radius: 50px; display: inline-flex; align-items: center; gap: 10px; font-weight: bold; font-size: 0.85rem; margin-bottom: 20px; border: 1px solid rgba(187, 134, 252, 0.3); }

    .memory-box { display: none; background: rgba(187, 134, 252, 0.05); border: 1px dashed var(--primary); padding: 20px; border-radius: 20px; margin-bottom: 20px; font-size: 0.9rem; position: relative; animation: fadeIn 0.5s; cursor: pointer; }
    .memory-box small { color: var(--primary); font-weight: bold; display: block; margin-bottom: 4px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .pie-container { display: flex; flex-direction: column; align-items: center; margin: 25px 0; }
    .pie-svg { width: 130px; height: 130px; transform: rotate(-90deg); }
    .pie-bg { fill: none; stroke: var(--border); stroke-width: 8; }
    .pie-val { fill: none; stroke: var(--primary); stroke-width: 8; stroke-linecap: round; transition: stroke-dasharray 1.2s ease; }
    .pie-text { text-align: center; margin-top: -75px; font-weight: bold; font-size: 1.2rem; margin-bottom: 55px; }

    .chart-wrapper { position: relative; padding-left: 40px; margin-bottom: 40px; margin-top: 15px; }
    .y-axis { position: absolute; left: 0; top: 0; bottom: 0; width: 40px; display: flex; flex-direction: column; justify-content: space-between; font-size: 0.65rem; color: var(--text-sub); text-align: right; padding-right: 8px; box-sizing: border-box; border-right: 1px solid var(--border); }
    .bar-frame { height: 120px; display: flex; align-items: flex-end; border-bottom: 2px solid var(--border); gap: 4px; position: relative; }
    .bar { flex: 1; background: var(--primary); border-radius: 4px 4px 0 0; position: relative; transition: height 1s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
    .bar:hover { filter: brightness(1.2); }
    .bar-tick { position: absolute; bottom: -25px; font-size: 0.55rem; color: var(--text-sub); transform: translateX(-50%); left: 50%; white-space: nowrap; }

    .tooltip { position: fixed; background: #333; color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; pointer-events: none; opacity: 0; z-index: 9500; transition: opacity 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 8000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
    .modal-card { background: var(--surface); padding: 30px; border-radius: 28px; width: 90%; max-width: 420px; border: 1px solid var(--border); }
    
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .cal-day { aspect-ratio: 1; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; background: var(--border); cursor: pointer; transition: 0.2s; }
    .cal-day.has-data { background: var(--primary); color: #000; font-weight: bold; box-shadow: 0 3px 8px rgba(187,134,252,0.3); }
  </style>
</head>
<body data-theme="dark">

<canvas id="bg-canvas"></canvas>

<div id="globalLoader">
  <div class="wave-container">
    <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
  </div>
  <div id="loaderText" style="margin-top:25px; font-size:0.8rem; letter-spacing:3px; font-weight:200;">SYNCING...</div>
</div>

<div id="chartTooltip" class="tooltip"></div>

<div class="container">
  <div class="header">
    <h1>MIND LOG</h1>
    <div class="header-btns">
      <button onclick="showRandomMemory()" style="border:none; background:none; cursor:pointer; font-size:1.3rem;" title="æ€ã„å‡ºã‚’è¦‹ã‚‹">ğŸ’¡</button>
      <button onclick="toggleTheme()" style="border:none; background:none; cursor:pointer; font-size:1.3rem;">ğŸŒ“</button>
      <button onclick="openSettings()" style="border:none; background:none; cursor:pointer; font-size:1.3rem;">âš™ï¸</button>
    </div>
  </div>

  <div class="tab-bar">
    <div class="tab active" id="tab-edit" onclick="showTab('edit')">è¨˜éŒ²</div>
    <div class="tab" id="tab-stats" onclick="showTab('stats')">å­¦ç¿’</div>
    <div class="tab" id="tab-view" onclick="showTab('view')">å±¥æ­´</div>
  </div>

  <div id="edit" class="content-section" style="display:block;">
    <div id="memoryBox" class="memory-box" onclick="this.style.display='none'"></div>
    
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div class="streak-badge">
        <span>âœ§</span>
        <span>è¨˜éŒ²ç¶™ç¶š: <span id="streakCount">0</span> æ—¥</span>
      </div>
      <div id="monthlyReviewBtn" style="display:none;">
        <button class="btn" style="padding:8px 16px; font-size:0.75rem; width:auto; background:rgba(187,134,252,0.15); border:1px solid var(--primary); color:var(--primary);" onclick="openMonthlyReview()">ä»Šæœˆã®ç·æ‹¬</button>
      </div>
    </div>

    <div id="monthlyGoalDisplay" class="card" style="padding:15px; margin-bottom:20px; text-align:center; background:rgba(187, 134, 252, 0.03);">
      <label style="margin-bottom:2px; font-size:0.65rem; letter-spacing:2px; opacity:0.8;">MONTHLY GOAL</label>
      <div id="goalText" style="font-weight:bold; font-size:1rem;">æœªè¨­å®š</div>
    </div>

    <div class="card">
      <label>æ—¥ä»˜</label><input type="date" id="date" onchange="autoLoadEntry()">
      
      <div style="display:flex; gap:12px;">
        <div style="flex:1"><label>æ°—åˆ†</label><select id="emotion"><option>æ™®é€š</option><option>æœ€é«˜</option><option>ç–²ã‚ŒãŸ</option><option>æ€’ã£ã¦ã‚‹</option><option>æ‚²ã—ã„</option><option>ã‚‚ã‚„ã‚‚ã‚„</option></select></div>
        <div style="flex:1">
          <label>å‹‰å¼·åˆè¨ˆ (åˆ†)</label>
          <input type="number" id="studyTime" value="0" readonly style="background:rgba(0,0,0,0.1); color:var(--text-sub);">
        </div>
        <div style="flex:0.8">
          <label>è¿½åŠ  (åˆ†)</label>
          <input type="number" id="addStudyTime" value="0" style="border:1px solid var(--primary);">
        </div>
      </div>

      <label>å†…å®¹</label><textarea id="diary" rows="8" placeholder="é™ã‹ã«ä»Šæ—¥ã‚’æŒ¯ã‚Šè¿”ã‚‹..."></textarea>
      
      <label>å†™çœŸ</label>
      <input type="file" id="imgInput" accept="image/*" onchange="handleImage(this)">
      <div id="imagePreviewContainer" style="display:none; margin-bottom:20px; border-radius:18px; overflow:hidden; border:1px solid var(--border);">
        <img id="imagePreview" style="width:100%; display:block;">
      </div>
      
      <button class="btn" onclick="checkOverwrite()" id="saveBtn">ã“ã®æ—¥ã‚’åˆ»ã‚€</button>
    </div>
  </div>

  <div id="stats" class="content-section" style="display:none">
    <div class="card">
      <div style="display:flex; gap:10px; margin-bottom:25px;">
        <select id="statYear" onchange="refreshStats()"></select>
        <select id="statMonth" onchange="refreshStats()"></select>
      </div>
      
      <label style="text-align:center;">ä»Šæœˆã®ç›®æ¨™é”æˆç‡</label>
      <div class="pie-container">
        <svg class="pie-svg" viewBox="0 0 100 100">
          <circle class="pie-bg" cx="50" cy="50" r="40"></circle>
          <circle id="pieFill" class="pie-val" cx="50" cy="50" r="40" stroke-dasharray="0 251.2"></circle>
        </svg>
        <div id="pieLabel" class="pie-text">0%</div>
      </div>
      <p id="progressSub" style="font-size:0.75rem; color:var(--text-sub); text-align:center; margin-bottom:30px;"></p>

      <label>æ—¥åˆ¥å‹‰å¼·æ™‚é–“</label>
      <div class="chart-wrapper">
        <div id="yAxisDaily" class="y-axis"></div>
        <div id="dailyChart" class="bar-frame"></div>
      </div>

      <label style="margin-top:25px;">æœˆåˆ¥å‹‰å¼·æ™‚é–“ (å¹´æ¨ç§»)</label>
      <div class="chart-wrapper">
        <div id="yAxisMonthly" class="y-axis"></div>
        <div id="monthlyChart" class="bar-frame"></div>
      </div>
    </div>
  </div>

  <div id="view" class="content-section" style="display:none">
    <div class="card">
      <div style="display:flex; justify-content: space-between; margin-bottom:20px;">
        <div style="display:flex; gap:10px;">
          <select id="viewYear" onchange="loadList()"></select>
          <select id="viewMonth" onchange="loadList()"></select>
        </div>
        <button onclick="toggleViewMode()" id="viewModeBtn" class="btn" style="width:auto; padding:5px 15px; font-size:0.8rem;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
      </div>
      <div id="diaryList"></div>
      <div id="calendarView" class="cal-grid" style="display:none;"></div>
    </div>
    <div id="viewerCard" class="card" style="display:none; border:2px solid var(--primary); animation: fadeIn 0.4s;">
      <div id="viewMeta" style="font-size:0.85rem; color:var(--primary); margin-bottom:12px; font-weight:bold; letter-spacing:1px;"></div>
      <div id="viewBody" style="white-space:pre-wrap; margin-bottom:20px; line-height:1.8;"></div>
      <div id="viewImageContainer" style="display:none; margin-bottom:20px;"><img id="viewImage" style="width:100%; border-radius:16px;"></div>
      <div style="display:flex; gap:12px;">
        <button class="btn" style="background:#666; color:#fff; flex:1;" onclick="document.getElementById('viewerCard').style.display='none'">é–‰ã˜ã‚‹</button>
        <button class="btn" style="background:#cf6679; color:#fff; flex:1;" id="deleteBtn">å‰Šé™¤</button>
      </div>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal-overlay">
  <div class="modal-card">
    <h3 style="margin:0 0 20px; font-size:1.1rem; color:var(--primary); letter-spacing:2px;">SETTING</h3>
    <label>ä»Šæœˆã®ç›®æ¨™</label>
    <textarea id="goalTextPrompt" rows="2"></textarea>
    <button class="btn" id="goalLockBtnText" onclick="saveGeneralGoal()">ç›®æ¨™ã‚’ãƒ­ãƒƒã‚¯</button>
    <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
    <label>å­¦ç¿’ç›®æ¨™æ™‚é–“ (åˆ†)</label>
    <div id="goalReference" style="font-size:0.7rem; background:rgba(187,134,252,0.1); padding:12px; border-radius:12px; margin-bottom:12px;">
      <div id="lastWeekTotal">å…ˆé€±: èª­è¾¼ä¸­...</div>
      <div id="dailyGoalEst">1æ—¥ã‚ãŸã‚Šç›®å®‰: 0åˆ†</div>
    </div>
    <input type="number" id="goalTimeInput" oninput="calcDailyEst(this.value)">
    <button class="btn" id="goalLockBtn" onclick="saveGoal()">æ™‚é–“ã‚’ãƒ­ãƒƒã‚¯</button>
    <button class="btn" style="background:transparent; color:var(--text-sub); margin-top:10px;" onclick="closeSettings()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div id="monthlyReviewModal" class="modal-overlay">
  <div class="modal-card">
    <h3 style="margin:0 0 15px; color:var(--primary);">ä»Šæœˆã®ãµã‚Šã‹ãˆã‚Š</h3>
    <p id="reviewStats" style="font-size:0.85rem; margin-bottom:15px;"></p>
    <label>ä»Šæœˆã‚’ä¸€è¨€ã§ã„ã†ã¨ï¼Ÿ</label>
    <textarea id="monthlySummary" rows="3" placeholder="é ‘å¼µã£ãŸã“ã¨ã‚„æ¥æœˆã¸ã®æ„æ°—è¾¼ã¿"></textarea>
    <button class="btn" onclick="saveMonthlyReview()">ç·æ‹¬ã‚’ä¿å­˜ã—ã¦æ—¥è¨˜ã«æ›¸ã</button>
    <button class="btn" style="background:none; color:var(--text-sub);" onclick="document.getElementById('monthlyReviewModal').style.display='none'">å¾Œã§</button>
  </div>
</div>

<div id="customAlert" class="modal-overlay">
  <div class="modal-card" style="text-align:center;">
    <p id="alertMsg" style="font-weight:bold;"></p>
    <div id="alertBtns" style="display:flex; gap:10px; margin-top:20px; justify-content:center;"></div>
  </div>
</div>

<script>
/* --- 1. æ”¹è‰¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«èƒŒæ™¯ --- */
const canvas = document.getElementById('bg-canvas');
const ctx = canvas.getContext('2d');
let particles = [];
let mouse = { x: null, y: null, radius: 150 };

window.addEventListener('mousemove', e => { mouse.x = e.x; mouse.y = e.y; });
window.addEventListener('touchstart', e => { mouse.x = e.touches[0].clientX; mouse.y = e.touches[0].clientY; });

class Particle {
  constructor() { this.init(); }
  init() {
    this.x = Math.random() * canvas.width;
    this.y = Math.random() * canvas.height;
    this.size = Math.random() * 2 + 0.5;
    this.baseX = this.x; this.baseY = this.y;
    this.density = (Math.random() * 40) + 5;
    this.color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
  }
  draw() {
    ctx.fillStyle = this.color;
    ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
  }
  update() {
    let dx = mouse.x - this.x; let dy = mouse.y - this.y;
    let distance = Math.sqrt(dx*dx + dy*dy);
    if (distance < mouse.radius) {
      let force = (mouse.radius - distance) / mouse.radius;
      this.x -= (dx / distance) * force * this.density;
      this.y -= (dy / distance) * force * this.density;
    } else {
      this.x += (this.baseX - this.x) * 0.05;
      this.y += (this.baseY - this.y) * 0.05;
    }
  }
}
function initBg() {
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  particles = [];
  let count = (canvas.width * canvas.height) / 10000;
  for (let i = 0; i < count; i++) particles.push(new Particle());
}
function animateBg() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  particles.forEach(p => { p.update(); p.draw(); });
  requestAnimationFrame(animateBg);
}
window.addEventListener('resize', initBg);
initBg(); animateBg();

/* --- 2. å…¨æ©Ÿèƒ½ãƒ­ã‚¸ãƒƒã‚¯ (å‰å›ã®å®Œå…¨ç‰ˆ) --- */
let currentDataList = [];
let selectedImageData = null;
let viewMode = 'list';
let hasPromptedMonthlyReview = false;
let hasPromptedGoal = false;

function showTab(t) {
  const currentGoal = localStorage.getItem(`goal_text_${new Date().getFullYear()}_${new Date().getMonth() + 1}`);
  if (!currentGoal && !hasPromptedGoal && t !== 'edit') {
    hasPromptedGoal = true;
    showAlert("ä»Šæœˆã®ç›®æ¨™ãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šã—ã¾ã™ã‹ï¼Ÿ", "confirm", openSettings);
    return;
  }
  const now = new Date();
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  if (now.getDate() >= lastDay - 2 && !hasPromptedMonthlyReview && t !== 'edit') {
    hasPromptedMonthlyReview = true;
    showAlert("æœˆæœ«ã«ãªã‚Šã¾ã—ãŸã€‚ä»Šæœˆã®ç·æ‹¬ã‚’è¨˜å…¥ã—ã¾ã›ã‚“ã‹ï¼Ÿ", "confirm", openMonthlyReview);
    return;
  }
  document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  document.getElementById(t).style.display = 'block';
  document.getElementById('tab-' + t).classList.add('active');
  if(t === 'stats') refreshStats();
  if(t === 'view') loadList();
}

function toggleLoader(show, text = "SYNCING...") {
  const loader = document.getElementById("globalLoader");
  document.getElementById("loaderText").textContent = text;
  loader.style.display = show ? "flex" : "none";
}

function toggleTheme() {
  const b = document.body;
  b.setAttribute("data-theme", b.getAttribute("data-theme") === "dark" ? "light" : "dark");
  particles.forEach(p => p.init());
}

function refreshStats() {
  const y = document.getElementById("statYear").value;
  const m = document.getElementById("statMonth").value;
  toggleLoader(true, "ANALYZING...");
  google.script.run.withSuccessHandler(res => {
    toggleLoader(false);
    if(!res) return;
    const goal = localStorage.getItem(`goal_${y}_${m}`) || 0;
    const total = res.daily.reduce((a, b) => a + (b.time || 0), 0);
    const percent = goal > 0 ? Math.min(Math.round((total / goal) * 100), 100) : 0;
    document.getElementById("pieFill").setAttribute("stroke-dasharray", `${(percent / 100) * 251.2} 251.2`);
    document.getElementById("pieLabel").textContent = `${percent}%`;
    document.getElementById("progressSub").textContent = goal > 0 ? `åˆè¨ˆ: ${total}åˆ† / ç›®æ¨™: ${goal}åˆ†` : "ç›®æ¨™æœªè¨­å®š";
    drawChart("dailyChart", "yAxisDaily", res.daily.map(d => ({ label: d.day, val: d.time })), 5);
    drawChart("monthlyChart", "yAxisMonthly", res.monthly.map(m => ({ label: m.month, val: m.time })), 1);
  }).getDetailedStudyStats(y, m);
}

function drawChart(chartId, axisId, data, step) {
  const frame = document.getElementById(chartId);
  const axis = document.getElementById(axisId);
  frame.innerHTML = ""; axis.innerHTML = "";
  const vals = data.map(d => d.val || 0);
  const max = Math.max(...vals, 60);
  for(let i=4; i>=0; i--) {
    const d = document.createElement("div"); d.textContent = Math.round(max * (i/4)); axis.appendChild(d);
  }
  data.forEach((d, i) => {
    const bar = document.createElement("div");
    bar.className = "bar"; bar.style.height = `${(d.val / max) * 100}%`;
    bar.onmouseenter = (e) => showTooltip(e, `${d.label}: ${d.val}åˆ†`);
    bar.onmouseleave = hideTooltip;
    if ((i + 1) % step === 0 || i === 0 || i === data.length - 1) {
      const t = document.createElement("div"); t.className = "bar-tick"; t.textContent = d.label; bar.appendChild(t);
    }
    frame.appendChild(bar);
  });
}

function checkOverwrite() {
  const addVal = parseInt(document.getElementById("addStudyTime").value) || 0;
  if(addVal > 0) {
    const current = parseInt(document.getElementById("studyTime").value) || 0;
    document.getElementById("studyTime").value = current + addVal;
  }
  executeSave();
}

function executeSave() {
  toggleLoader(true, "SAVING...");
  const date = document.getElementById("date").value;
  google.script.run.withSuccessHandler(() => { 
    toggleLoader(false); 
    document.getElementById("addStudyTime").value = 0;
    showAlert("è¨˜éŒ²ã—ã¾ã—ãŸ", 'info'); 
    calculateStreak(); 
  }).saveDiary(date, document.getElementById("diary").value, document.getElementById("emotion").value, document.getElementById("studyTime").value, selectedImageData);
}

function showRandomMemory() {
  google.script.run.withSuccessHandler(data => {
    if(!data || data.length < 1) return;
    const past = data.filter(d => d.name < document.getElementById("date").value);
    if(past.length === 0) return;
    const item = past[Math.floor(Math.random() * past.length)];
    const box = document.getElementById("memoryBox");
    box.innerHTML = `<small>âœ§ Past Memory (${item.name})</small>${item.preview}...`;
    box.style.display = "block";
    box.scrollIntoView({behavior: "smooth"});
  }).getDiaryList(null, null);
}

function openMonthlyReview() {
  const y = new Date().getFullYear(); const m = new Date().getMonth() + 1;
  google.script.run.withSuccessHandler(res => {
    if(!res) return;
    const total = res.daily.reduce((a, b) => a + (b.time || 0), 0);
    document.getElementById("reviewStats").textContent = `${m}æœˆã®å­¦ç¿’åˆè¨ˆã¯ ${total} åˆ†ã§ã—ãŸã€‚`;
    document.getElementById("monthlyReviewModal").style.display = "flex";
  }).getDetailedStudyStats(y, m);
}

function saveMonthlyReview() {
  const summary = document.getElementById("monthlySummary").value;
  if(!summary) return;
  document.getElementById("diary").value = `ã€ä»Šæœˆã®ç·æ‹¬ã€‘\n${summary}\n\n---\n${document.getElementById("diary").value}`;
  document.getElementById("monthlyReviewModal").style.display = "none";
  showTab('edit');
  showAlert("æ—¥è¨˜æ¬„ã«ç·æ‹¬ã‚’æŒ¿å…¥ã—ã¾ã—ãŸã€‚", "info");
}

function openSettings() {
  fetchLastWeekStats();
  const now = new Date(); const y = now.getFullYear(); const m = now.getMonth() + 1;
  const savedTime = localStorage.getItem(`goal_${y}_${m}`);
  const inputTime = document.getElementById("goalTimeInput");
  const btnTime = document.getElementById("goalLockBtn");
  if (savedTime) { inputTime.value = savedTime; inputTime.classList.add("locked"); btnTime.classList.add("locked"); btnTime.textContent = "ãƒ­ãƒƒã‚¯æ¸ˆ"; }
  else { inputTime.value = ""; inputTime.classList.remove("locked"); btnTime.classList.remove("locked"); btnTime.textContent = "æ™‚é–“ã‚’ãƒ­ãƒƒã‚¯"; }
  
  const savedText = localStorage.getItem(`goal_text_${y}_${m}`);
  const inputText = document.getElementById("goalTextPrompt");
  const btnText = document.getElementById("goalLockBtnText");
  if (savedText) { inputText.value = savedText; inputText.classList.add("locked"); btnText.classList.add("locked"); btnText.textContent = "ãƒ­ãƒƒã‚¯æ¸ˆ"; }
  else { inputText.value = ""; inputText.classList.remove("locked"); btnText.classList.remove("locked"); btnText.textContent = "ç›®æ¨™ã‚’ãƒ­ãƒƒã‚¯"; }
  document.getElementById("settingsModal").style.display = "flex";
}

function closeSettings() { document.getElementById("settingsModal").style.display = "none"; }
function saveGoal() {
  localStorage.setItem(`goal_${new Date().getFullYear()}_${new Date().getMonth() + 1}`, document.getElementById("goalTimeInput").value);
  closeSettings(); refreshStats();
}
function saveGeneralGoal() {
  localStorage.setItem(`goal_text_${new Date().getFullYear()}_${new Date().getMonth() + 1}`, document.getElementById("goalTextPrompt").value);
  updateGoalDisplay(); closeSettings();
}
function updateGoalDisplay() {
  const saved = localStorage.getItem(`goal_text_${new Date().getFullYear()}_${new Date().getMonth() + 1}`);
  document.getElementById("goalText").textContent = saved || "æœªè¨­å®š (âš™ï¸ã‚ˆã‚Šè¨­å®š)";
}
function calcDailyEst(val) {
  const days = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
  document.getElementById("dailyGoalEst").textContent = `1æ—¥ã‚ãŸã‚Šç›®å®‰: ${val ? Math.round(val / days) : 0}åˆ†`;
}
function fetchLastWeekStats() {
  google.script.run.withSuccessHandler(res => {
    if(!res) return;
    const total = res.daily.slice(-7).reduce((a, b) => a + (b.time || 0), 0);
    document.getElementById("lastWeekTotal").textContent = `å…ˆé€±: ${total}åˆ†`;
  }).getDetailedStudyStats(new Date().getFullYear(), new Date().getMonth() + 1);
}

function handleImage(input) {
  if (input.files && input.files[0]) {
    toggleLoader(true, "PROCESSING...");
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvasImg = document.createElement('canvas');
        const MAX = 800; let w = img.width, h = img.height;
        if(w > MAX) { h *= MAX/w; w = MAX; }
        canvasImg.width = w; canvasImg.height = h;
        canvasImg.getContext('2d').drawImage(img, 0, 0, w, h);
        selectedImageData = canvasImg.toDataURL('image/jpeg', 0.7);
        document.getElementById("imagePreview").src = selectedImageData;
        document.getElementById("imagePreviewContainer").style.display = "block";
        toggleLoader(false);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
  }
}

function autoLoadEntry() {
  const dateStr = document.getElementById("date").value;
  if (!dateStr) return;
  toggleLoader(true, "LOADING...");
  google.script.run.withSuccessHandler(json => {
    toggleLoader(false);
    if (json) {
      document.getElementById("emotion").value = json.emotion || "æ™®é€š";
      document.getElementById("studyTime").value = json.studyTime || 0;
      document.getElementById("diary").value = json.content || "";
      if (json.image) {
        selectedImageData = json.image; document.getElementById("imagePreview").src = json.image;
        document.getElementById("imagePreviewContainer").style.display = "block";
      } else { selectedImageData=null; document.getElementById("imagePreviewContainer").style.display = "none"; }
    } else {
      document.getElementById("diary").value = ""; document.getElementById("studyTime").value = 0;
      selectedImageData=null; document.getElementById("imagePreviewContainer").style.display = "none";
    }
  }).getDiaryContent(new Date(dateStr).getFullYear(), new Date(dateStr).getMonth() + 1, dateStr);
}

function calculateStreak() {
  google.script.run.withSuccessHandler(data => {
    if(!data || data.length === 0) { document.getElementById("streakCount").textContent = "0"; return; }
    const sorted = data.map(d => d.name).sort().reverse();
    const today = new Date(); today.setHours(0,0,0,0);
    let count = 0;
    let last = new Date(sorted[0]); last.setHours(0,0,0,0);
    if ((today - last) / 86400000 > 1) { document.getElementById("streakCount").textContent = "0"; return; }
    for(let i=0; i<sorted.length; i++){
      const d = new Date(sorted[i]); d.setHours(0,0,0,0);
      if(i===0) count=1; else {
        const prev = new Date(sorted[i-1]); prev.setHours(0,0,0,0);
        if((prev - d)/86400000 === 1) count++; else break;
      }
    }
    document.getElementById("streakCount").textContent = count.toString();
  }).getDiaryList(new Date().getFullYear(), new Date().getMonth()+1);
}

function loadList() {
  const y = document.getElementById("viewYear").value;
  const m = document.getElementById("viewMonth").value;
  toggleLoader(true, "FETCHING...");
  google.script.run.withSuccessHandler(data => {
    currentDataList = data || [];
    if (viewMode === 'list') renderList(currentDataList); else renderCalendar(currentDataList, y, m);
    toggleLoader(false);
  }).getDiaryList(y, m);
}
function renderList(data) {
  const list = document.getElementById("diaryList");
  list.style.display = "block"; document.getElementById("calendarView").style.display = "none";
  list.innerHTML = data.length ? "" : "<div style='text-align:center;padding:40px;opacity:0.3;'>No Records</div>";
  data.forEach(d => {
    const div = document.createElement("div"); 
    div.style = "background:var(--surface); padding:15px; border-radius:15px; margin-bottom:12px; border-left:4px solid var(--primary); cursor:pointer;";
    div.innerHTML = `<strong>${d.name?.toString() || ''}</strong> <span style="font-size:0.75rem; opacity:0.6;">${d.emotion?.toString() || ''}</span><br><small style="opacity:0.7;">${d.preview?.toString() || ''}...</small>`;
    div.onclick = () => openViewer(d.name);
    list.appendChild(div);
  });
}
function renderCalendar(data, year, month) {
  const cal = document.getElementById("calendarView");
  cal.style.display = "grid"; document.getElementById("diaryList").style.display = "none";
  cal.innerHTML = "";
  const days = new Date(year, month, 0).getDate();
  for(let d=1; d<=days; d++){
    const ds = `${year}-${month.toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
    const item = data.find(x => x.name === ds);
    const div = document.createElement("div");
    div.className = "cal-day" + (item ? " has-data" : "");
    div.textContent = d;
    if(item) div.onclick = () => openViewer(ds);
    cal.appendChild(div);
  }
}
function toggleViewMode() {
  viewMode = viewMode === 'list' ? 'calendar' : 'list';
  document.getElementById("viewModeBtn").textContent = viewMode === 'list' ? 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼' : 'ãƒªã‚¹ãƒˆ';
  loadList();
}

function openViewer(name) {
  toggleLoader(true, "READING...");
  const y = document.getElementById("viewYear").value;
  const m = document.getElementById("viewMonth").value;
  google.script.run.withSuccessHandler(json => {
    toggleLoader(false);
    if(!json) return;
    document.getElementById("viewerCard").style.display = "block";
    document.getElementById("viewMeta").textContent = `${json.date} / ${json.emotion} / ${json.studyTime}min`;
    document.getElementById("viewBody").textContent = json.content;
    const imgBox = document.getElementById("viewImageContainer");
    if(json.image) { imgBox.style.display="block"; document.getElementById("viewImage").src=json.image; } else imgBox.style.display="none";
    document.getElementById("deleteBtn").onclick = () => showAlert("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", "danger", () => {
      toggleLoader(true, "DELETING...");
      google.script.run.withSuccessHandler(() => { toggleLoader(false); document.getElementById("viewerCard").style.display="none"; loadList(); }).deleteDiary(y, m, name);
    });
    window.scrollTo({top: document.getElementById("viewerCard").offsetTop - 20, behavior: 'smooth'});
  }).getDiaryContent(y, m, name);
}

function showTooltip(e, text) {
  const tt = document.getElementById("chartTooltip");
  tt.textContent = text; tt.style.opacity = 1;
  tt.style.left = (e.clientX + 10) + "px"; tt.style.top = (e.clientY - 30) + "px";
}
function hideTooltip() { document.getElementById("chartTooltip").style.opacity = 0; }

function showAlert(msg, type, onConfirm) {
  const modal = document.getElementById("customAlert"); const btns = document.getElementById("alertBtns");
  document.getElementById("alertMsg").textContent = msg; btns.innerHTML = "";
  if (type === 'info') {
    const b = document.createElement("button"); b.className="btn"; b.style.width="100px"; b.textContent="OK"; b.onclick=()=>modal.style.display="none";
    btns.appendChild(b);
  } else {
    const b1 = document.createElement("button"); b1.className="btn"; b1.style.background="#888"; b1.textContent="ã‚­ãƒ£ãƒ³ã‚»ãƒ«"; b1.onclick=()=>modal.style.display="none";
    const b2 = document.createElement("button"); b2.className="btn"; b2.style.background = (type === 'danger' ? '#cf6679' : 'var(--primary)'); b2.textContent = "å®Ÿè¡Œ"; b2.onclick=()=>{ modal.style.display="none"; if(onConfirm) onConfirm(); };
    btns.appendChild(b1); btns.appendChild(b2);
  }
  modal.style.display = "flex";
}

window.onload = () => {
  const now = new Date();
  document.getElementById("date").valueAsDate = now;
  const sy = document.getElementById("statYear"); const sm = document.getElementById("statMonth");
  const vy = document.getElementById("viewYear"); const vm = document.getElementById("viewMonth");
  for(let i=now.getFullYear(); i>=now.getFullYear()-2; i--){ sy.add(new Option(i,i)); vy.add(new Option(i,i)); }
  for(let i=1; i<=12; i++){ sm.add(new Option(i,i)); vm.add(new Option(i,i)); }
  sm.value = vm.value = now.getMonth() + 1;
  updateGoalDisplay(); calculateStreak(); autoLoadEntry();
};
</script>
</body>
</html>
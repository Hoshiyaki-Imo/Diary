<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    :root { --primary: #bb86fc; --bg: #f5f5f5; --surface: #ffffff; --on-surface: #333; --border: #eee; }
    [data-theme="dark"] { --primary: #cfa6ff; --bg: #121212; --surface: #1e1e1e; --on-surface: #e1e1e1; --border: #333; }
    
    html { font-size: 16px; } 
    @media (max-width: 480px) { html { font-size: 17px; } } /* ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºå¾®èª¿æ•´ */

    body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--on-surface); transition: 0.3s; line-height: 1.4; }
    .container { max-width: 500px; margin: 0 auto; padding-bottom: 40px; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--surface); }
    .tab-bar { display: flex; background: var(--surface); border-bottom: 1px solid var(--border); }
    .tab { flex: 1; text-align: center; padding: 12px 5px; cursor: pointer; font-size: 0.85rem; color: #888; font-weight: bold; }
    .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
    .card { background: var(--surface); padding: 15px; border-radius: 15px; margin: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    label { display: block; font-size: 0.75rem; font-weight: bold; margin-bottom: 4px; color: var(--primary); }
    input, select, textarea, button { width: 100%; padding: 10px; font-size: 0.95rem; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--on-surface); box-sizing: border-box; margin-bottom: 12px; }
    .btn { background: var(--primary); color: #000; font-weight: bold; border: none; cursor: pointer; }
    .chart-container { position: relative; height: 160px; border-bottom: 1px solid var(--border); display: flex; align-items: flex-end; margin: 30px 0 20px; overflow: hidden; }
    .bar { flex: 1; background: var(--primary); margin: 0 1px; position: relative; min-height: 1px; }
    .bar-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 9px; color: #888; }
    .avg-line { position: absolute; left: 0; right: 0; border-top: 1px dashed #ff4081; z-index: 10; transition: 0.5s; }
    .avg-label { position: absolute; right: 0; top: -14px; color: #ff4081; font-size: 0.6rem; font-weight: bold; }
    .content-section { display: none; }
    .content-section.active { display: block; }
    .diary-item { background: var(--surface); padding: 10px; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid var(--primary); font-size: 0.9rem; cursor: pointer; }
  </style>
</head>
<body data-theme="dark">
<div class="container">
  <div class="header"><h1 style="margin:0; font-size: 1.1rem;">Diary</h1><button onclick="toggleTheme()" style="width:40px; border-radius:50%;">ğŸŒ“</button></div>
  <div class="tab-bar">
    <div class="tab active" onclick="showTab('edit')">è¨˜éŒ²</div>
    <div class="tab" onclick="showTab('stats')">åˆ†æ</div>
    <div class="tab" onclick="showTab('view')">å±¥æ­´</div>
  </div>
  <div id="edit" class="content-section active">
    <div class="card">
      <label>æ—¥ä»˜</label><input type="date" id="date">
      <div style="display:flex; gap:8px;">
        <div style="flex:1"><label>æ°—åˆ†</label><select id="emotion"><option>æ™®é€š</option><option>ç–²ã‚ŒãŸ</option><option>æ€’ã£ã¦ã‚‹</option><option>æ‚²ã—ã„</option><option>ã‚‚ã‚„ã‚‚ã‚„</option></select></div>
        <div style="flex:1"><label>å‹‰å¼·(åˆ†)</label><input type="number" id="studyTime" value="0"></div>
      </div>
      <label>å†…å®¹</label><textarea id="diary" rows="3"></textarea>
      <button class="btn" onclick="save()" id="saveBtn">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
  <div id="stats" class="content-section">
    <div class="card">
      <div style="display:flex; gap:5px; margin-bottom:10px;">
        <select id="statYear" onchange="refreshStats()" style="flex:1"></select>
        <select id="statMonth" onchange="refreshStats()" style="flex:1"></select>
        <select id="statMode" onchange="refreshStats()" style="flex:1"><option value="daily">æ—¥åˆ¥</option><option value="monthly">æœˆåˆ¥</option></select>
      </div>
      <div id="chartTitle" style="font-size: 0.8rem; font-weight:bold; text-align:center;"></div>
      <div class="chart-container" id="chartFrame"><div id="avgLine" class="avg-line"><span class="avg-label" id="avgLabel"></span></div></div>
      <div id="statsSummary" style="font-size:0.75rem; text-align:center; color:var(--primary);"></div>
    </div>
  </div>
  <div id="view" class="content-section">
    <div class="card">
      <div style="display:flex; gap:5px; margin-bottom:10px;">
        <select id="viewYear" onchange="loadList()" style="flex:1"></select>
        <select id="viewMonth" onchange="loadList()" style="flex:1"></select>
      </div>
      <div id="diaryList"></div>
    </div>
    <div id="viewerCard" class="card" style="display:none; border:1px solid var(--primary);">
      <div id="viewDate" style="font-weight:bold; color:var(--primary); margin-bottom:10px;"></div>
      <div id="viewBody" style="white-space:pre-wrap; font-size:0.85rem;"></div>
      <button class="btn" style="background:#888; margin-top:10px;" onclick="document.getElementById('viewerCard').style.display='none'">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<script>
function toggleTheme() { const b = document.body; b.setAttribute("data-theme", b.getAttribute("data-theme") === "dark" ? "light" : "dark"); }
function showTab(t) {
  document.querySelectorAll('.tab, .content-section').forEach(el => el.classList.remove('active'));
  document.querySelector(`.tab[onclick*="${t}"]`).classList.add('active');
  document.getElementById(t).classList.add('active');
  if(t === 'stats') refreshStats();
  if(t === 'view') loadList();
}
window.onload = () => {
  const now = new Date();
  document.getElementById("date").valueAsDate = now;
  const ys = [document.getElementById("statYear"), document.getElementById("viewYear")];
  const ms = [document.getElementById("statMonth"), document.getElementById("viewMonth")];
  ys.forEach(s => { for(let y=2024; y<=now.getFullYear(); y++) s.add(new Option(y+"å¹´", y)); s.value = now.getFullYear(); });
  ms.forEach(s => { for(let m=1; m<=12; m++) s.add(new Option(m+"æœˆ", m)); s.value = now.getMonth()+1; });
  refreshStats();
};
function save() {
  const btn = document.getElementById("saveBtn"); btn.disabled = true; btn.textContent = "ä¿å­˜ä¸­...";
  google.script.run.withSuccessHandler(() => { alert("ä¿å­˜ã—ã¾ã—ãŸï¼"); btn.disabled = false; btn.textContent = "ä¿å­˜ã™ã‚‹"; refreshStats(); })
    .saveDiary(document.getElementById("date").value, document.getElementById("diary").value, document.getElementById("emotion").value, document.getElementById("studyTime").value);
}
function refreshStats() {
  const y = document.getElementById("statYear").value, m = document.getElementById("statMonth").value, mode = document.getElementById("statMode").value;
  google.script.run.withSuccessHandler(res => {
    const frame = document.getElementById("chartFrame");
    const data = mode === 'daily' ? res.daily : res.monthly;
    frame.querySelectorAll('.bar').forEach(b => b.remove());
    const max = Math.max(...data.map(d => d.time), 60);
    const sum = data.reduce((a, b) => a + b.time, 0);
    const avg = mode === 'daily' ? Math.round(sum / data.filter(d=>d.recorded).length || 0) : Math.round(sum/12);
    data.forEach(d => {
      const bar = document.createElement("div"); bar.className = "bar"; bar.style.height = (d.time / max * 100) + "%";
      if(mode === 'daily' && !d.recorded) bar.style.opacity = "0.1";
      const lbl = document.createElement("span"); lbl.className = "bar-label";
      const val = mode === 'daily' ? d.day : d.month;
      if(mode === 'monthly' || val === 1 || val % 5 === 0) lbl.textContent = mode === 'daily' ? val : val + "æœˆ";
      bar.appendChild(lbl); frame.appendChild(bar);
    });
    document.getElementById("avgLine").style.bottom = (avg / max * 100) + "%";
    document.getElementById("avgLabel").textContent = "å¹³å‡:" + avg;
    document.getElementById("chartTitle").textContent = mode === 'daily' ? res.targetLabel : y + "å¹´ æœˆåˆ¥";
    document.getElementById("statsSummary").textContent = `åˆè¨ˆ: ${sum}åˆ† / å¹³å‡: ${avg}åˆ†`;
  }).getDetailedStudyStats(y, m);
}
function loadList() {
  const y = document.getElementById("viewYear").value, m = document.getElementById("viewMonth").value;
  google.script.run.withSuccessHandler(data => {
    const list = document.getElementById("diaryList");
    list.innerHTML = data.length ? "" : "<div style='text-align:center;padding:20px;'>ãªã—</div>";
    data.forEach(d => {
      const div = document.createElement("div"); div.className = "diary-item";
      div.innerHTML = `<strong>${d.name} [${d.emotion}]</strong><br>${d.preview}...`;
      div.onclick = () => {
        google.script.run.withSuccessHandler(txt => {
          document.getElementById("viewerCard").style.display = "block";
          document.getElementById("viewDate").textContent = d.name;
          document.getElementById("viewBody").textContent = txt;
        }).getDiaryContent(y, m, d.name);
      };
      list.appendChild(div);
    });
  }).getDiaryList(y, m);
}
</script>
</body>
</html>